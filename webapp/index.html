<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Los Santos Shop v2.9</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        @font-face {
            font-family: 'Pricedown';
            src: url('https://db.onlinewebfonts.com/t/5799b47862f27227c47c4827594d4068.woff2') format('woff2');
        }
        
        :root {
            --gta-green: #3fa535;
            --gta-gold: #cfa936;
            --gta-black: #000000;
            --gta-grey: #a0a0a0;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--gta-black);
            color: #fff;
            font-family: 'Pricedown', sans-serif;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
            user-select: none;
        }

        /* Background */
        .bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            /* Reliable Wikimedia Image */
            background-image: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.8)), url('https://upload.wikimedia.org/wikipedia/commons/thumb/3/3e/Los_Angeles_from_Griffith_Observatory.jpg/1280px-Los_Angeles_from_Griffith_Observatory.jpg');
            background-size: cover;
            background-position: center;
            z-index: -2;
        }

        /* Scanline Effect */
        .scanlines {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.2) 50%, rgba(0,0,0,0.2));
            background-size: 100% 4px;
            z-index: 100;
            pointer-events: none;
            opacity: 0.3;
        }

        /* Header */
        .header {
            padding: 15px;
            background: rgba(0, 0, 0, 0.8);
            border-bottom: 2px solid var(--gta-gold);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }

        .logo {
            font-size: 32px;
            color: var(--gta-gold);
            text-shadow: 2px 2px 0 #000;
        }

        .money {
            color: var(--gta-green);
            font-size: 28px;
            text-shadow: 1px 1px 0 #000;
        }

        /* Wanted Level */
        .wanted-stars {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }
        
        .star {
            font-size: 20px;
            color: #333; /* Inactive */
        }
        
        .star.active {
            color: #fff;
            text-shadow: 0 0 5px #fff;
        }
        
        .star.flashing {
            animation: starFlash 0.5s infinite alternate;
        }
        
        @keyframes starFlash {
            from { color: #fff; opacity: 1; }
            to { color: #cfa936; opacity: 0.8; }
        }

        /* Navigation */
        .nav {
            display: flex;
            justify-content: space-around;
            background: rgba(0, 0, 0, 0.9);
            padding: 10px 0;
            border-top: 2px solid var(--gta-grey);
            z-index: 10;
        }

        .nav-item {
            font-size: 24px;
            color: var(--gta-grey);
            cursor: pointer;
            transition: 0.2s;
        }

        .nav-item.active {
            color: var(--gta-gold);
            transform: scale(1.1);
            text-shadow: 0 0 5px var(--gta-gold);
        }

        /* Content Area */
        .content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        /* Sections */
        .section {
            display: none;
            animation: fadeIn 0.3s ease-in;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Product Grid */
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
        }

        .product-card {
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid var(--gta-grey);
            border-radius: 0;
            padding: 10px;
            text-align: center;
            transition: 0.2s;
            position: relative;
            overflow: hidden;
        }

        .product-card:hover {
            border-color: var(--gta-green);
            transform: scale(1.02);
            box-shadow: 0 0 15px rgba(63, 165, 53, 0.3);
        }

        .product-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: var(--gta-gold);
        }

        .product-emoji {
            font-size: 40px;
            margin: 10px 0;
            cursor: pointer;
        }

        .product-name {
            font-family: 'Impact', sans-serif;
            font-size: 18px;
            margin: 5px 0;
            color: #fff;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .product-details {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #ccc;
            margin-bottom: 10px;
        }

        .product-price {
            font-size: 24px;
            color: var(--gta-green);
            margin: 10px 0;
            text-shadow: 1px 1px 0 #000;
        }

        .btn-buy {
            background: var(--gta-green);
            color: #000;
            border: none;
            padding: 5px 15px;
            font-family: 'Pricedown', sans-serif;
            font-size: 20px;
            cursor: pointer;
            width: 100%;
            transition: 0.2s;
        }

        .btn-buy:active {
            transform: scale(0.95);
            background: #fff;
        }

        /* Radio */
        .radio-widget {
            position: fixed;
            top: 80px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            border: 2px solid var(--gta-grey);
            padding: 5px 10px;
            z-index: 99;
            text-align: right;
            transition: 0.3s;
            transform: translateX(90%); /* Hidden by default */
            cursor: pointer;
        }
        
        .radio-widget:hover, .radio-widget.active {
            transform: translateX(0);
        }
        
        .radio-text {
            font-size: 14px;
            color: var(--gta-gold);
            white-space: nowrap;
        }

        /* Search Bar (LSPD) */
        .search-container {
            margin-bottom: 15px;
            border: 2px solid #fff;
            background: #000;
            padding: 5px;
            display: flex;
            align-items: center;
        }
        
        .search-input {
            background: transparent;
            border: none;
            color: var(--gta-green);
            font-family: 'Courier New', monospace;
            font-size: 16px;
            width: 100%;
            outline: none;
            text-transform: uppercase;
        }
        
        .search-label {
            color: #fff;
            font-family: 'Courier New', monospace;
            margin-right: 10px;
            font-weight: bold;
        }

        /* --- GTA SA "WORLD MAP" THEME (Colorful) --- */
        #map.section {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 200;
            background: #6fa8dc; /* GTA Water Blue */
            padding: 0;
            overflow: hidden;
        }

        .map-viewport {
            width: 100%;
            height: 100%;
            overflow: hidden;
            touch-action: none;
            position: relative;
            /* Water Texture */
            background-image: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(255,255,255,0.05) 10px, rgba(255,255,255,0.05) 20px);
        }

        .map-transform-layer {
            width: 1024px; /* Base SVG size */
            height: 1024px;
            transform-origin: 0 0;
            will-change: transform;
            position: absolute;
            top: 0;
            left: 0;
        }

        /* HUD */
        .map-hud-top {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 60px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            box-sizing: border-box;
            pointer-events: none;
            z-index: 10;
        }
        
        .map-title {
            font-size: 32px;
            color: var(--gta-gold);
            text-shadow: 2px 2px 0 #000;
        }
        
        .btn-close-map {
            font-size: 24px;
            color: #fff;
            pointer-events: auto;
            cursor: pointer;
            background: rgba(0,0,0,0.5);
            padding: 5px 10px;
            border: 1px solid #fff;
        }


        /* Bottom Sheet */
        .bottom-sheet {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(0,0,0,0.95);
            border-top: 4px solid var(--gta-gold);
            padding: 20px;
            box-sizing: border-box;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            z-index: 300;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: auto;
        }
        
        .bottom-sheet.active {
            transform: translateY(0);
        }
        
        .bs-title {
            font-size: 36px;
            color: var(--gta-gold);
        }
        
        .bs-info {
            font-family: 'Courier New', monospace;
            color: #ccc;
            font-size: 14px;
        }

        /* SVG Styles */
        .map-img-interactive g {
            filter: drop-shadow(0 5px 10px rgba(0,0,0,0.8));
        }

        /* Updated Blips (Bigger for Touch) */
        .district-marker {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: transparent;
            border: none;
            color: #e0e0e0;
            font-family: Arial, Helvetica, sans-serif;
            font-weight: 900;
            text-shadow: 2px 2px 0 #000, -1px -1px 0 #000;
            font-size: 14px;
            letter-spacing: 1px;
            text-transform: uppercase;
            pointer-events: none;
            transform: translate(-50%, -50%);
            position: absolute;
            transition: 0.2s;
        }
        
        .blip-icon {
            width: 32px;
            height: 32px;
            background-color: #f0c330;
            border: 3px solid #000;
            margin-bottom: 5px;
            box-shadow: 0 0 10px rgba(240, 195, 48, 0.8);
            transition: transform 0.2s;
            cursor: pointer;
            pointer-events: auto;
        }

        .blip-icon:active {
            transform: scale(1.2);
            background-color: #fff;
        }
        
        .zone-poly {
            position: absolute;
            border: 2px solid var(--gta-green);
            background: rgba(63, 165, 53, 0.2);
            display: none;
            pointer-events: none;
        }

        /* Map & Stats */
        .placeholder-box {
            background: rgba(0,0,0,0.6);
            padding: 20px;
            border: 2px solid var(--gta-gold);
            text-align: center;
            margin-top: 20px;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            margin: 10px 0;
            border-bottom: 1px solid #333;
            padding-bottom: 5px;
        }
        
        /* Filters */
        .filters {
            display: flex;
            overflow-x: auto;
            gap: 10px;
            padding-bottom: 10px;
            margin-bottom: 15px;
            scrollbar-width: none;
        }
        
        .filter-btn {
            background: rgba(0,0,0,0.8);
            border: 1px solid var(--gta-grey);
            color: #fff;
            padding: 5px 15px;
            font-family: 'Impact', sans-serif;
            font-size: 14px;
            white-space: nowrap;
            cursor: pointer;
        }
        
        .filter-btn.active {
            background: var(--gta-gold);
            color: #000;
            border-color: var(--gta-gold);
        }
        
        .loading {
            text-align: center;
            font-size: 36px;
            color: var(--gta-gold);
            margin-top: 50px;
            animation: blink 1s infinite;
        }
        
        @keyframes blink { 50% { opacity: 0.5; } }

    </style>
</head>
<body>
    <!-- Audio Elements -->
    <div class="radio-widget" onclick="toggleRadio()">
        <div class="radio-text">ðŸ“» RADIO OFF</div>
    </div>

    <div class="bg"></div>
    <div class="scanlines"></div>

    <!-- Header with Stars -->
    <div class="header">
        <div>
            <div class="logo">LOS SANTOS</div>
            <div class="wanted-stars" id="stars">
                <span class="star">â˜…</span><span class="star">â˜…</span><span class="star">â˜…</span><span class="star">â˜…</span><span class="star">â˜…</span>
            </div>
        </div>
        <div class="money" id="money">$00000000</div>
    </div>

    <!-- Mission Passed Overlay -->
    <div class="mission-passed-overlay" id="mp-overlay">
        <div class="mp-text">MISSION PASSED!</div>
        <div class="mp-sub">RESPECT +</div>
    </div>

        <!-- Welcome Overlay -->
    <div id="welcome-overlay" class="mission-passed-overlay">
        <div id="welcome-text" class="mp-text" style="color: #fff; -webkit-text-stroke: 2px #000;">WELCOME</div>
    </div>

    <div class="content">
        <!-- SHOP SECTION -->
        <div id="shop" class="section active">
            <!-- LSPD Search -->
            <div class="search-container">
                <span class="search-label">LSPD DATABASE > SEARCH:</span>
                <input type="text" class="search-input" placeholder="ENTER ITEM NAME..." oninput="filterSearch(this.value)">
            </div>

            <div class="filters" id="city-filters">
                <button class="filter-btn active" onclick="filterProducts('all')">ALL ZONES</button>
            </div>
            <div class="product-grid" id="product-grid">
                <div class="loading">LOADING STOCK...</div>
            </div>
        </div>

        <!-- MAP SECTION -->
                <!-- MAP SECTION (FULLSCREEN MOBILE) -->
        <div id="map" class="section">
        <!-- Map Controls -->
        <div id="map-back-btn" onclick="mapReset()" style="
            position: absolute; 
            bottom: 80px; 
            right: 20px; 
            background: #000; 
            color: #fff; 
            border: 2px solid var(--gta-green); 
            padding: 10px 20px; 
            font-family: 'Pricedown', sans-serif; 
            font-size: 24px; 
            display: none; 
            z-index: 1000;
            box-shadow: 0 0 10px var(--gta-green);
        ">
            BACK
        </div>

            <div class="map-viewport" id="map-viewport">
                <div class="map-transform-layer" id="map-layer">
                                        <!-- GTA SA COLORFUL MAP LAYERS -->
                                        <!-- GTA SA WORLD MAP (HARDCODED COLORS) -->
                                        <!-- GTA SA HIGH FIDELITY MAP -->
                                        <!-- GTA SA MAP FINAL FIX -->
                    <svg id="map-img" class="map-img-interactive" viewBox="0 0 1024 1024" preserveAspectRatio="xMidYMid meet" style="width:100%; height:100%; background-color: #97c2e2;">
                        <defs>
                            <pattern id="grid-pattern" width="50" height="50" patternUnits="userSpaceOnUse">
                                <path d="M 50 0 L 0 0 0 50" fill="none" stroke="rgba(0,0,0,0.05)" stroke-width="1"/>
                            </pattern>
                        </defs>

                        <!-- 1. LAND BASE (Direct Fill - Guaranteed Visibility) -->
                        <!-- The path coordinates are in ~10000 range, so we scale down by 0.1 -->
                        <!-- Y-flip is needed because SVG y-down vs map y-up often differs, or original data was flipped -->
                        <g transform="translate(0,1024) scale(0.1,-0.1)">
                            <!-- Main Land Mass: Beige #dcb891 -->
                            <path d="M6713 9109 c-27 -17 -33 -27 -33 -57 0 -33 -1 -34 -14 -17 -13 19
-16 18 -66 -13 -28 -18 -63 -32 -78 -32 -50 0 -67 -11 -96 -60 -17 -28 -39
-51 -52 -54 -46 -12 -105 -75 -143 -151 l-36 -76 -102 -35 -102 -35 -81 41
c-44 22 -100 43 -124 46 -39 6 -50 2 -122 -43 -43 -27 -105 -59 -137 -72 l-57
-23 -83 26 c-61 19 -105 43 -172 91 -49 36 -106 76 -125 90 -33 23 -48 25
-183 31 l-147 7 0 27 0 28 -65 -6 c-50 -3 -75 -1 -104 13 l-38 17 -64 -47
c-45 -33 -69 -45 -83 -40 -12 3 -59 12 -106 20 -47 7 -141 33 -210 58 -121 42
-127 43 -180 32 -30 -6 -79 -20 -108 -30 -47 -17 -52 -22 -52 -49 0 -27 -9
-37 -72 -78 -84 -54 -88 -54 -148 26 -32 43 -40 61 -40 96 0 38 -5 48 -49 89
-85 80 -104 92 -140 81 -33 -9 -98 -56 -143 -102 -17 -18 -36 -28 -55 -28 -17
0 -56 -9 -89 -20 -73 -26 -104 -20 -152 30 -25 25 -63 48 -120 70 l-82 32 -98
-12 c-57 -7 -158 -11 -247 -8 -135 4 -160 8 -246 36 -121 40 -245 45 -294 11
-62 -42 -207 -110 -258 -120 -38 -8 -63 -21 -92 -49 -22 -21 -53 -42 -70 -46
-16 -4 -55 -19 -85 -34 -50 -24 -62 -26 -132 -21 -82 6 -140 -1 -146 -18 -11
-32 -51 -76 -77 -84 -16 -5 -65 -36 -108 -69 l-79 -60 -76 11 c-85 13 -87 12
-96 -54 -6 -38 -13 -45 -85 -94 l-79 -53 -12 -77 c-25 -171 -33 -194 -65 -203
-17 -4 -66 -3 -113 4 -73 11 -86 10 -110 -4 -24 -15 -28 -25 -33 -85 -4 -37
-7 -113 -8 -168 -1 -73 -8 -125 -27 -195 -24 -88 -25 -104 -18 -215 4 -66 6
-179 5 -250 -3 -119 -1 -135 22 -185 13 -30 34 -64 46 -74 35 -32 71 -125 96
-251 13 -67 38 -151 55 -188 21 -48 38 -112 55 -210 30 -183 26 -268 -17 -346
-28 -51 -61 -141 -52 -141 2 0 23 12 46 26 40 25 42 26 55 8 7 -10 13 -32 13
-49 0 -18 9 -58 20 -90 26 -74 26 -101 0 -108 -16 -4 -20 -14 -20 -47 0 -38 2
-41 23 -34 12 4 38 17 57 30 47 33 118 33 146 2 41 -47 73 -106 79 -149 7 -44
7 -45 68 -67 34 -12 81 -22 104 -22 24 0 64 -8 91 -18 66 -25 197 -116 218
-151 19 -31 91 -71 130 -71 16 0 35 -11 52 -32 15 -17 58 -46 100 -65 61 -28
85 -33 146 -33 42 0 79 -5 89 -13 10 -7 21 -35 26 -66 10 -60 33 -85 89 -96
39 -7 63 9 82 56 7 16 22 32 35 35 21 5 244 0 502 -12 128 -5 132 -5 170 19
61 40 97 43 142 14 l38 -26 5 -88 c3 -48 11 -112 18 -141 10 -46 16 -55 52
-73 32 -16 50 -19 89 -14 47 7 48 6 55 -21 4 -16 17 -36 28 -45 17 -14 18 -19
7 -33 -19 -23 -6 -34 98 -85 l90 -44 3 -86 c2 -47 0 -121 -6 -165 l-9 -78 -41
-18 c-26 -11 -53 -34 -74 -64 -18 -25 -39 -46 -47 -46 -8 0 -26 -4 -40 -10
-26 -10 -26 -10 -9 -39 17 -29 17 -30 -14 -56 -30 -25 -32 -32 -32 -88 0 -34
-5 -100 -11 -147 -6 -47 -12 -121 -14 -165 -1 -44 -10 -109 -19 -145 -25 -104
-21 -160 17 -238 19 -37 50 -110 70 -162 51 -130 50 -130 81 -101 13 13 30 35
36 51 9 21 20 29 48 34 63 10 101 7 140 -13 20 -10 63 -26 94 -35 49 -14 57
-20 63 -46 8 -36 24 -46 88 -55 53 -8 56 -14 26 -41 -45 -41 -43 -50 20 -88
40 -25 71 -36 97 -36 22 0 48 -7 58 -15 11 -8 28 -15 37 -15 11 0 29 -20 46
-52 24 -44 34 -53 73 -64 25 -8 70 -14 101 -14 65 0 74 -6 125 -85 21 -33 65
-87 97 -120 l58 -60 52 -207 c48 -194 50 -208 35 -225 -10 -10 -26 -47 -37
-81 l-19 -63 24 -16 c18 -12 24 -24 24 -53 l0 -37 74 -21 c56 -17 88 -33 127
-67 48 -41 57 -44 88 -39 20 4 58 18 84 31 41 20 53 22 85 13 54 -15 59 -13
71 20 12 35 16 36 59 10 37 -23 66 -19 167 20 49 19 52 19 110 2 46 -13 80
-16 146 -12 85 5 86 5 139 53 36 32 58 46 69 41 9 -3 43 -16 76 -27 75 -26 82
-31 91 -70 7 -31 51 -107 63 -107 3 0 23 5 43 10 31 9 42 8 63 -6 14 -9 43
-20 65 -24 39 -7 39 -7 157 104 65 62 136 123 158 135 22 13 52 37 66 54 25
29 30 30 90 28 41 -1 74 4 91 13 26 14 29 13 43 -7 8 -12 15 -34 15 -49 0 -33
5 -34 65 -8 26 11 66 20 90 20 41 0 44 2 59 40 10 26 16 70 16 122 0 76 -3 88
-40 159 l-40 77 28 10 c18 6 34 23 46 51 18 38 22 41 58 41 22 0 73 14 113 31
l74 31 57 -46 c62 -51 59 -50 118 -35 36 9 56 26 135 115 94 106 119 152 136
252 6 37 10 42 34 42 15 0 50 -7 77 -15 44 -13 58 -13 132 2 70 13 86 20 100
42 43 68 85 111 109 111 26 0 71 -44 145 -142 l36 -49 -39 -36 -40 -36 22 -23
22 -23 -26 -10 c-31 -12 -44 -50 -27 -82 7 -12 17 -42 24 -66 6 -25 14 -44 19
-44 4 1 60 1 126 1 116 0 119 0 156 30 21 16 47 30 58 30 11 0 39 11 63 25 48
28 48 31 60 198 l6 99 -37 54 c-21 30 -50 63 -65 74 -18 13 -31 35 -39 65
l-11 45 -79 -41 c-83 -44 -130 -51 -183 -30 -27 10 -28 14 -28 76 0 62 4 74
71 203 57 112 70 143 66 172 -5 40 16 173 33 210 7 15 31 34 60 46 66 30 120
108 120 175 0 61 -23 123 -60 165 -42 48 -42 109 1 187 l31 57 -21 62 c-34
100 -23 178 23 178 7 0 26 10 41 22 25 20 27 25 21 72 -3 28 -9 78 -11 111
l-6 60 60 45 c48 36 63 54 76 93 25 73 66 90 220 91 l120 1 95 49 c52 27 97
53 99 59 2 6 27 45 56 87 34 50 54 91 59 120 4 25 11 68 16 95 5 28 9 73 9
101 1 47 5 55 36 83 39 34 81 40 145 21 19 -6 64 -14 99 -19 63 -8 63 -8 73
20 14 42 39 44 115 8 74 -34 137 -50 168 -43 11 3 31 21 44 41 20 32 23 45 19
103 -4 55 -1 74 16 107 30 58 92 123 129 135 41 14 100 57 128 92 l22 28 -20
26 c-30 40 -60 52 -136 52 -54 0 -75 4 -94 20 -33 26 -88 26 -148 0 l-47 -20
-90 25 c-80 22 -117 43 -118 68 0 4 20 44 44 90 24 45 50 107 56 137 16 69 44
131 68 154 19 16 19 18 -4 74 -38 92 -30 137 31 194 46 42 54 79 55 245 l0
131 -27 6 c-16 3 -57 11 -93 17 -36 7 -85 23 -109 37 -34 20 -61 27 -113 29
-66 2 -70 4 -136 57 -98 78 -222 254 -222 317 0 8 -18 39 -39 68 -29 39 -61
65 -123 100 -66 38 -93 60 -131 111 -30 40 -65 74 -95 90 -106 60 -290 195
-345 256 -33 35 -95 92 -139 126 -82 63 -118 116 -118 172 0 34 -40 48 -115
40 -61 -6 -64 -6 -111 30 l-48 37 -30 -29 -31 -29 -155 9 c-121 6 -166 13
-205 29 -33 14 -86 25 -155 30 -58 5 -116 11 -130 15 -47 13 -89 52 -101 97
-21 78 -70 172 -113 217 -39 41 -45 55 -70 158 -29 116 -114 343 -131 349 -6
1 -25 -7 -42 -18z" fill="#dcb891" stroke="none" />
                            
                            <!-- Green Zones (Approximated by reusing path with gradient or just overlay? 
                                 For now, let's just keep it simple beige to fix "blue screen" issue. 
                                 We can add a green overlay with opacity if needed, but let's ensure basic shape first. -->
                        </g>

                        <!-- 2. TEXTURE OVERLAY (Grid) -->
                        <rect width="1024" height="1024" fill="url(#grid-pattern)" pointer-events="none" />

                        <!-- 3. RIVERS & ROADS (Drawn in 1024x1024 space) -->
                        <g pointer-events="none">
                            <!-- Rivers (Blue #97c2e2 matching sea) -->
                            <!-- Nemunas -->
                            <path d="M 600 1024 Q 550 800 520 660 T 100 620" stroke="#97c2e2" stroke-width="20" fill="none" stroke-linecap="round" />
                            <!-- Neris -->
                            <path d="M 1024 500 Q 800 550 720 600 T 520 660" stroke="#97c2e2" stroke-width="15" fill="none" stroke-linecap="round" />

                            <!-- A1 Highway (Vilnius-Kaunas-Klaipeda) -->
                            <path d="M 730 590 L 515 660 L 110 630" stroke="#333" stroke-width="8" fill="none" stroke-linecap="round" />
                            <path d="M 730 590 L 515 660 L 110 630" stroke="#d9cd84" stroke-width="2" fill="none" stroke-dasharray="10,10" />
                        </g>

                        <!-- 4. FORESTS (Decorative Green Patches) -->
                        <g pointer-events="none" opacity="0.6">
                             <circle cx="300" cy="700" r="60" fill="#586c48" filter="blur(10px)" />
                             <circle cx="800" cy="800" r="80" fill="#586c48" filter="blur(10px)" />
                             <circle cx="600" cy="200" r="70" fill="#586c48" filter="blur(10px)" />
                        </g>

                        <!-- 5. BORDER OUTLINE -->
                        <g transform="translate(0,1024) scale(0.1,-0.1)" pointer-events="none">
                             <path d="M6713 9109 c-27 -17 -33 -27 -33 -57 0 -33 -1 -34 -14 -17 -13 19
-16 18 -66 -13 -28 -18 -63 -32 -78 -32 -50 0 -67 -11 -96 -60 -17 -28 -39
-51 -52 -54 -46 -12 -105 -75 -143 -151 l-36 -76 -102 -35 -102 -35 -81 41
c-44 22 -100 43 -124 46 -39 6 -50 2 -122 -43 -43 -27 -105 -59 -137 -72 l-57
-23 -83 26 c-61 19 -105 43 -172 91 -49 36 -106 76 -125 90 -33 23 -48 25
-183 31 l-147 7 0 27 0 28 -65 -6 c-50 -3 -75 -1 -104 13 l-38 17 -64 -47
c-45 -33 -69 -45 -83 -40 -12 3 -59 12 -106 20 -47 7 -141 33 -210 58 -121 42
-127 43 -180 32 -30 -6 -79 -20 -108 -30 -47 -17 -52 -22 -52 -49 0 -27 -9
-37 -72 -78 -84 -54 -88 -54 -148 26 -32 43 -40 61 -40 96 0 38 -5 48 -49 89
-85 80 -104 92 -140 81 -33 -9 -98 -56 -143 -102 -17 -18 -36 -28 -55 -28 -17
0 -56 -9 -89 -20 -73 -26 -104 -20 -152 30 -25 25 -63 48 -120 70 l-82 32 -98
-12 c-57 -7 -158 -11 -247 -8 -135 4 -160 8 -246 36 -121 40 -245 45 -294 11
-62 -42 -207 -110 -258 -120 -38 -8 -63 -21 -92 -49 -22 -21 -53 -42 -70 -46
-16 -4 -55 -19 -85 -34 -50 -24 -62 -26 -132 -21 -82 6 -140 -1 -146 -18 -11
-32 -51 -76 -77 -84 -16 -5 -65 -36 -108 -69 l-79 -60 -76 11 c-85 13 -87 12
-96 -54 -6 -38 -13 -45 -85 -94 l-79 -53 -12 -77 c-25 -171 -33 -194 -65 -203
-17 -4 -66 -3 -113 4 -73 11 -86 10 -110 -4 -24 -15 -28 -25 -33 -85 -4 -37
-7 -113 -8 -168 -1 -73 -8 -125 -27 -195 -24 -88 -25 -104 -18 -215 4 -66 6
-179 5 -250 -3 -119 -1 -135 22 -185 13 -30 34 -64 46 -74 35 -32 71 -125 96
-251 13 -67 38 -151 55 -188 21 -48 38 -112 55 -210 30 -183 26 -268 -17 -346
-28 -51 -61 -141 -52 -141 2 0 23 12 46 26 40 25 42 26 55 8 7 -10 13 -32 13
-49 0 -18 9 -58 20 -90 26 -74 26 -101 0 -108 -16 -4 -20 -14 -20 -47 0 -38 2
-41 23 -34 12 4 38 17 57 30 47 33 118 33 146 2 41 -47 73 -106 79 -149 7 -44
7 -45 68 -67 34 -12 81 -22 104 -22 24 0 64 -8 91 -18 66 -25 197 -116 218
-151 19 -31 91 -71 130 -71 16 0 35 -11 52 -32 15 -17 58 -46 100 -65 61 -28
85 -33 146 -33 42 0 79 -5 89 -13 10 -7 21 -35 26 -66 10 -60 33 -85 89 -96
39 -7 63 9 82 56 7 16 22 32 35 35 21 5 244 0 502 -12 128 -5 132 -5 170 19
61 40 97 43 142 14 l38 -26 5 -88 c3 -48 11 -112 18 -141 10 -46 16 -55 52
-73 32 -16 50 -19 89 -14 47 7 48 6 55 -21 4 -16 17 -36 28 -45 17 -14 18 -19
7 -33 -19 -23 -6 -34 98 -85 l90 -44 3 -86 c2 -47 0 -121 -6 -165 l-9 -78 -41
-18 c-26 -11 -53 -34 -74 -64 -18 -25 -39 -46 -47 -46 -8 0 -26 -4 -40 -10
-26 -10 -26 -10 -9 -39 17 -29 17 -30 -14 -56 -30 -25 -32 -32 -32 -88 0 -34
-5 -100 -11 -147 -6 -47 -12 -121 -14 -165 -1 -44 -10 -109 -19 -145 -25 -104
-21 -160 17 -238 19 -37 50 -110 70 -162 51 -130 50 -130 81 -101 13 13 30 35
36 51 9 21 20 29 48 34 63 10 101 7 140 -13 20 -10 63 -26 94 -35 49 -14 57
-20 63 -46 8 -36 24 -46 88 -55 53 -8 56 -14 26 -41 -45 -41 -43 -50 20 -88
40 -25 71 -36 97 -36 22 0 48 -7 58 -15 11 -8 28 -15 37 -15 11 0 29 -20 46
-52 24 -44 34 -53 73 -64 25 -8 70 -14 101 -14 65 0 74 -6 125 -85 21 -33 65
-87 97 -120 l58 -60 52 -207 c48 -194 50 -208 35 -225 -10 -10 -26 -47 -37
-81 l-19 -63 24 -16 c18 -12 24 -24 24 -53 l0 -37 74 -21 c56 -17 88 -33 127
-67 48 -41 57 -44 88 -39 20 4 58 18 84 31 41 20 53 22 85 13 54 -15 59 -13
71 20 12 35 16 36 59 10 37 -23 66 -19 167 20 49 19 52 19 110 2 46 -13 80
-16 146 -12 85 5 86 5 139 53 36 32 58 46 69 41 9 -3 43 -16 76 -27 75 -26 82
-31 91 -70 7 -31 51 -107 63 -107 3 0 23 5 43 10 31 9 42 8 63 -6 14 -9 43
-20 65 -24 39 -7 39 -7 157 104 65 62 136 123 158 135 22 13 52 37 66 54 25
29 30 30 90 28 41 -1 74 4 91 13 26 14 29 13 43 -7 8 -12 15 -34 15 -49 0 -33
5 -34 65 -8 26 11 66 20 90 20 41 0 44 2 59 40 10 26 16 70 16 122 0 76 -3 88
-40 159 l-40 77 28 10 c18 6 34 23 46 51 18 38 22 41 58 41 22 0 73 14 113 31
l74 31 57 -46 c62 -51 59 -50 118 -35 36 9 56 26 135 115 94 106 119 152 136
252 6 37 10 42 34 42 15 0 50 -7 77 -15 44 -13 58 -13 132 2 70 13 86 20 100
42 43 68 85 111 109 111 26 0 71 -44 145 -142 l36 -49 -39 -36 -40 -36 22 -23
22 -23 -26 -10 c-31 -12 -44 -50 -27 -82 7 -12 17 -42 24 -66 6 -25 14 -44 19
-44 4 1 60 1 126 1 116 0 119 0 156 30 21 16 47 30 58 30 11 0 39 11 63 25 48
28 48 31 60 198 l6 99 -37 54 c-21 30 -50 63 -65 74 -18 13 -31 35 -39 65
l-11 45 -79 -41 c-83 -44 -130 -51 -183 -30 -27 10 -28 14 -28 76 0 62 4 74
71 203 57 112 70 143 66 172 -5 40 16 173 33 210 7 15 31 34 60 46 66 30 120
108 120 175 0 61 -23 123 -60 165 -42 48 -42 109 1 187 l31 57 -21 62 c-34
100 -23 178 23 178 7 0 26 10 41 22 25 20 27 25 21 72 -3 28 -9 78 -11 111
l-6 60 60 45 c48 36 63 54 76 93 25 73 66 90 220 91 l120 1 95 49 c52 27 97
53 99 59 2 6 27 45 56 87 34 50 54 91 59 120 4 25 11 68 16 95 5 28 9 73 9
101 1 47 5 55 36 83 39 34 81 40 145 21 19 -6 64 -14 99 -19 63 -8 63 -8 73
20 14 42 39 44 115 8 74 -34 137 -50 168 -43 11 3 31 21 44 41 20 32 23 45 19
103 -4 55 -1 74 16 107 30 58 92 123 129 135 41 14 100 57 128 92 l22 28 -20
26 c-30 40 -60 52 -136 52 -54 0 -75 4 -94 20 -33 26 -88 26 -148 0 l-47 -20
-90 25 c-80 22 -117 43 -118 68 0 4 20 44 44 90 24 45 50 107 56 137 16 69 44
131 68 154 19 16 19 18 -4 74 -38 92 -30 137 31 194 46 42 54 79 55 245 l0
131 -27 6 c-16 3 -57 11 -93 17 -36 7 -85 23 -109 37 -34 20 -61 27 -113 29
-66 2 -70 4 -136 57 -98 78 -222 254 -222 317 0 8 -18 39 -39 68 -29 39 -61
65 -123 100 -66 38 -93 60 -131 111 -30 40 -65 74 -95 90 -106 60 -290 195
-345 256 -33 35 -95 92 -139 126 -82 63 -118 116 -118 172 0 34 -40 48 -115
40 -61 -6 -64 -6 -111 30 l-48 37 -30 -29 -31 -29 -155 9 c-121 6 -166 13
-205 29 -33 14 -86 25 -155 30 -58 5 -116 11 -130 15 -47 13 -89 52 -101 97
-21 78 -70 172 -113 217 -39 41 -45 55 -70 158 -29 116 -114 343 -131 349 -6
1 -25 -7 -42 -18z" fill="none" stroke="#000" stroke-width="30" />
                        </g>

                        <!-- 6. INTERACTIVE CITIES -->
                        <!-- Added explicit onclick and pointer-events -->
                        
                        <!-- Vilnius -->
                        <g class="city-marker" onclick="selectCity('Vilnius', 40, 72)" style="cursor: pointer; pointer-events: all;">
                            <rect x="690" y="560" width="80" height="80" fill="rgba(255, 215, 0, 0.4)" stroke="#ffd700" stroke-width="4" />
                            <text x="730" y="600" text-anchor="middle" fill="white" font-family="Arial" font-weight="bold" font-size="14" stroke="black" stroke-width="3" paint-order="stroke">VILNIUS</text>
                            <text x="730" y="600" text-anchor="middle" fill="white" font-family="Arial" font-weight="bold" font-size="14">VILNIUS</text>
                        </g>

                        <!-- Kaunas -->
                        <g class="city-marker" onclick="selectCity('Kaunas', 35, 50)" style="cursor: pointer; pointer-events: all;">
                            <rect x="480" y="630" width="70" height="70" fill="rgba(255, 215, 0, 0.4)" stroke="#ffd700" stroke-width="4" />
                             <text x="515" y="670" text-anchor="middle" fill="white" font-family="Arial" font-weight="bold" font-size="14" stroke="black" stroke-width="3" paint-order="stroke">KAUNAS</text>
                             <text x="515" y="670" text-anchor="middle" fill="white" font-family="Arial" font-weight="bold" font-size="14">KAUNAS</text>
                        </g>

                        <!-- Klaipeda -->
                        <g class="city-marker" onclick="selectCity('Klaipeda', 38, 12)" style="cursor: pointer; pointer-events: all;">
                             <rect x="80" y="600" width="60" height="60" fill="rgba(255, 215, 0, 0.4)" stroke="#ffd700" stroke-width="4" />
                             <text x="110" y="635" text-anchor="middle" fill="white" font-family="Arial" font-weight="bold" font-size="14" stroke="black" stroke-width="3" paint-order="stroke">KLAIPEDA</text>
                             <text x="110" y="635" text-anchor="middle" fill="white" font-family="Arial" font-weight="bold" font-size="14">KLAIPEDA</text>
                        </g>
                    </svg>
                    
                    <!-- Blips -->
                    <div class="district-marker" style="top: 75%; left: 70%;" onclick="selectCity('Vilnius', 75, 70)">
<div class="blip-icon"></div>
<div style="margin-top:5px; background:#000; padding:2px; font-size:10px; text-shadow:none; cursor:pointer;">VILNIUS</div>
</div>
                    
                    <div class="district-marker" style="top: 65%; left: 50%;" onclick="selectCity('Kaunas', 65, 50)">
<div class="blip-icon"></div>
<div style="margin-top:5px; background:#000; padding:2px; font-size:10px; text-shadow:none; cursor:pointer;">KAUNAS</div>
</div>
                    
                    <div class="district-marker" style="top: 35%; left: 15%;" onclick="selectCity('Klaipeda', 35, 15)">
<div class="blip-icon"></div>
<div style="margin-top:5px; background:#000; padding:2px; font-size:10px; text-shadow:none; cursor:pointer;">KLAIPEDA</div>
</div>
                </div>
            </div>

            <!-- HUD -->
            <div class="map-hud-top">
                <div class="map-title">MAP</div>
                <div class="btn-close-map" onclick="showSection('shop')">CLOSE</div>
            </div>


            <!-- Bottom Sheet -->
            <div class="bottom-sheet" id="city-sheet">
                <div class="bs-title" id="sheet-title">CITY</div>
                <div class="bs-info" id="sheet-info">NO INTEL</div>
                <button class="btn-buy" onclick="openCityShop()">VISIT SHOP</button>
            </div>
        </div>

<!-- STATS SECTION -->
                <!-- WALLET SECTION -->
        <div id="wallet" class="section">
            <div class="placeholder-box">
                <div style="font-size: 24px; color: #ccc;">CURRENT BALANCE</div>
                <div style="font-size: 48px; color: var(--gta-green); margin: 10px 0;">$0.00</div>
                
                <div style="margin-top: 30px;">
                    <div style="font-size: 20px; color: var(--gta-gold); margin-bottom: 15px;">TOP UP BALANCE</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <button class="btn-buy" onclick="initTopUp('BTC')">BTC</button>
                        <button class="btn-buy" onclick="initTopUp('LTC')">LTC</button>
                        <button class="btn-buy" onclick="initTopUp('USDT')">USDT</button>
                        <button class="btn-buy" onclick="initTopUp('ETH')">ETH</button>
                    </div>
                </div>

                <div style="margin-top: 30px;">
                    <div style="font-size: 20px; color: var(--gta-gold); margin-bottom: 15px;">TRANSACTIONS</div>
                    <div class="stat-row"><span>INITIAL GRANT</span><span style="color: var(--gta-green);">+$0.00</span></div>
                </div>
            </div>
        </div>

<div id="stats" class="section">
            <div class="placeholder-box" style="text-align: left;">
                <div style="font-size: 32px; margin-bottom: 20px; color: var(--gta-gold); text-align:center;">STATS</div>
                
                <div style="display: flex; gap: 20px; align-items: flex-start;">
                    <!-- Character Image -->
                    <div style="text-align:center; width: 120px;">
                         <img src="https://static.wikia.nocookie.net/gtawiki/images/c/ce/Carl_Johnson.png" id="char-img" style="height: 180px; filter: drop-shadow(2px 2px 0 #000);">
                         <div style="margin-top: 10px;">
                             <button class="filter-btn" onclick="changeSkin('cj')" style="width:100%; font-size:12px;">CJ</button>
                             <button class="filter-btn" onclick="changeSkin('sweet')" style="width:100%; font-size:12px; margin-top:2px;">SWEET</button>
                             <button class="filter-btn" onclick="changeSkin('ryder')" style="width:100%; font-size:12px; margin-top:2px;">RYDER</button>
                         </div>
                    </div>
                    
                    <!-- Stats List -->
                    <div style="flex: 1;">
                        <div class="stat-row"><span>CRIMINAL RATING</span><span>Gangsta</span></div>
                        <div class="stat-row"><span>RESPECT</span><span style="color: var(--gta-green);">â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ</span></div>
                        <div class="stat-row"><span>STAMINA</span><span>â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘</span></div>
                        <div class="stat-row"><span>MUSCLE</span><span>â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘</span></div>
                        <div class="stat-row"><span>FAT</span><span>â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘</span></div>
                        <div class="stat-row"><span>SEX APPEAL</span><span>â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘</span></div>
                        <div class="stat-row"><span>LUCK</span><span>â–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘</span></div>
                        <div class="stat-row"><span>TERRITORIES</span><span>3</span></div>
                        <div class="stat-row"><span>DAYS PASSED</span><span>24</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation -->
        <div class="nav">
        <div class="nav-item active" id="nav-shop" onclick="showSection('shop')">SHOP</div>
        <div class="nav-item" id="nav-map" onclick="showSection('map')">MAP</div>
        <div class="nav-item" id="nav-wallet" onclick="showSection('wallet')">WALLET</div>
        <div class="nav-item" id="nav-stats" onclick="showSection('stats')">STATS</div>
    </div>
        <div class="nav-item" id="nav-map" onclick="showSection('map')">MAP</div>
        <div class="nav-item" id="nav-stats" onclick="showSection('stats')">STATS</div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.MainButton.hide();

        let allProducts = [];
        let currentStation = 0;
        // SomaFM Streams (Reliable HTTPS)
        const stations = [
            { name: "RADIO OFF", src: null },
            { name: "GROOVE SALAD", src: "https://ice2.somafm.com/groovesalad-128-mp3" }, // Downtempo
            { name: "SECRET AGENT", src: "https://ice2.somafm.com/secretagent-128-mp3" }, // Spy/Lounge
            { name: "DEF CON", src: "https://ice2.somafm.com/defcon-128-mp3" } // Electronic
        ];
        let audioPlayer = null;

        // --- Logic ---

        async function loadProducts() {
            try {
                const response = await fetch('/webapp/api/products');
                const data = await response.json();
                if(data.success) {
                    allProducts = data.products;
                    renderProducts(allProducts);
                    renderFilters(allProducts);
                    updateStars(Math.floor(Math.random() * 6)); // Mock stars for now
                } else {
                    document.getElementById('product-grid').innerHTML = '<div class="loading" style="color:red">ERROR</div>';
                }
            } catch (e) {
                document.getElementById('product-grid').innerHTML = '<div class="loading" style="color:red">OFFLINE</div>';
            }
        }

        function renderProducts(products) {
            console.log("Render Products v2.1 - Strict Cleaning");
            const grid = document.getElementById('product-grid');
            grid.innerHTML = '';
            
            // Group products by Cleaned Name + Type + City + Size + Price
            const groups = {};
            products.forEach(p => {
                // CLEAN NAME: Remove any sequence of 6+ digits/underscores (IDs)
                // This handles cases where ID is stuck to the name in DB
                let cleanName = p.name.replace(/[\d_]{6,}.*/g, '').trim();
                
                // Also remove trailing numbers if they look like IDs
                cleanName = cleanName.replace(/\s\d+$/, '').trim();

                const key = `${cleanName.toLowerCase()}|${p.type}|${p.city}|${p.size}|${p.price}`;
                
                if(!groups[key]) {
                    groups[key] = { 
                        ...p, 
                        display_name: cleanName, // Store cleaned name for display
                        count: 0, 
                        ids: [] 
                    };
                }
                groups[key].count++;
                groups[key].ids.push(p.id);
            });
            
            const uniqueProducts = Object.values(groups);

            if(uniqueProducts.length === 0) {
                grid.innerHTML = '<div style="text-align:center; width:100%">NO ITEMS FOUND</div>';
                return;
            }
            
            uniqueProducts.forEach(p => {
                const card = document.createElement('div');
                card.className = 'product-card';
                const countBadge = p.count > 1 ? `<div style="position:absolute; top:5px; right:5px; background:var(--gta-gold); color:#000; padding:2px 6px; font-size:12px; border-radius:4px; font-weight:bold;">x${p.count}</div>` : '';
                
                card.innerHTML = `
                    ${countBadge}
                    <div class="product-emoji">${getProductEmoji(p.type)}</div>
                    <div class="product-name">${p.display_name}</div>
                    <div class="product-details">${p.size} | ${p.city}</div>
                    <div class="product-price">$${p.price.toFixed(2)}</div>
                    <button class="btn-buy" onclick="buyProduct(${p.ids[0]}, '${p.display_name}', ${p.price})">BUY</button>
                `;
                grid.appendChild(card);
            });
        }

        // LSPD Search
        function filterSearch(query) {
            const term = query.toLowerCase();
            const filtered = allProducts.filter(p => 
                p.name.toLowerCase().includes(term) || 
                p.city.toLowerCase().includes(term)
            );
            renderProducts(filtered);
        }

        // Filters
        function renderFilters(products) {
            const cities = [...new Set(products.map(p => p.city))];
            const container = document.getElementById('city-filters');
            container.innerHTML = '<button class="filter-btn active" onclick="filterProducts(\'all\')">ALL ZONES</button>';
            cities.forEach(city => {
                const btn = document.createElement('button');
                btn.className = 'filter-btn';
                btn.innerText = city.toUpperCase();
                btn.onclick = () => filterProducts(city);
                container.appendChild(btn);
            });
        }

        function filterProducts(city) {
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            if(city === 'all') renderProducts(allProducts);
            else renderProducts(allProducts.filter(p => p.city === city));
        }

        // Stars
        function updateStars(count) {
            const stars = document.querySelectorAll('.star');
            stars.forEach((s, i) => {
                s.classList.remove('active', 'flashing');
                if (i < count) s.classList.add('active');
                if (count === 5) s.classList.add('flashing');
            });
        }

        // Radio - Native HTML5 Audio
        function toggleRadio() {
            // Stop previous
            if(audioPlayer) {
                audioPlayer.pause();
                audioPlayer.src = "";
                audioPlayer = null;
            }

            currentStation = (currentStation + 1) % stations.length;
            const station = stations[currentStation];
            const widget = document.querySelector('.radio-widget');
            
            document.querySelector('.radio-text').innerText = "ðŸ“» " + station.name;
            widget.classList.add('active');
            setTimeout(() => widget.classList.remove('active'), 3000);

            if(station.src) {
                try {
                    audioPlayer = new Audio(station.src);
                    audioPlayer.crossOrigin = "anonymous";
                    audioPlayer.volume = 0.5;
                    
                    const playPromise = audioPlayer.play();
                    if (playPromise !== undefined) {
                        playPromise.then(_ => {
                            // Autoplay started!
                        }).catch(error => {
                            console.log("Radio Play Blocked: " + error);
                            document.querySelector('.radio-text').innerText = "âŒ SIGNAL BLOCKED";
                        });
                    }
                    
                    audioPlayer.onerror = function() {
                        console.log("Stream Error");
                        document.querySelector('.radio-text').innerText = "âŒ SIGNAL LOST";
                    };
                } catch(e) {
                    console.log("Audio Error: " + e);
                }
            }
        }

                // Map Logic (Mobile Pan/Zoom)
        let mapState = { scale: 1, x: 0, y: 0, isDragging: false, startX: 0, startY: 0 };
        let selectedCity = null;

                function fitMapToScreen() {
            const w = window.innerWidth;
            const h = window.innerHeight;
            const mapSize = 1024;
            
            // Calculate scale to fit (contain)
            const scaleX = w / mapSize;
            const scaleY = h / mapSize;
            let scale = Math.min(scaleX, scaleY);
            
            // Center it
            const x = (w - (mapSize * scale)) / 2;
            const y = (h - (mapSize * scale)) / 2;
            
            mapState.scale = scale;
            mapState.x = x;
            mapState.y = y;
            updateMapTransform();
        }

        function initMapEvents() {
            fitMapToScreen();
            window.addEventListener('resize', fitMapToScreen);
            const viewport = document.getElementById('map-viewport');
            if(!viewport) return;
            
            // Touch
            viewport.addEventListener('touchstart', e => {
                if(e.touches.length === 1) {
                    mapState.isDragging = true;
                    mapState.startX = e.touches[0].clientX - mapState.x;
                    mapState.startY = e.touches[0].clientY - mapState.y;
                }
            });
            
            viewport.addEventListener('touchmove', e => {
                if(mapState.isDragging && e.touches.length === 1) {
                    e.preventDefault(); // Stop scroll
                    mapState.x = e.touches[0].clientX - mapState.startX;
                    mapState.y = e.touches[0].clientY - mapState.startY;
                    updateMapTransform();
                }
            });
            
            viewport.addEventListener('touchend', () => mapState.isDragging = false);

            // Mouse (Testing)
            viewport.addEventListener('mousedown', e => {
                mapState.isDragging = true;
                mapState.startX = e.clientX - mapState.x;
                mapState.startY = e.clientY - mapState.y;
            });
            viewport.addEventListener('mousemove', e => {
                if(mapState.isDragging) {
                    mapState.x = e.clientX - mapState.startX;
                    mapState.y = e.clientY - mapState.startY;
                    updateMapTransform();
                }
            });
            viewport.addEventListener('mouseup', () => mapState.isDragging = false);
            viewport.addEventListener('mouseleave', () => mapState.isDragging = false);
        }

        function updateMapTransform() {
            const layer = document.getElementById('map-layer');
            if(layer) layer.style.transform = `translate(${mapState.x}px, ${mapState.y}px) scale(${mapState.scale})`;
        }

        function mapZoomIn() {
            mapState.scale = Math.min(mapState.scale * 1.2, 5);
            updateMapTransform();
        }

        function mapZoomOut() {
            mapState.scale = Math.max(mapState.scale / 1.2, 1);
            if(mapState.scale === 1) { mapState.x = 0; mapState.y = 0; }
            updateMapTransform();
        }

                function mapReset() {
            fitMapToScreen();
            document.getElementById('map-back-btn').style.display = 'none';
            document.getElementById('city-sheet').classList.remove('active');
        }
        
        function closeSheet() {
            const sheet = document.getElementById('city-sheet');
            if(sheet) sheet.classList.remove('active');
        }

        function openCityShop() {
            if(selectedCity) {
                showSection('shop');
                filterProducts(selectedCity);
                const btns = document.querySelectorAll('.filter-btn');
                for(let btn of btns) {
                    if(btn.innerText === selectedCity.toUpperCase()) {
                        btn.click();
                        break;
                    }
                }
            }
        }
        
        // Call init
        initMapEvents();


        // Mission Passed
        function buyProduct(id, name, price) {
            tg.showPopup({
                title: 'CONFIRM DEAL',
                message: `Purchase ${name} for $${price}?`,
                buttons: [{id: 'buy', type: 'ok', text: 'DEAL'}, {id: 'cancel', type: 'cancel'}]
            }, function(btnId) {
                if(btnId === 'buy') {
                    // Trigger animation
                    const overlay = document.getElementById('mp-overlay');
                    overlay.style.display = 'flex';
                    setTimeout(() => {
                        overlay.classList.add('mp-active');
                    }, 10);

                    setTimeout(() => {
                        tg.sendData(`BUY_WEBAPP:${id}`);
                    }, 3000);
                }
            });
        }

        // Skins
        function changeSkin(skin) {
            const img = document.getElementById('char-img');
            if(skin === 'cj') img.src = "https://static.wikia.nocookie.net/gtawiki/images/c/ce/Carl_Johnson.png";
            if(skin === 'ryder') img.src = "https://static.wikia.nocookie.net/gtawiki/images/6/67/Ryder-GTASA.png";
            if(skin === 'sweet') img.src = "https://static.wikia.nocookie.net/gtawiki/images/1/1b/Sweet-GTASA.png";
        }

                        let selectedCryptoForTopUp = '';

        function initTopUp(crypto) {
            selectedCryptoForTopUp = crypto;
            const modal = document.getElementById('amount-modal');
            modal.style.display = 'flex';
            setTimeout(() => document.getElementById('amount-input').focus(), 100);
        }

        function closeAmountModal() {
            document.getElementById('amount-modal').style.display = 'none';
        }

        function confirmAmount() {
            const amt = document.getElementById('amount-input').value;
            if(!amt || amt <= 0) {
                tg.showAlert('Please enter a valid amount.');
                return;
            }
            closeAmountModal();
            tg.sendData(`TOPUP:${selectedCryptoForTopUp}:${amt}`);
            tg.close();
        }


        // Navigation
        function showSection(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(`nav-${id}`).classList.add('active');
        }
        
        function getProductEmoji(type) {
            if(!type) return 'ðŸ“¦';
            const t = type.toLowerCase();
            if(t.includes('weed') || t.includes('cannabis')) return 'ðŸŒ¿';
            if(t.includes('pill') || t.includes('xtc')) return 'ðŸ’Š';
            if(t.includes('powder') || t.includes('coke')) return 'ðŸš';
            return 'ðŸ“¦';
        }

        // Init
        loadProducts();
    </script>

    <!-- Amount Input Modal -->
    <div id="amount-modal" class="mission-passed-overlay" style="display: none; background: rgba(0,0,0,0.9); flex-direction: column; z-index: 2000;">
        <div style="font-family: 'Pricedown', sans-serif; font-size: 40px; color: #fff; margin-bottom: 20px;">ENTER AMOUNT (EUR)</div>
        <input type="number" id="amount-input" placeholder="10" style="font-family: 'Diplomata', cursive; font-size: 30px; padding: 10px; width: 150px; text-align: center; background: #000; color: var(--gta-green); border: 2px solid var(--gta-green); margin-bottom: 20px; outline: none;">
        <div style="display: flex; gap: 20px;">
            <button class="btn-buy" onclick="confirmAmount()">CONFIRM</button>
            <button class="btn-buy" style="background: #900;" onclick="closeAmountModal()">CANCEL</button>
        </div>
    </div>

</body>
</html>