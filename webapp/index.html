<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Los Santos Shop v2.1</title>
    <link rel="preload" href="/webapp/intro.mp4" as="video" type="video/mp4">
    <link rel="preload" href="/webapp/ah_shit.mp3" as="audio">
    <link rel="preload" href="https://raw.githubusercontent.com/marcoguglie/css-smoke-effect/master/smoke.png" as="image">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- assets.js removed, embedded inline -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=UnifrakturMaguntia&display=swap" rel="stylesheet">
    <style>
        @font-face {
            font-family: 'Pricedown';
            src: url('/webapp/pricedown.woff') format('woff');
        }
        
        :root {
            --gta-green: #3fa535;
            --gta-gold: #cfa936;
            --gta-black: #000000;
            --gta-grey: #a0a0a0;
            
            /* APPLE POLISH VARS */
            --spring-bounce: cubic-bezier(0.34, 1.56, 0.64, 1); 
            --spring-smooth: cubic-bezier(0.25, 0.8, 0.25, 1);
            --glass-bg: rgba(15, 20, 15, 0.85);
            --glass-border: 1px solid rgba(80, 255, 80, 0.15);
        }

        /* Staggered List Entry Animation */
        @keyframes slideInStagger {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Pulse Glow for Pins */
        @keyframes pulseGlow {
            0% { box-shadow: 0 0 0 0 rgba(63, 165, 53, 0.6); transform: translate(-50%, -50%) scale(1); }
            70% { box-shadow: 0 0 0 15px rgba(63, 165, 53, 0); transform: translate(-50%, -50%) scale(1.1); }
            100% { box-shadow: 0 0 0 0 rgba(63, 165, 53, 0); transform: translate(-50%, -50%) scale(1); }
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--gta-black);
            color: #fff;
            font-family: 'Pricedown', sans-serif;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
            user-select: none;
            overscroll-behavior: none;
            -webkit-font-smoothing: antialiased;
        }

        /* Background */
        .bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.8)), url('https://upload.wikimedia.org/wikipedia/commons/thumb/3/3e/Los_Angeles_from_Griffith_Observatory.jpg/1280px-Los_Angeles_from_Griffith_Observatory.jpg');
            background-size: cover;
            background-position: center;
            z-index: -2;
        }

        /* Scanline Effect */
        .scanlines {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.2) 50%, rgba(0,0,0,0.2));
            background-size: 100% 4px;
            z-index: 100;
            pointer-events: none;
            opacity: 0.3;
        }

        /* App Header (Minimal Authentic) */
        .app-header {
            background: #000;
            border-bottom: 2px solid #333;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            height: 60px;
            box-sizing: border-box;
            position: relative;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        
        /* Center Only */
        .header-center { 
            text-align: center; 
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .zone-text {
            font-family: 'Pricedown', sans-serif;
            font-size: 32px;
            color: #fff;
            letter-spacing: 2px;
            text-shadow: 3px 3px 0 #000;
            text-transform: uppercase;
            transform: scaleY(1.1);
        }
        
        .money {
            color: var(--gta-green);
            font-size: 26px;
            font-family: 'Pricedown', sans-serif;
            text-shadow: 2px 2px 0 #000;
            letter-spacing: 1px;
        }

        /* Wanted Level */
        .wanted-stars {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }
        
        .star {
            font-size: 20px;
            color: #333; /* Inactive */
        }
        
        .star.active {
            color: #fff;
            text-shadow: 0 0 5px #fff;
        }
        
        .star.flashing {
            animation: starFlash 0.5s infinite alternate;
        }
        
        @keyframes starFlash {
            from { color: #fff; opacity: 1; }
            to { color: #cfa936; opacity: 0.8; }
        }

        /* Navigation (HUD Style) */
        .bottom-nav {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 400px;
            background: rgba(0, 0, 0, 0.95);
            border: 2px solid #333;
            border-radius: 50px;
            display: flex;
            justify-content: space-evenly;
            padding: 10px 0;
            z-index: 10000;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #666;
            cursor: pointer;
            transition: all 0.2s;
            width: 60px;
        }
        
        .nav-icon {
            font-size: 22px;
            margin-bottom: 2px;
            filter: grayscale(100%) brightness(0.7);
            transition: all 0.2s;
        }
        
        .nav-item span {
            font-family: 'Impact', sans-serif;
            font-size: 10px;
            letter-spacing: 1px;
        }
        
        .nav-item.active {
            color: #fff;
        }
        
        .nav-item.active .nav-icon {
            filter: grayscale(0%) brightness(1.2);
            transform: scale(1.2);
            text-shadow: 0 0 10px var(--gta-green);
        }

        /* Content Area */
        .content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            position: relative;
            z-index: 1;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior-y: contain;
        }

        /* Sections */
        .section {
            display: none;
            animation: fadeIn 0.3s ease-in;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Product Grid */
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
        }

        /* RETRO CYBER CARD (V2) */
        .product-card {
            background: rgba(0, 0, 0, 0.85);
            border: 2px solid #333;
            border-radius: 0;
            padding: 15px;
            text-align: center;
            transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 0 rgba(0,0,0,0.5);
        }

        .product-card:hover {
            border-color: var(--gta-green);
            transform: translateY(-2px);
            box-shadow: 0 0 20px rgba(63, 165, 53, 0.2);
            background: rgba(10, 20, 10, 0.9);
            z-index: 10;
        }
        
        /* Tech Accent Bar */
        .product-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 4px;
            background: var(--gta-green);
            opacity: 0.5;
        }
        .product-card:hover::before {
            opacity: 1;
            box-shadow: 0 0 10px var(--gta-green);
        }

        .product-emoji {
            font-size: 40px;
            margin: 10px 0;
            cursor: pointer;
        }

        .product-name {
            font-family: 'Impact', sans-serif;
            font-size: 18px;
            margin: 5px 0;
            color: #fff;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .product-details {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #ccc;
            margin-bottom: 10px;
        }

        .product-price {
            font-size: 24px;
            color: var(--gta-green);
            margin: 10px 0;
            text-shadow: 1px 1px 0 #000;
        }

        .btn-buy {
            background: var(--gta-green);
            color: #000;
            border: 1px solid #000;
            border-radius: 2px;
            padding: 10px;
            font-family: 'Impact', sans-serif;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.1s;
            text-transform: uppercase;
            letter-spacing: 1px;
            width: 100%;
            box-shadow: 0 3px 0 #000;
        }
        
        .btn-buy:hover {
            background: var(--gta-green);
            color: #000;
            filter: brightness(1.2);
            transform: translateY(-2px);
            box-shadow: 0 5px 0 #000, 0 0 15px var(--gta-green);
        }
        
        .btn-buy:active {
            transform: translateY(3px);
            box-shadow: 0 0 0 #000;
            filter: brightness(0.8);
        }

        /* Radio */
        /* Minimal Floating Radio Pill */
        .radio-pill {
            position: fixed;
            bottom: 100px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid #444;
            border-radius: 30px;
            padding: 8px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 9999;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(0,0,0,0.6);
            transition: all 0.2s ease;
            pointer-events: auto;
        }
        
        .radio-pill:active {
            transform: scale(0.95);
            background: #222;
            border-color: var(--gta-green);
        }
        
        .radio-icon-small {
            font-size: 14px;
            animation: pulse 2s infinite;
        }
        
        .radio-text-scroll {
            color: var(--gta-green);
            font-family: 'Courier New', monospace;
            font-weight: bold;
            font-size: 12px;
            white-space: nowrap;
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* GTA Street Sign Header */
        .street-sign-header {
            background: transparent;
            border: none;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 60px;
            pointer-events: none;
            position: relative;
            z-index: 100;
        }
        
        /* Spray Paint Header (Vandalism) */
        .spray-header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 0; /* Zero logical height so clicks pass */
            z-index: 1000;
            pointer-events: none; 
            display: flex;
            justify-content: center;
            /* No background */
        }

        .spray-text {
            margin-top: 10px;
            font-family: 'Impact', sans-serif;
            font-size: 42px;
            color: var(--gta-green);
            text-transform: uppercase;
            letter-spacing: -1px;
            transform: rotate(-3deg);
            
            /* Spray Paint Blur & Glow */
            filter: blur(0.4px);
            text-shadow: 
                0 0 10px rgba(46, 204, 113, 0.8),
                0 0 20px rgba(46, 204, 113, 0.4),
                2px 2px 0 #000;
            
            /* Stencil texture via mask (simulated) */
            opacity: 0.95;
            mix-blend-mode: normal; /* Keep it visible on top */
        }
        
        /* Drips */
        .drip {
            position: absolute;
            background: var(--gta-green);
            width: 4px;
            border-radius: 2px;
            box-shadow: 0 0 5px var(--gta-green);
        }
        .drip.d1 { left: 45%; top: 45px; height: 20px; animation: dripGrow 3s ease-in infinite; }
        .drip.d2 { left: 52%; top: 50px; height: 35px; animation: dripGrow 4s ease-in infinite 0.5s; }
        .drip.d3 { left: 48%; top: 48px; height: 15px; animation: dripGrow 2.5s ease-in infinite 1s; }
        
        @keyframes dripGrow {
            0% { transform: scaleY(0.2); transform-origin: top; opacity: 0.8; }
            40% { transform: scaleY(1); transform-origin: top; opacity: 0.9; }
            80% { transform: scaleY(1.2); transform-origin: top; opacity: 0.5; }
            100% { transform: scaleY(1.2); transform-origin: top; opacity: 0; }
        }

        /* Reset Search Container */
        .search-container {
            margin-top: 60px; /* Push down to clear the spray paint */
            margin-bottom: 15px;
            background: rgba(0,0,0,0.7); /* Darker bg for contrast */
            border: 1px solid #333;
            border-radius: 4px;
            padding: 10px;
            backdrop-filter: none;
        }
        
        /* Section Padding */
        .section {
            padding-top: 10px; /* Reset default, rely on search-container margin */
        }

        /* Removed Old Headers */
        .hood-header, .hood-header::before, .hud-line, .tape-header, .tape-strip, .tape-text, .street-sign-header, .sign-board, .radio-faceplate-header, .faceplate-body { display: none; }
        .header-title { display: none; }

        /* Removed Old Headers */
        .hood-header, .hood-header::before, .hud-line, .tape-header, .tape-strip, .tape-text, .street-sign-header, .sign-board { display: none; }
        .header-title { display: none; }
            position: absolute;
            bottom: 0;
            left: 25%; 
            right: 25%;
            height: 2px;
            background: linear-gradient(90deg, transparent, #4af626, transparent);
            box-shadow: 0 -2px 15px rgba(74, 246, 38, 0.6);
            opacity: 0.9;
        }

        /* Search Bar (LSPD Terminal - Minimal) */
        .search-container {
            margin-bottom: 15px;
            border: 1px solid var(--gta-green);
            background: #000;
            padding: 8px;
            display: flex;
            align-items: center;
            box-shadow: 0 0 10px rgba(63, 165, 53, 0.1);
            position: relative;
        }
        
        .search-container::after {
            content: 'LSPD_DB';
            position: absolute;
            right: 5px; top: -8px;
            background: #000;
            font-size: 10px; 
            color: var(--gta-green);
            padding: 0 4px;
            font-family: monospace;
        }
        
        .search-input {
            background: transparent;
            border: none;
            color: var(--gta-green);
            font-family: 'Courier New', monospace;
            font-size: 16px;
            width: 100%;
            outline: none;
            text-transform: uppercase;
            font-weight: bold;
            padding: 0;
            border-radius: 0;
        }
        .search-input::placeholder { color: #004400; }
        
        .search-label {
            color: var(--gta-green);
            font-family: 'Courier New', monospace;
            margin-right: 10px;
            font-weight: bold;
            display: block;
            font-size: 14px;
        }

        /* Map Zoom */
        /* District Selection Modal (GTA SA Style) */
        .district-modal {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 85%;
            max-width: 380px;
            background: rgba(0, 0, 0, 0.95);
            border: 4px solid var(--gta-gold);
            z-index: 1000;
            padding: 20px;
            text-align: center;
            box-shadow: 0 10px 50px rgba(0,0,0,1);
            animation: modalPop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        @keyframes modalPop {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        
        .district-header {
            font-family: 'Pricedown', sans-serif;
            font-size: 42px;
            color: var(--gta-gold);
            margin-bottom: 20px;
            text-shadow: 3px 3px 0 #000;
            letter-spacing: 2px;
            text-transform: uppercase;
        }
        
        .district-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 280px;
            overflow-y: auto;
            padding-right: 5px;
            margin-bottom: 15px;
        }

        .district-list::-webkit-scrollbar { width: 5px; }
        .district-list::-webkit-scrollbar-track { background: #111; }
        .district-list::-webkit-scrollbar-thumb { background: var(--gta-gold); }
        
        .district-item {
            background: #222;
            color: #fff;
            padding: 15px;
            font-family: 'Impact', sans-serif;
            font-size: 20px;
            letter-spacing: 1px;
            border-left: 6px solid #444;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }
        
        .district-item:hover {
            background: var(--gta-gold);
            color: #000;
            border-left-color: #fff;
            padding-left: 25px;
            transform: scale(1.02);
        }
        
        .district-item.grove { border-left-color: var(--gta-green); }
        .district-item.grove:hover { background: var(--gta-green); color: #fff; border-left-color: #fff; }
        
        .district-item.ballas { border-left-color: #d0a; }
        .district-item.ballas:hover { background: #d0a; color: #fff; border-left-color: #fff; }
        
        .district-item.vagos { border-left-color: #fb0; }
        .district-item.vagos:hover { background: #fb0; color: #000; border-left-color: #fff; }

        /* --- GTA SA SATELLITE MAP THEME --- */
        .map-container {
            position: relative;
            height: 450px;
            background-color: #0d161f; /* Deep ocean blue/black */
            overflow: hidden;
            border: 4px solid #000;
            font-family: 'Courier New', monospace;
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
        }

        /* 1. Grid Overlay (Moving) */
        .map-grid {
            position: absolute;
            top: -50%; left: -50%;
            width: 200%; height: 200%;
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 40px 40px;
            transform: perspective(500px) rotateX(20deg);
            animation: gridPan 20s linear infinite;
            pointer-events: none;
            z-index: 1;
        }

        @keyframes gridPan {
            0% { transform: perspective(500px) rotateX(20deg) translateY(0); }
            100% { transform: perspective(500px) rotateX(20deg) translateY(40px); }
        }

        /* 2. CRT Scanline */
        .scanline-bar {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 3px;
            background: rgba(0, 255, 0, 0.4);
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.6);
            animation: scanlineMove 4s linear infinite;
            z-index: 10;
            pointer-events: none;
        }

        @keyframes scanlineMove {
            0% { top: -10%; }
            100% { top: 110%; }
        }

        /* 3. Noise Overlay */
        .noise-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            opacity: 0.08;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
            pointer-events: none;
            z-index: 11;
            mix-blend-mode: overlay;
        }

        /* 4. Map Layers (Depth) */
        .map-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            transition: transform 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        /* Outline Layer (Thick Black) */
        .map-layer.outline path {
            stroke: #000;
            stroke-width: 60px;
            fill: none;
            stroke-linejoin: round;
        }
        
        /* Dark Terrain Layer (Shadow) */
        .map-layer.dark path {
            fill: #2a3a2a; 
            transform: translate(8px, 8px);
        }

        /* Mid Terrain Layer */
        .map-layer.mid path {
            fill: #3a4e3a;
            transform: translate(4px, 4px);
        }

        /* Top/Light Terrain Layer (Main) */
        .map-layer.main path {
            fill: #5c7a5c; /* GTA Grass Green */
            stroke: #1a2a1a;
            stroke-width: 2px;
        }

        /* 5. Radar Sweep */
        .radar-beam {
            position: absolute;
            top: 50%; left: 50%;
            width: 60%; height: 60%;
            background: conic-gradient(from 0deg, transparent 300deg, rgba(0, 255, 0, 0.2) 360deg);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            animation: radarRotate 4s linear infinite;
            pointer-events: none;
            z-index: 5;
        }
        
        @keyframes radarRotate {
            from { transform: translate(-50%, -50%) rotate(0deg); }
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }


        /* CRT Scanline Overlay */
        .map-container::before {
            content: "LSPD SAT-LINK ACTIVE [REC]";
            position: absolute;
            top: 15px;
            left: 15px;
            color: rgba(0, 255, 0, 0.7);
            font-family: 'Courier New', monospace;
            font-weight: bold;
            font-size: 14px;
            z-index: 20;
            pointer-events: none;
            animation: blinkText 2s infinite;
            text-shadow: 0 0 5px rgba(0, 255, 0, 0.5);
        }

        .map-container::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(
                0deg,
                rgba(0, 0, 0, 0.1),
                rgba(0, 0, 0, 0.1) 1px,
                transparent 1px,
                transparent 3px
            );
            pointer-events: none;
            z-index: 5;
        }

        /* Radar Sweep Animation */
        .radar-sweep {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 200%;
            height: 200%;
            transform: translate(-50%, -50%);
            background: conic-gradient(
                from 0deg, 
                transparent 0deg, 
                rgba(0, 255, 0, 0.05) 60deg, 
                rgba(0, 255, 0, 0.2) 90deg, 
                transparent 91deg
            );
            border-radius: 50%;
            animation: radarSpin 4s linear infinite;
            pointer-events: none;
            z-index: 2;
        }

        @keyframes radarSpin {
            from { transform: translate(-50%, -50%) rotate(0deg); }
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }
        
        @keyframes blinkText {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* The Land Mass (Lithuania) - Digital Outline */
        .map-img-interactive g {
            fill: #0f1f0f;
            stroke: #2a5c2a;
            stroke-width: 20px;
            filter: drop-shadow(0 0 10px rgba(0, 255, 0, 0.1));
            opacity: 0.8;
        }

        /* 6. Markers (GTA Icons) */
        .gta-marker {
            position: absolute;
            display: flex;
            align-items: center;
            transform: translate(-50%, -50%);
            cursor: pointer;
            z-index: 30;
            transition: transform 0.2s;
        }

        .gta-marker:hover {
            transform: translate(-50%, -50%) scale(1.1);
            z-index: 35;
        }

        .marker-icon {
            width: 36px; height: 36px;
            background: #f0f0f0;
            border: 2px solid #000;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 8px;
            box-shadow: 3px 3px 0 rgba(0,0,0,0.8);
            position: relative;
            
            /* Pulse Animation */
            animation: pulseGlow 3s infinite;
        }
        
        /* Specific Icon Images (SVGs embedded) */
        .marker-icon svg {
            width: 24px; height: 24px;
            fill: #000;
        }

        .marker-label {
            font-family: 'Pricedown', sans-serif;
            color: #fff;
            font-size: 22px;
            text-shadow: 2px 2px 0 #000, -1px -1px 0 #000;
            letter-spacing: 1px;
            white-space: nowrap;
        }

        /* Pulsing Blip */
        .blip-pulse {
            position: absolute;
            top: 50%; left: 50%;
            width: 10px; height: 10px;
            background: var(--gta-gold);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            animation: pulse 2s infinite;
            pointer-events: none;
            z-index: 29;
        }
        
        @keyframes pulse {
            0% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(4); opacity: 0; }
        }

        /* 7. Data Feed */
        .data-feed {
            background: #000;
            border-top: 2px solid #333;
            color: var(--gta-green);
            font-family: 'Courier New', monospace;
            font-size: 14px;
            padding: 8px 10px;
            white-space: nowrap;
            overflow: hidden;
            position: relative;
            text-transform: uppercase;
        }
        
        .data-scroll {
            display: inline-block;
            animation: marquee 20s linear infinite;
        }
        
        @keyframes marquee {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }
        
        /* 8. Slide-in District Menu (Replaces old Modal) */
        .district-menu-slide {
            position: absolute;
            top: 20px; right: -250px; /* Hidden right */
            width: 220px;
            background: rgba(0,0,0,0.95);
            border: 3px solid var(--gta-green);
            padding: 0;
            transition: right 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 50;
            box-shadow: -10px 10px 20px rgba(0,0,0,0.8);
            display: block !important; /* Override old display:none */
        }
        
        .district-menu-slide.active {
            right: 20px;
        }
        
        .dm-header {
            background: var(--gta-green);
            color: #000;
            font-family: 'Pricedown', sans-serif;
            font-size: 28px;
            padding: 10px;
            text-align: center;
            border-bottom: 2px solid #000;
        }
        
        .dm-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .dm-item {
            padding: 12px 15px;
            color: var(--gta-green);
            font-family: 'Impact', sans-serif;
            font-size: 18px;
            border-bottom: 1px solid #333;
            cursor: pointer;
            text-transform: uppercase;
            transition: 0.2s;
            display: flex;
            justify-content: space-between;
        }
        
        .dm-item:hover {
            background: var(--gta-green);
            color: #000;
            padding-left: 20px;
        }
        
        .dm-close {
            width: 100%;
            background: #333;
            color: #fff;
            border: none;
            padding: 10px;
            font-family: 'Impact', sans-serif;
            cursor: pointer;
            text-transform: uppercase;
        }
        .dm-close:hover { background: #555; }


        /* City Markers -> "Blips" */
        .district-marker {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: transparent;
            border: none;
            color: #e0e0e0;
            font-family: Arial, Helvetica, sans-serif; /* GTA Menu Font */
            font-weight: 900;
            text-shadow: 2px 2px 0 #000, -1px -1px 0 #000;
            font-size: 14px;
            letter-spacing: 1px;
            text-transform: uppercase;
            pointer-events: none; /* Let clicks pass to the blip */
            transform: translate(-50%, -50%);
            position: absolute;
            transition: 0.2s;
        }

        /* Pixel Art Icon Styles */
        .blip-icon {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid var(--gta-gold);
            border-radius: 6px;
            box-shadow: 0 0 15px rgba(0,0,0,0.8);
            margin-bottom: 5px;
            transition: transform 0.2s, border-color 0.2s, background-color 0.2s;
            pointer-events: auto;
            cursor: pointer;
        }
        
        .blip-icon:hover {
            transform: scale(1.3);
            background: var(--gta-gold);
            border-color: #fff;
            z-index: 30;
        }

        /* District Selection Modal (GTA SA Style) */
        .district-modal {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 85%;
            max-width: 380px;
            background: rgba(0, 0, 0, 0.95);
            border: 4px solid var(--gta-gold);
            z-index: 1000;
            padding: 20px;
            text-align: center;
            box-shadow: 0 10px 50px rgba(0,0,0,1);
            animation: modalPop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        @keyframes modalPop {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        
        .district-header {
            font-family: 'Pricedown', sans-serif;
            font-size: 42px;
            color: var(--gta-gold);
            margin-bottom: 20px;
            text-shadow: 3px 3px 0 #000;
            letter-spacing: 2px;
            text-transform: uppercase;
        }
        
        .district-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 280px;
            overflow-y: auto;
            padding-right: 5px;
            margin-bottom: 15px;
        }

        .district-list::-webkit-scrollbar { width: 5px; }
        .district-list::-webkit-scrollbar-track { background: #111; }
        .district-list::-webkit-scrollbar-thumb { background: var(--gta-gold); }
        
        .district-item {
            background: #222;
            color: #fff;
            padding: 15px;
            font-family: 'Impact', sans-serif;
            font-size: 20px;
            letter-spacing: 1px;
            border-left: 6px solid #444;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }
        
        .district-item:hover {
            background: var(--gta-gold);
            color: #000;
            border-left-color: #fff;
            padding-left: 25px;
            transform: scale(1.02);
        }
        
        .district-item.grove { border-left-color: var(--gta-green); }
        .district-item.grove:hover { background: var(--gta-green); color: #fff; border-left-color: #fff; }
        
        .district-item.ballas { border-left-color: #d0a; }
        .district-item.ballas:hover { background: #d0a; color: #fff; border-left-color: #fff; }
        
        .district-item.vagos { border-left-color: #fb0; }
        .district-item.vagos:hover { background: #fb0; color: #000; border-left-color: #fff; }

        .blip-icon:hover {
            transform: scale(1.5) rotate(90deg);
            background-color: #fff;
        }

        /* Fake "Crosshair" Cursor in center */
        .map-cursor {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 40px;
            height: 40px;
            border: 2px solid rgba(255,255,255,0.5);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 20;
        }
        .map-cursor::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 4px;
            height: 4px;
            background: #fff;
            transform: translate(-50%, -50%);
        }

        .map-img-interactive {
            width: 100%;
            height: 100%;
            object-fit: contain;
            transition: transform 1s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        .zone-poly {
            position: absolute;
            border: 2px solid var(--gta-green);
            background: rgba(63, 165, 53, 0.2);
            display: none;
            pointer-events: none;
        }

        
        /* Mission Passed Overlay */
        .mission-passed-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            z-index: 300;
            pointer-events: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        
        .mp-text {
            font-size: 64px;
            color: var(--gta-gold);
            text-shadow: 3px 3px 0 #000;
            transform: scale(0);
            transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .mp-sub {
            font-size: 32px;
            color: #fff;
            margin-top: 10px;
            opacity: 0;
            transition: opacity 0.5s delay 0.5s;
        }
        
        .mp-active .mp-text { transform: scale(1); }
        .mp-active .mp-sub { opacity: 1; }
        
        /* Map & Stats */
        .placeholder-box {
            background: rgba(0,0,0,0.6);
            padding: 20px;
            border: 2px solid var(--gta-gold);
            text-align: center;
            margin-top: 20px;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            margin: 10px 0;
            border-bottom: 1px solid #333;
            padding-bottom: 5px;
        }
        
        /* Filters - Grid Layout for Visibility */
        .filters {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
            padding-bottom: 5px;
            margin-bottom: 15px;
            width: 100%;
        }
        
        .filter-btn {
            background: rgba(0,0,0,0.8);
            border: 1px solid var(--gta-grey);
            color: #fff;
            padding: 8px 12px;
            font-family: 'Impact', sans-serif;
            font-size: 14px;
            white-space: nowrap;
            cursor: pointer;
            flex: 0 0 auto;
            transition: all 0.1s;
        }

        .filter-btn:active {
            transform: scale(0.95);
        }

        .filter-btn.back-btn {
            border-color: #a00;
            color: #aaa;
        }
        
        .filter-btn.active {
            background: var(--gta-gold);
            color: #000;
            border-color: var(--gta-gold);
        }
        
        .loading {
            text-align: center;
            font-size: 36px;
            color: var(--gta-gold);
            margin-top: 50px;
            animation: blink 1s infinite;
        }
        
        @keyframes blink { 50% { opacity: 0.5; } }

        /* Intro Screen */
        /* Preloader */
        #pre-loader {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #000;
            z-index: 200000;
            display: none; /* Default hidden (Fail-Open) */
            align-items: center;
            justify-content: center;
            font-family: 'Impact', sans-serif;
            font-size: 24px;
            color: #444;
            transition: opacity 0.5s;
        }

        /* Main Menu (High Fidelity GTA SA PC) */
        #intro-screen {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: #000;
            z-index: 100000;
            display: block; /* Changed from flex to allow absolute pos */
            transition: opacity 1s ease-out;
        }
        
        .vinewood-bg {
            display: block;
            position: absolute;
            top: 0; right: 0;
            width: 60%; height: 50%;
            background-image: url('https://upload.wikimedia.org/wikipedia/commons/thumb/a/a8/Vinewood_Sign_GTAV.png/640px-Vinewood_Sign_GTAV.png');
            background-size: contain;
            background-position: top right;
            background-repeat: no-repeat;
            -webkit-mask-image: linear-gradient(225deg, rgba(0,0,0,1) 40%, rgba(0,0,0,0) 80%);
            mask-image: linear-gradient(225deg, rgba(0,0,0,1) 40%, rgba(0,0,0,0) 80%);
            opacity: 0.7;
            pointer-events: none;
        }

        .menu-header {
            font-family: 'Diploma', 'Old English Text MT', 'UnifrakturMaguntia', cursive;
            font-size: 70px;
            color: #fff;
            text-shadow: 3px 3px 0 #000;
            position: absolute;
            top: 50px; left: 50px;
            margin: 0;
            line-height: 1;
            text-align: left;
        }

        .menu-options {
            position: absolute;
            bottom: 15%; left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            width: 100%;
        }

        .start-btn {
            font-family: 'Impact', 'Arial Black', sans-serif;
            font-size: 36px;
            color: #a0a0a0; /* Silver */
            background: none;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            display: block;
            font-weight: normal;
            text-transform: uppercase;
            letter-spacing: 2px;
            transform: scaleX(1.1);
        }
        
        .start-btn:hover {
            color: #fff;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
            transform: scaleX(1.1) scale(1.1);
        }
        
        .menu-item-dummy {
            font-family: 'Impact', 'Arial Black', sans-serif;
            font-size: 36px;
            color: #444; /* Dark Grey */
            text-transform: uppercase;
            letter-spacing: 2px;
            transform: scaleX(1.1);
            pointer-events: none;
        }

        /* High-End CSS Fog Wipe */
        .smoke-container {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 100005;
            pointer-events: none;
            display: none;
            overflow: hidden;
        }

        .fog-layer {
            position: absolute;
            top: 0; left: 0;
            width: 200%; height: 100%;
            background: linear-gradient(to right, 
                transparent 0%, 
                rgba(255, 255, 255, 0.2) 20%, 
                rgba(255, 255, 255, 0.9) 45%, 
                #fff 50%, 
                rgba(255, 255, 255, 0.9) 55%, 
                rgba(255, 255, 255, 0.2) 80%, 
                transparent 100%
            );
            transform: translateX(-100%);
            will-change: transform;
        }

        /* Layer variations for depth */
        .fog-layer:nth-child(1) { opacity: 1.0; z-index: 3; }
        .fog-layer:nth-child(2) { opacity: 0.6; height: 120%; top: -10%; left: -10%; z-index: 2; filter: blur(10px); }
        .fog-layer:nth-child(3) { opacity: 0.4; height: 140%; top: -20%; left: -5%; z-index: 1; filter: blur(20px); }

        @keyframes fogWipe {
            0% { transform: translateX(-100%); }
            45% { transform: translateX(-10%); } /* Hold slightly */
            55% { transform: translateX(10%); }
            100% { transform: translateX(100%); }
        }

        .smoke-active .fog-layer {
            animation: fogWipe 2.5s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }
        
        .smoke-active .fog-layer:nth-child(2) { animation-duration: 2.6s; }
        .smoke-active .fog-layer:nth-child(3) { animation-duration: 2.7s; }

        /* Video Bars */
        .cinematic-bar {
            position: fixed;
            left: 0;
            width: 100%;
            height: 12vh; /* 12% height */
            background: #000;
            z-index: 100002; /* Above video */
            transition: transform 0.5s ease-out;
            pointer-events: none;
        }
        .bar-top { top: 0; transform: translateY(-100%); }
        .bar-bottom { bottom: 0; transform: translateY(100%); }
        
        .video-mode .bar-top { transform: translateY(0); }
        .video-mode .bar-bottom { transform: translateY(0); }
        
        #video-intro {
            background: #000; /* Ensure black background behind video */
        }

        /* Full Screen Modals */
        .modal-3d {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 99999;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        /* Terminal Style */
        .terminal-box {
            border: 2px solid var(--gta-green);
            padding: 20px;
            background: rgba(0, 20, 0, 0.95);
            width: 90%;
            max-width: 400px;
            font-family: 'Courier New', monospace;
            box-shadow: 0 0 20px rgba(63, 165, 53, 0.2);
            text-align: center;
        }
        
        .stat-bar-container {
            background: #333;
            height: 15px;
            width: 150px;
            border: 2px solid #000;
            margin-left: auto;
        }
        .stat-bar-fill {
            height: 100%;
            background: var(--gta-green);
        }

        /* Character Overlay - OPTIMIZED */
        .char-overlay {
            position: fixed;
            bottom: 0; 
            right: 0; 
            width: 350px;
            height: 500px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: bottom right;
            z-index: 9000;
            transform: translateX(100%); 
            transition: transform 0.6s cubic-bezier(0.22, 1, 0.36, 1);
            pointer-events: none;
            /* Removed expensive filter: drop-shadow */
        }
        
        .char-visible {
            transform: translateX(0); 
        }
        
        .char-bubble {
            position: absolute;
            bottom: 300px; 
            right: 50px; 
            width: auto;
            background: transparent;
            border: none;
            color: var(--gta-gold);
            padding: 0;
            font-family: 'Pricedown', sans-serif;
            font-size: 48px;
            line-height: 0.9;
            text-shadow: 3px 3px 0 #000; /* Keep hard shadow, cheap */
            -webkit-text-stroke: 1px #000;
            opacity: 0;
            transform: scale(0.5) rotate(-5deg);
            transition: opacity 0.4s, transform 0.4s; /* Removed complex bezier for performance */
            pointer-events: auto;
            text-align: right;
        }
        
        .char-visible .char-bubble {
            opacity: 1;
            transform: scale(1) rotate(0deg);
            transition-delay: 0.3s;
        }

        /* Cinematic Video Frame - OPTIMIZED */
        .video-frame-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 3;
            pointer-events: none;
            /* Replaced box-shadow with cheaper gradient */
            background: radial-gradient(circle, transparent 50%, rgba(0,0,0,0.9) 100%);
        }

        /* Animations */
        @keyframes popIn {
            0% { opacity: 0; transform: scale(0.8) translateY(20px); }
            100% { opacity: 1; transform: scale(1) translateY(0); }
        }

        .product-card {
            /* ... existing styles ... */
            animation: popIn 0.6s cubic-bezier(0.22, 1, 0.36, 1) backwards;
        }

        /* Wasted Overlay */
        .wasted-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 100001; /* Above everything */
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: grayscale(100%) contrast(1.2) blur(2px);
            animation: wastedFade 2s ease-out;
        }
        @keyframes wastedFade { from { opacity: 0; } to { opacity: 1; } }
        
        .wasted-text {
            font-family: 'Pricedown', sans-serif;
            font-size: 80px;
            color: #fff; /* GTA Wasted is usually white/grey with black outline, rarely red in older ones */
            text-shadow: 4px 4px 0 #000;
            background: rgba(0,0,0,0.7);
            padding: 10px 40px;
            border-radius: 10px;
            transform: scale(0);
            animation: wastedPop 0.5s 0.5s forwards cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes wastedPop { to { transform: scale(1); } }

        /* Graffiti Tags */
        .graffiti {
            position: absolute;
            width: 60px;
            height: 40px;
            opacity: 0.4;
            cursor: pointer;
            transition: 0.3s;
            z-index: 5;
            filter: brightness(0.5) sepia(1);
        }
        .graffiti:hover { transform: scale(1.1); opacity: 0.8; }
        .graffiti.found {
            opacity: 1;
            filter: brightness(1) sepia(0) hue-rotate(90deg); /* Greenish */
            pointer-events: none;
        }

        /* 3D Tilt Context */
        .product-grid {
            perspective: 1000px;
        }
        .product-card {
            transform-style: preserve-3d;
            /* existing styles... */
        }

        /* --- GTA SA SATELLITE MAP THEME (OVERRIDE) --- */
        .map-container {
            position: relative;
            height: 450px;
            background-color: #0d161f;
            overflow: hidden;
            border: 4px solid #000;
            font-family: 'Courier New', monospace;
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
        }

        .map-grid {
            position: absolute;
            top: -50%; left: -50%;
            width: 200%; height: 200%;
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 40px 40px;
            transform: perspective(500px) rotateX(20deg);
            animation: gridPan 20s linear infinite;
            pointer-events: none;
            z-index: 1;
        }

        @keyframes gridPan {
            0% { transform: perspective(500px) rotateX(20deg) translateY(0); }
            100% { transform: perspective(500px) rotateX(20deg) translateY(40px); }
        }

        .scanline-bar {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 3px;
            background: rgba(0, 255, 0, 0.4);
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.6);
            animation: scanlineMove 4s linear infinite;
            z-index: 10;
            pointer-events: none;
        }

        @keyframes scanlineMove {
            0% { top: -10%; }
            100% { top: 110%; }
        }

        .noise-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            opacity: 0.08;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
            pointer-events: none;
            z-index: 11;
            mix-blend-mode: overlay;
        }

        .map-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            transition: transform 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        .map-layer.outline path {
            stroke: #000;
            stroke-width: 60px;
            fill: none;
            stroke-linejoin: round;
        }
        
        .map-layer.dark path {
            fill: #2a3a2a; 
            transform: translate(8px, 8px);
        }

        .map-layer.mid path {
            fill: #3a4e3a;
            transform: translate(4px, 4px);
        }

        .map-layer.main path {
            fill: #5c7a5c; 
            stroke: #1a2a1a;
            stroke-width: 2px;
        }

        .radar-beam {
            position: absolute;
            top: 50%; left: 50%;
            width: 60%; height: 60%;
            background: conic-gradient(from 0deg, transparent 300deg, rgba(0, 255, 0, 0.2) 360deg);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            animation: radarRotate 4s linear infinite;
            pointer-events: none;
            z-index: 5;
        }
        
        @keyframes radarRotate {
            from { transform: translate(-50%, -50%) rotate(0deg); }
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }

        .gta-marker {
            position: absolute;
            display: flex;
            align-items: center;
            transform: translate(-50%, -50%);
            cursor: pointer;
            z-index: 30;
            transition: transform 0.2s;
        }

        .gta-marker:hover {
            transform: translate(-50%, -50%) scale(1.1);
            z-index: 35;
        }

        .marker-icon {
            width: 36px; height: 36px;
            background: #f0f0f0;
            border: 2px solid #000;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 8px;
            box-shadow: 3px 3px 0 rgba(0,0,0,0.8);
            position: relative;
            
            /* Pulse Animation */
            animation: pulseGlow 3s infinite;
        }
        
        .marker-icon svg {
            width: 24px; height: 24px;
            fill: #000;
        }

        .marker-label {
            font-family: 'Pricedown', sans-serif;
            color: #fff;
            font-size: 22px;
            text-shadow: 2px 2px 0 #000, -1px -1px 0 #000;
            letter-spacing: 1px;
            white-space: nowrap;
        }

        .blip-pulse {
            position: absolute;
            top: 50%; left: 50%;
            width: 10px; height: 10px;
            background: var(--gta-gold);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            animation: pulse 2s infinite;
            pointer-events: none;
            z-index: 29;
        }
        
        @keyframes pulse {
            0% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(4); opacity: 0; }
        }

        .data-feed {
            background: #000;
            border-top: 2px solid #333;
            color: var(--gta-green);
            font-family: 'Courier New', monospace;
            font-size: 14px;
            padding: 8px 10px;
            white-space: nowrap;
            overflow: hidden;
            position: relative;
            text-transform: uppercase;
        }
        
        .data-scroll {
            display: inline-block;
            animation: marquee 20s linear infinite;
        }
        
        @keyframes marquee {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }
        
        .district-menu-slide {
            position: absolute;
            top: 20px; right: -250px; 
            width: 220px;
            background: rgba(0,0,0,0.95);
            border: 3px solid var(--gta-green);
            padding: 0;
            transition: right 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 50;
            box-shadow: -10px 10px 20px rgba(0,0,0,0.8);
            display: block !important; 
        }
        
        .district-menu-slide.active {
            right: 20px;
        }
        
        .dm-header {
            background: var(--gta-green);
            color: #000;
            font-family: 'Pricedown', sans-serif;
            font-size: 28px;
            padding: 10px;
            text-align: center;
            border-bottom: 2px solid #000;
        }
        
        .dm-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .dm-item {
            padding: 12px 15px;
            color: var(--gta-green);
            font-family: 'Impact', sans-serif;
            font-size: 18px;
            border-bottom: 1px solid #333;
            cursor: pointer;
            text-transform: uppercase;
            transition: 0.2s;
            display: flex;
            justify-content: space-between;
        }
        
        .dm-item:hover {
            background: var(--gta-green);
            color: #000;
            padding-left: 20px;
        }
        
        .dm-close {
            width: 100%;
            background: #333;
            color: #fff;
            border: none;
            padding: 10px;
            font-family: 'Impact', sans-serif;
            cursor: pointer;
            text-transform: uppercase;
        }
        .dm-close:hover { background: #555; }
        /* --- HACKER SIGNAL TRACKER THEME (TACTICAL) --- */
        .map-container {
            position: relative;
            height: 550px;
            background-color: #050505 !important; 
            overflow: hidden;
            border: none !important;
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.6) !important;
        }
        
        .satellite-view {
            background-color: #080a08;
            background-image: radial-gradient(#1a2a1a 1.5px, transparent 1.5px);
            background-size: 24px 24px;
            position: relative;
            
            /* FLAT & CLEAN */
            transform: none;
            transform-origin: center center;
            transition: transform 1.2s var(--spring-smooth);
            border: none;
            border-radius: 24px;
            box-shadow: inset 0 0 80px rgba(0,0,0,0.9);
            overflow: hidden;
        }
        
        /* Zooming removes tilt for clarity */
        .satellite-view.zoomed {
            transform: rotateX(0deg) scale(1);
        }
        
        /* Scanline Effect */
        .satellite-view::before {
            content: '';
            position: absolute;
            top: 0; left: 0; width: 100%; height: 2px;
            background: rgba(0, 255, 0, 0.3);
            box-shadow: 0 0 5px #0f0;
            animation: scanDown 3s linear infinite;
            z-index: 5;
            pointer-events: none;
        }
        
        @keyframes scanDown {
            0% { top: -10%; opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { top: 110%; opacity: 0; }
        }

        /* Map Outline (Digital) */
        .map-layer path {
            stroke: #004400; 
            stroke-width: 1px;
            fill: #000800; 
            vector-effect: non-scaling-stroke;
        }

        /* --- SIGNAL EMITTERS (CITIES) --- */
        .city-pin {
            position: absolute;
            transform: translate(-50%, -50%);
            width: 80px; height: 80px;
            display: flex;
            align-items: center; justify-content: center;
            cursor: pointer;
            z-index: 100;
            transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        .pin-core {
            width: 12px; height: 12px;
            background: #0f0;
            border-radius: 50%;
            box-shadow: 0 0 15px #0f0;
            z-index: 2;
            transition: all 0.3s;
        }
        
        .pin-pulse {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 100%; height: 100%;
            border: 2px solid rgba(0, 255, 0, 0.5);
            border-radius: 50%;
            animation: pulseRipple 2s infinite;
            box-sizing: border-box;
        }
        
        .pin-pulse::after {
            content: '';
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 100%; height: 100%;
            border: 1px solid rgba(0, 255, 0, 0.3);
            border-radius: 50%;
            animation: pulseRipple 2s infinite 0.6s;
            box-sizing: border-box;
        }
        
        @keyframes pulseRipple {
            0% { width: 10%; height: 10%; opacity: 1; border-width: 4px; }
            100% { width: 100%; height: 100%; opacity: 0; border-width: 0px; }
        }
        
        .city-label {
            position: absolute;
            top: 55px;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(0, 255, 0, 0.3);
            border-radius: 12px;
            color: #0f0;
            padding: 6px 12px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            font-weight: bold;
            white-space: nowrap;
            pointer-events: none;
            text-shadow: 0 0 5px rgba(0, 255, 0, 0.5);
            letter-spacing: 1px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            transition: all 0.3s var(--spring-smooth);
        }
        
        /* Hover State */
        .city-pin:hover .pin-core {
            background: #fff;
            box-shadow: 0 0 25px #fff;
            transform: scale(1.2);
        }
        
        /* FOCUS MODE (Apple Style) */
        .satellite-view:has(.city-pin:hover) .city-pin:not(:hover) {
            opacity: 0.4;
            filter: blur(1px);
            transform: translate(-50%, -50%) scale(0.9);
            transition: all 0.3s var(--spring-smooth);
        }
        
        .city-pin:hover .city-label {
            background: #0f0;
            color: #000;
            text-shadow: none;
        }
        
        .city-pin:hover .pin-pulse {
            animation-duration: 1s;
            border-color: #fff;
        }
        
        .scanner-text {
            display: none;
            position: absolute;
            top: 20px; left: 20px;
            color: #0f0;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            font-weight: bold;
            background: rgba(0,0,0,0.7);
            padding: 5px 10px;
            border: 1px solid #0f0;
            animation: blinkText 2s infinite;
            z-index: 10;
            pointer-events: none;
        }
        @keyframes blinkText { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        /* Clean Slide-in Menu */
        .district-menu-slide {
            background: rgba(0,0,0,0.95) !important;
            border-left: 4px solid #f0c330 !important;
            box-shadow: -10px 0 30px rgba(0,0,0,0.8) !important;
        }
        
        .dm-header {
            background: #f0c330 !important;
            color: #000 !important;
            border-bottom: 4px solid #000 !important;
            font-size: 32px !important;
        }
        
        .dm-item {
            background: #222 !important;
            color: #fff !important;
            border: 2px solid #444 !important;
            font-family: 'Impact', sans-serif !important;
        }
        
        .dm-item:hover {
            background: #f0c330 !important;
            color: #000 !important;
            border-color: #fff !important;
        }
        /* Ensure single-layer SVG fallback looks perfect */
        .map-img-interactive g path {
            fill: #383838 !important;
            stroke: #000 !important;
            stroke-width: 30px !important;
            stroke-linejoin: round !important;
            stroke-linecap: round !important;
        }
        
        /* Hide any previous broken layers if they exist */
        .map-layer { display: contents; } 
        /* --- GTA V SATELLITE NIGHT MODE --- */
        .satellite-view {
            width: 100%; height: 100%;
            background: #0f161e; /* Deep Ocean Blue */
            position: relative;
            overflow: hidden;
            font-family: 'Arial', sans-serif;
        }

        /* Background Effects */
        .sat-bg {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23ffffff' fill-opacity='0.03' fill-rule='evenodd'/%3E%3C/svg%3E");
            opacity: 0.5;
        }

        .sat-grid {
            position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background-image: linear-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(255, 255, 255, 0.05) 1px, transparent 1px);
            background-size: 100px 100px;
            transform: perspective(1000px) rotateX(20deg);
            pointer-events: none;
        }

        .sat-vignette {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, transparent 40%, #000 100%);
            pointer-events: none;
            z-index: 10;
        }

        /* Zoom Layer */
        .map-zoom-layer {
            width: 100%; height: 100%;
            transition: transform 1.2s var(--spring-smooth);
            transform-origin: center center;
        }

        /* Map SVG Styling */
        .map-img-interactive {
            width: 100%; height: 100%;
            filter: drop-shadow(0 0 15px rgba(0,0,0,0.8));
        }
        
        .map-img-interactive g path {
            fill: #1c242d !important; /* Dark Land */
            stroke: #384452 !important; /* Lighter Outline */
            stroke-width: 15px !important;
            vector-effect: non-scaling-stroke;
        }

        /* Blips */
        .sat-blip {
            position: absolute;
            transform: translate(-50%, -50%);
            cursor: pointer;
            z-index: 20;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: opacity 0.5s;
        }

        .satellite-view.zoomed .sat-blip { opacity: 0; pointer-events: none; }

        .blip-dot {
            width: 12px; height: 12px;
            background: #fff;
            border-radius: 50%;
            box-shadow: 0 0 10px #fff;
        }

        .blip-ring {
            position: absolute; top: 50%; left: 50%;
            width: 40px; height: 40px;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            animation: blipPulse 2s infinite;
        }

        @keyframes blipPulse { 0% { transform: translate(-50%, -50%) scale(0.5); opacity: 1; } 100% { transform: translate(-50%, -50%) scale(1.5); opacity: 0; } }

        .blip-label {
            margin-top: 8px;
            color: #fff;
            font-size: 12px;
            font-weight: bold;
            text-shadow: 0 0 5px #000;
            opacity: 0.7;
            transition: 0.3s;
        }

        .sat-blip:hover .blip-label { opacity: 1; text-shadow: 0 0 10px #fff; }

        /* HUD */
        .sat-hud {
            position: absolute; bottom: 20px; left: 20px; right: 20px;
            display: flex; justify-content: space-between; align-items: flex-end;
            z-index: 30;
            pointer-events: none;
        }

        .hud-coords {
            font-family: 'Courier New', monospace;
            color: rgba(255,255,255,0.5);
            font-size: 12px;
        }

        .hud-reset {
            background: rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.3);
            color: #fff;
            padding: 5px 10px;
            font-family: 'Arial', sans-serif;
            font-size: 10px;
            cursor: pointer;
            pointer-events: auto;
            text-transform: uppercase;
            transition: 0.3s;
            opacity: 0; /* Hidden by default */
        }
        
        .satellite-view.zoomed .hud-reset { opacity: 1; pointer-events: auto; }

        /* --- CLOUD LAYERS & GLITCH --- */
        .sat-clouds {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 12;
            pointer-events: none;
            opacity: 0.3;
            background: url('https://raw.githubusercontent.com/marcoguglie/css-smoke-effect/master/smoke.png'); 
            background-size: cover;
            animation: drift 60s linear infinite;
            mix-blend-mode: overlay;
        }
        
        .sat-clouds.layer2 {
            z-index: 13;
            opacity: 0.15;
            background-position: 100px 50px;
            animation: drift 40s linear infinite reverse;
        }

        @keyframes drift { from { background-position: 0 0; } to { background-position: 100% 0; } }

        /* Glitch Effect on SVG when zooming */
        .satellite-view.glitching .map-img-interactive {
            animation: rgbSplit 0.4s steps(5);
        }
        
        @keyframes rgbSplit {
            0% { transform: translate(0); }
            25% { transform: translate(-3px, 3px); filter: drop-shadow(-3px 0 0 rgba(255,0,0,0.7)) drop-shadow(3px 0 0 rgba(0,0,255,0.7)); }
            50% { transform: translate(3px, -3px); filter: drop-shadow(3px 0 0 rgba(255,0,0,0.7)) drop-shadow(-3px 0 0 rgba(0,0,255,0.7)); }
            75% { transform: translate(-2px, 0); }
            100% { transform: translate(0); }
        }



        /* District Panel (Reuse existing, ensure it looks good) */
        .district-panel {
            background: #0a0a0a !important;
            border-left: 2px solid #fff !important;
        }
        
        .dm-item {
            font-family: 'Courier New', monospace !important;
            border: 1px solid #333 !important;
            margin-bottom: 5px !important;
            background: #111 !important;
        }
        .dm-item:hover {
            background: #fff !important;
            color: #000 !important;
        }
        /* --- DISTRICT POLYGON SYSTEM --- */
        .district-polygons {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.5s ease 0.3s;
            z-index: 15;
        }
        
        .satellite-view.zoomed .district-polygons {
            opacity: 1;
            pointer-events: auto;
        }
        
        .district-polygons svg {
            width: 100%; height: 100%;
        }
        
        .district-poly {
            fill: #1a1a1a;
            stroke: #333;
            stroke-width: 2px;
            cursor: pointer;
            transition: all 0.3s ease;
            opacity: 0;
            transform-origin: center;
        }
        
        .satellite-view.zoomed .district-poly {
            opacity: 1;
        }
        
        /* Stock Status Colors */
        .district-poly.has-stock {
            fill: rgba(46, 125, 50, 0.6); /* Green */
            stroke: #4caf50;
            stroke-width: 3px;
        }
        
        .district-poly.no-stock {
            fill: rgba(50, 50, 50, 0.6); /* Grey */
            stroke: #555;
        }
        
        .district-poly.hot-zone {
            fill: rgba(255, 193, 7, 0.5); /* Gold - Featured */
            stroke: #ffc107;
            stroke-width: 3px;
            animation: hotPulse 2s infinite;
        }
        
        @keyframes hotPulse {
            0%, 100% { fill: rgba(255, 193, 7, 0.4); }
            50% { fill: rgba(255, 193, 7, 0.7); }
        }
        
        .district-poly:hover {
            fill: rgba(255, 255, 255, 0.3) !important;
            stroke: #fff !important;
            stroke-width: 4px !important;
            filter: drop-shadow(0 0 10px rgba(255,255,255,0.5));
        }
        
        /* District Label */
        .district-label {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #fff;
            padding: 8px 12px;
            color: #fff;
            font-family: 'Impact', sans-serif;
            font-size: 14px;
            text-transform: uppercase;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 100;
            white-space: nowrap;
            transform: translate(-50%, -100%);
            margin-top: -10px;
        }
        
        .district-label.visible {
            opacity: 1;
        }
        
        .district-label .stock-count {
            display: block;
            font-size: 11px;
            color: #4caf50;
            margin-top: 2px;
        }
        
        .district-label .stock-count.empty {
            color: #666;
        }
        
        /* City District Containers */
        .city-districts {
            display: none;
        }
        
        .city-districts.active {
            display: block;
        }

        /* --- BURNER PHONE UI (UPGRADED - APPLE GLASS) --- */
        .phone-container {
            position: fixed;
            bottom: -120%; left: 50%;
            transform: translateX(-50%);
            width: 320px;
            height: 640px;
            max-height: 90vh;
            
            /* GLASSMOPHISM */
            background: var(--glass-bg);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            
            border-radius: 36px 36px 0 0;
            
            /* Refined Borders */
            border: 1px solid rgba(255,255,255,0.08);
            border-bottom: none;
            
            box-shadow: 
                0 -30px 80px rgba(0,0,0,0.9),
                inset 0 1px 0 rgba(255,255,255,0.15);
                
            z-index: 20000;
            transition: bottom 0.7s var(--spring-bounce);
            
            display: flex;
            flex-direction: column;
            padding: 20px;
            padding-top: 40px; 
            box-sizing: border-box;
        }
        
        .phone-container::before {
            /* Antenna Stub */
            content: '';
            position: absolute;
            top: -30px; right: 20px;
            width: 25px; height: 40px;
            background: #111;
            border-radius: 5px 5px 0 0;
            border: 4px solid #222;
            border-bottom: none;
            z-index: -1;
        }
        
        .phone-speaker {
            position: absolute;
            top: 15px; left: 50%;
            transform: translateX(-50%);
            width: 60px; height: 8px;
            background: repeating-linear-gradient(90deg, #000, #000 2px, #444 2px, #444 3px);
            border-radius: 4px;
            border: 1px solid #000;
        }
        
        .phone-container.active {
            bottom: 0;
        }

        
        .phone-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .phone-screen {
            background: #8b9616; /* Richer LCD Green */
            border: 8px solid #000;
            border-radius: 6px;
            height: 240px;
            padding: 10px;
            font-family: 'Courier New', monospace;
            color: #111;
            display: flex;
            flex-direction: column;
            box-shadow: 
                inset 0 0 20px rgba(0,0,0,0.6),
                0 0 0 2px #333; /* Plastic rim */
            position: relative;
            overflow: hidden;
        }
        
        /* Screen Backlight Flicker & Scanlines */
        .phone-screen::after {
            content: '';
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: 
                repeating-linear-gradient(0deg, rgba(0,0,0,0.08), rgba(0,0,0,0.08) 1px, transparent 1px, transparent 2px),
                radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 80%);
            pointer-events: none;
            animation: screenFlicker 4s infinite;
        }
        
        @keyframes screenFlicker {
            0% { opacity: 0.9; }
            95% { opacity: 0.9; }
            96% { opacity: 0.8; }
            97% { opacity: 0.95; }
            98% { opacity: 0.85; }
            100% { opacity: 0.9; }
        }
        
        .status-bar {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            font-weight: bold;
            border-bottom: 2px solid #111;
            padding-bottom: 4px;
            margin-bottom: 8px;
            opacity: 0.8;
        }
        
        .screen-header {
            background: #111;
            color: #8b9616;
            text-align: center;
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 8px;
            padding: 2px 0;
            text-transform: uppercase;
        }
        
        .contact-list {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 4px;
            scrollbar-width: none;
        }
        
        .contact-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 8px;
            cursor: pointer;
            font-size: 15px;
            font-weight: bold;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            
            transition: transform 0.1s var(--spring-smooth), background 0.2s;
            animation: slideInStagger 0.4s var(--spring-bounce) backwards;
        }
        
        .contact-item:active {
             transform: scale(0.96);
        }
        
        .contact-item:hover, .contact-item.selected {
            background: rgba(17, 17, 17, 0.1);
        }
        
        .contact-item .signal {
            font-family: monospace;
            font-weight: normal;
        }
        
        .dialing-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            display: none; /* Hidden by default */
        }
        
        .dialing-screen.active {
            display: flex;
        }
        
        .dial-text {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            animation: blink 1s infinite;
        }
        
        .dial-number {
            font-size: 24px;
            letter-spacing: 2px;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }
        
        .phone-keypad {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .key-row {
            display: flex;
            justify-content: space-between;
            gap: 10px;
        }
        
        .key-btn {
            flex: 1;
            background: linear-gradient(to bottom, #ddd, #bbb);
            color: #000;
            padding: 12px 0;
            text-align: center;
            border-radius: 8px;
            font-weight: bold;
            font-family: sans-serif;
            cursor: pointer;
            border-bottom: 4px solid #888;
            box-shadow: 0 4px 5px rgba(0,0,0,0.3);
            font-size: 14px;
            transition: transform 0.05s;
        }
        
        .key-btn.call {
            background: linear-gradient(to bottom, #66bb6a, #43a047);
            color: #fff;
            border-bottom-color: #2e7d32;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }
        
        .key-btn.end {
            background: linear-gradient(to bottom, #ef5350, #e53935);
            color: #fff;
            border-bottom-color: #b71c1c;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }
        
        .key-btn:active {
            transform: translateY(4px);
            border-bottom-width: 0px;
            box-shadow: none;
        }
        
        .key-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        
        .num-key {
            background: linear-gradient(to bottom, #333, #222);
            color: #fff;
            text-align: center;
            padding: 10px 0;
            border-radius: 6px;
            font-family: sans-serif;
            font-weight: bold;
            border-bottom: 3px solid #000;
            cursor: pointer;
            font-size: 18px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        .num-key:active {
            transform: translateY(3px);
            border-bottom-width: 0px;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.5);
        }

        /* --- CINEMATIC HANDOFF THEME --- */
        .character-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); /* Dim background */
            z-index: 25000;
            display: none; /* Hidden by default */
            pointer-events: none;
        }
        
        .character-overlay.active {
            display: block;
            pointer-events: auto;
        }
        
        /* Character Cutout */
        .char-body {
            position: absolute;
            bottom: -100%; 
            left: 50%; 
            transform: translateX(-50%);
            
            /* Image Sizing */
            width: auto;
            height: 85vh;
            max-height: 600px;
            max-width: 90vw;
            
            object-fit: contain;
            object-position: bottom center;
            
            transition: bottom 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 1;
            filter: drop-shadow(0 10px 30px rgba(0,0,0,0.8));
            pointer-events: none;
        }
        
        .character-overlay.active .char-body {
            bottom: 0; /* Slide up to bottom */
            animation: characterBounce 0.5s ease-out 0.8s; /* Bounce after slide */
        }
        
        @keyframes characterBounce {
            0%, 100% { transform: translateX(-50%) translateY(0); }
            50% { transform: translateX(-50%) translateY(-20px); }
        }
        
        /* Dialogue Box (Comic Style) */
        .char-dialogue-box {
            position: absolute;
            top: 15%; 
            left: 50%;
            transform: translateX(-50%) scale(0.8);
            width: 85%;
            max-width: 350px;
            background: #fff;
            border: 4px solid #000;
            padding: 15px 20px;
            font-family: 'Impact', sans-serif;
            font-size: 18px;
            color: #000;
            border-radius: 5px;
            opacity: 0;
            transition: all 0.5s 0.6s; /* Delay after character appears */
            z-index: 3;
            box-shadow: 8px 8px 0 rgba(0,0,0,0.6);
        }
        
        .char-dialogue-box::after {
            content: '';
            position: absolute;
            bottom: -18px; 
            left: 50%;
            transform: translateX(-50%);
            border-width: 18px 18px 0;
            border-style: solid;
            border-color: #000 transparent transparent;
            display: block;
            width: 0;
        }
        
        .char-dialogue-box::before {
            content: '';
            position: absolute;
            bottom: -14px; 
            left: 50%;
            transform: translateX(-50%);
            border-width: 14px 14px 0;
            border-style: solid;
            border-color: #fff transparent transparent;
            display: block;
            width: 0;
            z-index: 1;
        }
        
        .character-overlay.active .char-dialogue-box {
            opacity: 1;
            transform: translateX(-50%) scale(1);
        }
        
        .char-name {
            color: var(--gta-green);
            font-size: 13px;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: bold;
        }
        
        .char-dialogue {
            line-height: 1.3;
        }

        /* Hide old digital avatar elements */
        .avatar-frame, .avatar-name { display: none !important; }
        /* --- NEW POLISH --- */
        .touch-ripple {
            position: absolute;
            width: 20px; height: 20px;
            background: rgba(255, 255, 255, 0.4);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            animation: rippleExpand 0.6s ease-out;
            pointer-events: none;
            z-index: 50;
        }
        @keyframes rippleExpand {
            to { width: 200px; height: 200px; opacity: 0; }
        }
        
        /* Film Grain */
        .satellite-view::after {
            content: '';
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.05'/%3E%3C/svg%3E");
            pointer-events: none;
            opacity: 0.3;
            z-index: 4;
        }
    </style>
</head>
<body>
    <!-- Wasted Overlay -->
    <div id="wasted-overlay" class="wasted-overlay" onclick="closeWasted()">
        <div class="wasted-text">WASTED</div>
    </div>
    

    <div id="pre-loader">LOADING SYSTEM...</div>
    <script>
        // Progressive Enhancement: Only show loader if JS is working
        var pl = document.getElementById('pre-loader');
        pl.style.display = 'flex';
        
        // CRITICAL FAILSAFE: Force hide after 3s even if main JS crashes
        setTimeout(function(){
            pl.style.display = 'none';
        }, 3000);
    </script>

    <!-- Cinematic Bars -->
    <div class="cinematic-bar bar-top"></div>
    <div class="cinematic-bar bar-bottom"></div>

    <!-- Fog Wipe Transition -->
    <div id="smoke-overlay" class="smoke-container">
        <div class="fog-layer"></div>
        <div class="fog-layer"></div>
        <div class="fog-layer"></div>
    </div>

    <!-- Intro Screen (Main Menu) -->
    <div id="intro-screen">
        <div class="vinewood-bg"></div>
        <div class="menu-header">Main<br>Menu</div>
        
        <div class="menu-options">
            <button class="start-btn" onclick="startApp()">START GAME</button>
            <div class="menu-item-dummy">OPTIONS</div>
            <div class="menu-item-dummy">QUIT GAME</div>
        </div>
    </div>


    <!-- Character Layer -->
    <div id="char-layer" class="char-overlay">
        <div id="char-text" class="char-bubble">WELCOME!</div>
    </div>

    <!-- Audio Elements -->
    <!-- Minimal Radio Pill -->
    <div class="radio-pill" onclick="toggleRadio()">
        <span class="radio-icon-small"></span>
        <span class="radio-text-scroll" id="radio-display">RADIO OFF</span>
    </div>

    <div class="bg"></div>
    <div class="scanlines"></div>

    <!-- Spray Paint Header -->
    <div class="app-header spray-header" id="spray-header">
        <div class="spray-text">LOS LITHUANIA</div>
        <div class="drip d1"></div>
        <div class="drip d2"></div>
        <div class="drip d3"></div>
    </div>

    <!-- Mission Passed Overlay -->
    <div class="mission-passed-overlay" id="mp-overlay" style="display:none;">
        <div class="mp-text">MISSION PASSED!</div>
        <div class="mp-sub">RESPECT +</div>
    </div>


    <!-- Basket Modal -->
    <div id="basket-modal" class="modal-3d" style="display:none;">
        <div class="terminal-box" style="height: 85vh; display:flex; flex-direction:column; text-align:left;">
            <div style="border-bottom: 2px solid var(--gta-green); padding-bottom:10px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
                <span style="font-size:24px; color:var(--gta-gold);">AMMUNATION CART</span>
                <button style="background:#900; color:#fff; border:1px solid #fff; font-family:'Courier New'; cursor:pointer;" onclick="closeBasket()">[X]</button>
            </div>
            
            <div id="basket-items" style="flex:1; overflow-y:auto; border:1px solid #333; padding:10px; margin-bottom:10px;">
                <!-- Items go here -->
            </div>
            
            <!-- Discount Section -->
            <div style="margin-bottom: 10px; padding: 10px; border: 1px dashed #555;">
                <div style="display:flex; gap: 5px;">
                    <input type="text" id="discount-input" placeholder="ENTER PROMO CODE" style="flex:1; background:#000; color:#fff; border:1px solid #555; padding:8px; font-family:'Courier New'; text-transform:uppercase;">
                    <button onclick="applyDiscount()" style="background:#333; color:#fff; border:1px solid #fff; padding:0 15px; cursor:pointer; font-family:'Pricedown', serif; font-size:14px;">APPLY</button>
                </div>
                <div id="discount-msg" style="font-size:12px; margin-top:5px; color:#aaa; height:14px;"></div>
            </div>

            <div style="border-top: 2px solid var(--gta-green); padding-top:10px;">
                <!-- Price Breakdown -->
                <div id="price-breakdown" style="font-size:14px; margin-bottom:10px; color:#aaa;">
                    <!-- JS will populate -->
                </div>
                
                <div style="display:flex; justify-content:space-between; font-size:24px; margin-bottom:15px; font-weight:bold;">
                    <span>TOTAL:</span>
                    <span id="basket-total" style="color:var(--gta-green);">$0.00</span>
                </div>
                <button class="btn-buy" onclick="initCheckout()" style="width:100%;">INITIATE TRANSFER (SOL)</button>
            </div>
        </div>
    </div>

    <!-- District Selection Modal (New) -->
    <div id="district-modal" class="modal-3d" style="display:none; align-items:center; justify-content:center; z-index: 50000;">
        <div class="terminal-box" style="width: 90%; max-width: 400px; text-align: center; padding: 20px;">
            <div style="border-bottom: 2px solid var(--gta-green); padding-bottom:10px; margin-bottom:15px; font-size:24px; color:var(--gta-gold); font-family: 'Pricedown';">
                SELECT DISTRICT
            </div>
            <div id="district-modal-header" style="margin-bottom: 15px; color: #aaa; font-family: 'Impact'; font-size: 18px;">
                CITY
            </div>
            <div id="district-modal-content" style="display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; padding-bottom: 20px; max-height: 50vh; overflow-y: auto;">
                <!-- Buttons go here -->
            </div>
            <button onclick="closeDistrictModal()" style="background:#900; color:#fff; border:1px solid #fff; padding:10px 20px; font-family:'Pricedown'; width:100%; cursor:pointer; font-size: 18px;">CANCEL</button>
        </div>
    </div>

    <!-- Invoice Modal -->
    <div id="invoice-modal" class="modal-3d" style="display:none;">
        <div class="terminal-box">
            <div style="color:var(--gta-gold); font-size:20px; border-bottom:1px dashed var(--gta-green); padding-bottom:10px; margin-bottom:20px;">
                SECURE TRANSACTION TERMINAL
            </div>
            
            <div style="margin-bottom:20px;">
                <div style="font-size:12px; color:#aaa;">AMOUNT DUE:</div>
                <div id="invoice-amount" style="font-size:32px; color:var(--gta-green); margin:5px 0; cursor:pointer;" onclick="copyText('invoice-amount')">0.00 SOL</div>
                <div style="font-size:10px; color:#555;">(CLICK TO COPY)</div>
            </div>
            
            <div id="qrcode" style="background:#fff; padding:10px; display:inline-block; margin-bottom:20px; border:2px solid var(--gta-green);"></div>
            
            <div style="margin-bottom:20px; text-align:left;">
                <div style="font-size:12px; color:#aaa;">DESTINATION ADDRESS:</div>
                <div id="invoice-address" style="font-size:12px; word-break:break-all; background:#111; padding:10px; border:1px solid #333; color:#fff; margin-top:5px; cursor:pointer;" onclick="copyText('invoice-address')">...</div>
                <div style="font-size:10px; color:#555; text-align:center;">(CLICK TO COPY)</div>
            </div>
            
            <div class="loading" style="font-size:14px;">AWAITING CONFIRMATION<span class="blink">...</span></div>
            
            <button class="btn-buy" style="margin-top:20px; background:#300; border-color:#900;" onclick="closeInvoice()">CANCEL OPERATION</button>
        </div>
    </div>

    <!-- Review Modal -->
    <div id="review-modal" class="modal-3d" style="display:none;">
        <div class="terminal-box" style="max-width:350px;">
            <div style="font-size:24px; color:var(--gta-gold); margin-bottom:20px;">TRANSACTION COMPLETE</div>
            <div style="margin-bottom:20px;">RATE SERVICE:</div>
            <div style="margin-bottom:20px; font-size:32px; cursor:pointer;" id="review-stars">
                <span onclick="setReview(1)"></span>
                <span onclick="setReview(2)"></span>
                <span onclick="setReview(3)"></span>
                <span onclick="setReview(4)"></span>
                <span onclick="setReview(5)"></span>
            </div>
            <textarea id="review-text" placeholder="FEEDBACK (OPTIONAL)..." style="width:100%; height:80px; background:#111; color:var(--gta-green); border:1px solid var(--gta-green); font-family:'Courier New'; padding:10px; margin-bottom:20px; box-sizing:border-box; outline:none;"></textarea>
            <button class="btn-buy" onclick="submitReview()">SUBMIT & CLOSE</button>
        </div>
    </div>

    <div class="content">
        <!-- Video Intro -->
        <div id="video-intro" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:#000; z-index:99990; align-items:center; justify-content:center;">
            <div class="video-frame-overlay"></div> <!-- CINEMATIC OVERLAY -->
            <div id="video-loading" style="position:absolute; color:#555; font-family:'Courier New'; z-index:1;">BUFFERING...</div>
            <video id="intro-vid" style="width:100%; height:100%; object-fit:contain; position:relative; z-index:2; transform: translateZ(0); will-change: transform;" playsinline webkit-playsinline preload="auto" muted>
                <source src="/webapp/intro.mp4" type="video/mp4">
            </video>
            <div id="play-overlay" style="display:none; position:absolute; z-index:4; color:#fff; border:2px solid #fff; padding:10px 20px; cursor:pointer; background:rgba(0,0,0,0.7);" onclick="forcePlayVideo()">[ RETRY PLAY ]</div>
            <div style="position:absolute; bottom:20px; right:20px; color:rgba(255,255,255,0.5); font-family:'Courier New'; font-size:12px; cursor:pointer; z-index:4; border:1px solid #555; padding:5px; background:rgba(0,0,0,0.5);" onclick="skipIntro()">[ SKIP INTRO ]</div>
        </div>

        <!-- SHOP SECTION -->
        <div id="shop" class="section active">
            <!-- LSPD Search -->
            <div class="search-container">
                <span class="search-label">LSPD DATABASE > SEARCH:</span>
                <input type="text" class="search-input" placeholder="ENTER SUSPECT/ITEM NAME..." oninput="filterSearch(this.value)">
            </div>

            <div class="filters" id="city-filters">
                <button class="filter-btn active" onclick="filterProducts('all')">ALL ZONES</button>
            </div>
            <div class="product-grid" id="product-grid">
                <div class="loading" id="stock-loader">
                    LOADING STOCK...
                    <br><br>
                    <button onclick="loadProducts()" style="font-size:16px; background:#333; color:#fff; border:1px solid #fff; padding:5px 10px; cursor:pointer;">[ FORCE RELOAD ]</button>
                </div>
            </div>
        </div>

        <!-- MAP SECTION -->
        <div id="map" class="section">
            <div class="placeholder-box" style="padding: 0; border: none;">
                <div class="map-container" id="map-container">
                    <div class="satellite-view">
                        <div class="scanner-text">SCANNING NETWORK...</div>
                        <div class="sat-bg"></div>
                        <div class="sat-grid"></div>
                        <div class="sat-clouds"></div>
                        <div class="sat-clouds layer2"></div>
                        <div class="sat-vignette"></div>
                        <div class="sat-scanline"></div>
                        <div class="map-zoom-layer" id="map-zoom-layer">
                    <svg id="map-img" class="map-img-interactive" viewBox="0 0 1024 1024" preserveAspectRatio="xMidYMid meet">
                        <defs>
                            <!-- PAPER MAP TEXTURE -->
                            <pattern id="city-texture" width="60" height="60" patternUnits="userSpaceOnUse">
                                <!-- Land Base -->
                                <rect width="60" height="60" fill="#3e4348"/> <!-- GTA Dark Grey Land -->
                                
                                <!-- Roads (Light Grey Lines) -->
                                <path d="M 30 0 L 30 60 M 0 30 L 60 30" stroke="#52575d" stroke-width="3" fill="none"/>
                                <path d="M 0 0 L 60 60" stroke="#52575d" stroke-width="1" fill="none" opacity="0.5"/>
                                
                                <!-- City Blocks (Lighter Grey Areas) -->
                                <rect x="5" y="5" width="20" height="20" fill="#2d3236"/>
                                <rect x="35" y="35" width="20" height="20" fill="#2d3236"/>
                                
                                <!-- Parks (Green Patches) -->
                                <rect x="35" y="5" width="15" height="15" fill="#5a6e5a" opacity="0.8"/>
                            </pattern>
                        </defs>
                        <g transform="translate(0,1024) scale(0.1,-0.1)">
                            <!-- Fill with Grid, Stroke with Neon Green -->
                            <path d="M6713 9109 c-27 -17 -33 -27 -33 -57 0 -33 -1 -34 -14 -17 -13 19
-16 18 -66 -13 -28 -18 -63 -32 -78 -32 -50 0 -67 -11 -96 -60 -17 -28 -39
-51 -52 -54 -46 -12 -105 -75 -143 -151 l-36 -76 -102 -35 -102 -35 -81 41
c-44 22 -100 43 -124 46 -39 6 -50 2 -122 -43 -43 -27 -105 -59 -137 -72 l-57
-23 -83 26 c-61 19 -105 43 -172 91 -49 36 -106 76 -125 90 -33 23 -48 25
-183 31 l-147 7 0 27 0 28 -65 -6 c-50 -3 -75 -1 -104 13 l-38 17 -64 -47
c-45 -33 -69 -45 -83 -40 -12 3 -59 12 -106 20 -47 7 -141 33 -210 58 -121 42
-127 43 -180 32 -30 -6 -79 -20 -108 -30 -47 -17 -52 -22 -52 -49 0 -27 -9
-37 -72 -78 -84 -54 -88 -54 -148 26 -32 43 -40 61 -40 96 0 38 -5 48 -49 89
-85 80 -104 92 -140 81 -33 -9 -98 -56 -143 -102 -17 -18 -36 -28 -55 -28 -17
0 -56 -9 -89 -20 -73 -26 -104 -20 -152 30 -25 25 -63 48 -120 70 l-82 32 -98
-12 c-57 -7 -158 -11 -247 -8 -135 4 -160 8 -246 36 -121 40 -245 45 -294 11
-62 -42 -207 -110 -258 -120 -38 -8 -63 -21 -92 -49 -22 -21 -53 -42 -70 -46
-16 -4 -55 -19 -85 -34 -50 -24 -62 -26 -132 -21 -82 6 -140 -1 -146 -18 -11
-32 -51 -76 -77 -84 -16 -5 -65 -36 -108 -69 l-79 -60 -76 11 c-85 13 -87 12
-96 -54 -6 -38 -13 -45 -85 -94 l-79 -53 -12 -77 c-25 -171 -33 -194 -65 -203
-17 -4 -66 -3 -113 4 -73 11 -86 10 -110 -4 -24 -15 -28 -25 -33 -85 -4 -37
-7 -113 -8 -168 -1 -73 -8 -125 -27 -195 -24 -88 -25 -104 -18 -215 4 -66 6
-179 5 -250 -3 -119 -1 -135 22 -185 13 -30 34 -64 46 -74 35 -32 71 -125 96
-251 13 -67 38 -151 55 -188 21 -48 38 -112 55 -210 30 -183 26 -268 -17 -346
-28 -51 -61 -141 -52 -141 2 0 23 12 46 26 40 25 42 26 55 8 7 -10 13 -32 13
-49 0 -18 9 -58 20 -90 26 -74 26 -101 0 -108 -16 -4 -20 -14 -20 -47 0 -38 2
-41 23 -34 12 4 38 17 57 30 47 33 118 33 146 2 41 -47 73 -106 79 -149 7 -44
7 -45 68 -67 34 -12 81 -22 104 -22 24 0 64 -8 91 -18 66 -25 197 -116 218
-151 19 -31 91 -71 130 -71 16 0 35 -11 52 -32 15 -17 58 -46 100 -65 61 -28
85 -33 146 -33 42 0 79 -5 89 -13 10 -7 21 -35 26 -66 10 -60 33 -85 89 -96
39 -7 63 9 82 56 7 16 22 32 35 35 21 5 244 0 502 -12 128 -5 132 -5 170 19
61 40 97 43 142 14 l38 -26 5 -88 c3 -48 11 -112 18 -141 10 -46 16 -55 52
-73 32 -16 50 -19 89 -14 47 7 48 6 55 -21 4 -16 17 -36 28 -45 17 -14 18 -19
7 -33 -19 -23 -6 -34 98 -85 l90 -44 3 -86 c2 -47 0 -121 -6 -165 l-9 -78 -41
-18 c-26 -11 -53 -34 -74 -64 -18 -25 -39 -46 -47 -46 -8 0 -26 -4 -40 -10
-26 -10 -26 -10 -9 -39 17 -29 17 -30 -14 -56 -30 -25 -32 -32 -32 -88 0 -34
-5 -100 -11 -147 -6 -47 -12 -121 -14 -165 -1 -44 -10 -109 -19 -145 -25 -104
-21 -160 17 -238 19 -37 50 -110 70 -162 51 -130 50 -130 81 -101 13 13 30 35
36 51 9 21 20 29 48 34 63 10 101 7 140 -13 20 -10 63 -26 94 -35 49 -14 57
-20 63 -46 8 -36 24 -46 88 -55 53 -8 56 -14 26 -41 -45 -41 -43 -50 20 -88
40 -25 71 -36 97 -36 22 0 48 -7 58 -15 11 -8 28 -15 37 -15 11 0 29 -20 46
-52 24 -44 34 -53 73 -64 25 -8 70 -14 101 -14 65 0 74 -6 125 -85 21 -33 65
-87 97 -120 l58 -60 52 -207 c48 -194 50 -208 35 -225 -10 -10 -26 -47 -37
-81 l-19 -63 24 -16 c18 -12 24 -24 24 -53 l0 -37 74 -21 c56 -17 88 -33 127
-67 48 -41 57 -44 88 -39 20 4 58 18 84 31 41 20 53 22 85 13 54 -15 59 -13
71 20 12 35 16 36 59 10 37 -23 66 -19 167 20 49 19 52 19 110 2 46 -13 80
-16 146 -12 85 5 86 5 139 53 36 32 58 46 69 41 9 -3 43 -16 76 -27 75 -26 82
-31 91 -70 7 -31 51 -107 63 -107 3 0 23 5 43 10 31 9 42 8 63 -6 14 -9 43
-20 65 -24 39 -7 39 -7 157 104 65 62 136 123 158 135 22 13 52 37 66 54 25
29 30 30 90 28 41 -1 74 4 91 13 26 14 29 13 43 -7 8 -12 15 -34 15 -49 0 -33
5 -34 65 -8 26 11 66 20 90 20 41 0 44 2 59 40 10 26 16 70 16 122 0 76 -3 88
-40 159 l-40 77 28 10 c18 6 34 23 46 51 18 38 22 41 58 41 22 0 73 14 113 31
l74 31 57 -46 c62 -51 59 -50 118 -35 36 9 56 26 135 115 94 106 119 152 136
252 6 37 10 42 34 42 15 0 50 -7 77 -15 44 -13 58 -13 132 2 70 13 86 20 100
42 43 68 85 111 109 111 26 0 71 -44 145 -142 l36 -49 -39 -36 -40 -36 22 -23
22 -23 -26 -10 c-31 -12 -44 -50 -27 -82 7 -12 17 -42 24 -66 6 -25 14 -44 19
-44 4 1 60 1 126 1 116 0 119 0 156 30 21 16 47 30 58 30 11 0 39 11 63 25 48
28 48 31 60 198 l6 99 -37 54 c-21 30 -50 63 -65 74 -18 13 -31 35 -39 65
l-11 45 -79 -41 c-83 -44 -130 -51 -183 -30 -27 10 -28 14 -28 76 0 62 4 74
71 203 57 112 70 143 66 172 -5 40 16 173 33 210 7 15 31 34 60 46 66 30 120
108 120 175 0 61 -23 123 -60 165 -42 48 -42 109 1 187 l31 57 -21 62 c-34
100 -23 178 23 178 7 0 26 10 41 22 25 20 27 25 21 72 -3 28 -9 78 -11 111
l-6 60 60 45 c48 36 63 54 76 93 25 73 66 90 220 91 l120 1 95 49 c52 27 97
53 99 59 2 6 27 45 56 87 34 50 54 91 59 120 4 25 11 68 16 95 5 28 9 73 9
101 1 47 5 55 36 83 39 34 81 40 145 21 19 -6 64 -14 99 -19 63 -8 63 -8 73
20 14 42 39 44 115 8 74 -34 137 -50 168 -43 11 3 31 21 44 41 20 32 23 45 19
103 -4 55 -1 74 16 107 30 58 92 123 129 135 41 14 100 57 128 92 l22 28 -20
26 c-30 40 -60 52 -136 52 -54 0 -75 4 -94 20 -33 26 -88 26 -148 0 l-47 -20
-90 25 c-80 22 -117 43 -118 68 0 4 20 44 44 90 24 45 50 107 56 137 16 69 44
131 68 154 19 16 19 18 -4 74 -38 92 -30 137 31 194 46 42 54 79 55 245 l0
131 -27 6 c-16 3 -57 11 -93 17 -36 7 -85 23 -109 37 -34 20 -61 27 -113 29
-66 2 -70 4 -136 57 -98 78 -222 254 -222 317 0 8 -18 39 -39 68 -29 39 -61
65 -123 100 -66 38 -93 60 -131 111 -30 40 -65 74 -95 90 -106 60 -290 195
-345 256 -33 35 -95 92 -139 126 -82 63 -118 116 -118 172 0 34 -40 48 -115
40 -61 -6 -64 -6 -111 30 l-48 37 -30 -29 -31 -29 -155 9 c-121 6 -166 13
-205 29 -33 14 -86 25 -155 30 -58 5 -116 11 -130 15 -47 13 -89 52 -101 97
-21 78 -70 172 -113 217 -39 41 -45 55 -70 158 -29 116 -114 343 -131 349 -6
1 -25 -7 -42 -18z" fill="url(#city-texture)" stroke="#1f2429" stroke-width="30"/>
                        </g>
                    </svg>
                    
                            <!-- Signal Emitters -->
                            <div class="city-pin" style="top: 75%; left: 80%;" onclick="zoomToCity('Vilnius', 75, 80)">
                                <div class="pin-core"></div>
                                <div class="pin-pulse"></div>
                                <div class="city-label">SIGNAL: VILNIUS</div>
                            </div>
                            <div class="city-pin" style="top: 60%; left: 55%;" onclick="zoomToCity('Kaunas', 60, 55)">
                                <div class="pin-core"></div>
                                <div class="pin-pulse"></div>
                                <div class="city-label">SIGNAL: KAUNAS</div>
                            </div>
                            <div class="city-pin" style="top: 35%; left: 10%;" onclick="zoomToCity('Klaipeda', 35, 10)">
                                <div class="pin-core"></div>
                                <div class="pin-pulse"></div>
                                <div class="city-label">SIGNAL: KLAIPEDA</div>
                            </div>
                            <div class="city-pin" style="top: 30%; left: 60%;" onclick="zoomToCity('Panevezys', 30, 60)">
                                <div class="pin-core"></div>
                                <div class="pin-pulse"></div>
                                <div class="city-label">SIGNAL: PANEVEZYS</div>
                            </div>
                            
                            <!-- District Polygon Overlays -->
                            <div class="district-polygons">
                                <!-- VILNIUS DISTRICTS -->
                                <svg class="city-districts" id="districts-vilnius" viewBox="0 0 100 100" preserveAspectRatio="none">
                                    <polygon class="district-poly" data-city="Vilnius" data-district="Senamiestis" 
                                        points="68,68 72,65 75,68 74,73 70,74 67,72" />
                                    <polygon class="district-poly" data-city="Vilnius" data-district="Naujamiestis" 
                                        points="65,72 68,70 72,73 71,78 66,77 64,74" />
                                    <polygon class="district-poly" data-city="Vilnius" data-district="Zirmunai" 
                                        points="72,63 77,61 80,64 79,68 74,69 71,66" />
                                    <polygon class="district-poly" data-city="Vilnius" data-district="Antakalnis" 
                                        points="75,67 80,65 84,68 82,73 77,72 74,70" />
                                    <polygon class="district-poly" data-city="Vilnius" data-district="Fabijoniskes" 
                                        points="66,62 70,59 74,62 73,66 68,67 65,65" />
                                    <polygon class="district-poly" data-city="Vilnius" data-district="Pilaite" 
                                        points="60,68 64,65 68,68 67,73 62,74 59,71" />
                                </svg>
                                
                                <!-- KAUNAS DISTRICTS -->
                                <svg class="city-districts" id="districts-kaunas" viewBox="0 0 100 100" preserveAspectRatio="none">
                                    <polygon class="district-poly" data-city="Kaunas" data-district="Centras" 
                                        points="48,53 52,50 56,53 55,58 50,59 47,56" />
                                    <polygon class="district-poly" data-city="Kaunas" data-district="Zaliakalnis" 
                                        points="52,48 57,45 61,48 59,53 54,54 51,51" />
                                    <polygon class="district-poly" data-city="Kaunas" data-district="Silainiai" 
                                        points="42,52 46,49 50,52 49,57 44,58 41,55" />
                                    <polygon class="district-poly" data-city="Kaunas" data-district="Dainava" 
                                        points="48,58 53,55 57,58 55,63 50,64 47,61" />
                                    <polygon class="district-poly" data-city="Kaunas" data-district="Aleksotas" 
                                        points="44,58 48,55 52,58 51,63 46,64 43,61" />
                                </svg>
                                
                                <!-- KLAIPEDA DISTRICTS -->
                                <svg class="city-districts" id="districts-klaipeda" viewBox="0 0 100 100" preserveAspectRatio="none">
                                    <polygon class="district-poly" data-city="Klaipeda" data-district="Senamiestis" 
                                        points="13,28 17,25 21,28 20,33 15,34 12,31" />
                                    <polygon class="district-poly" data-city="Klaipeda" data-district="Baltija" 
                                        points="14,33 18,30 22,33 21,38 16,39 13,36" />
                                    <polygon class="district-poly" data-city="Klaipeda" data-district="Melnrage" 
                                        points="10,25 14,22 18,25 17,30 12,31 9,28" />
                                </svg>
                            </div>
                            
                            <!-- Floating District Label -->
                            <div id="district-hover-label" class="district-label">
                                <span class="district-name">DISTRICT</span>
                                <span class="stock-count">0 ITEMS</span>
                            </div>
                        </div> <!-- End Zoom Layer -->
                        
                        <div class="sat-hud">
                            <div class="hud-coords">SAT-LINK: ACTIVE</div>
                            <button class="hud-reset" onclick="resetSatelliteView()">RESET VIEW</button>
                        </div>
                    </div>

                    <!-- District Panel -->
                    <div id="district-panel" class="district-panel">
                        <div class="panel-header" id="panel-header">SELECT ZONE</div>
                        <div class="panel-list" id="panel-list"></div>
                        <button class="panel-close" onclick="closePanel()" style="position:absolute; top:10px; right:10px; background:red; border:none; color:white; width:30px; height:30px; border-radius:50%;">X</button>
                    </div>
                </div>
                <button class="btn-buy" onclick="resetMap()" style="margin-top: 10px;">RESET VIEW</button>
            </div>
        </div>

        <!-- STATS SECTION with Character Selection -->
        <div id="stats" class="section">
            <div class="placeholder-box">
                <div style="font-size: 32px; margin-bottom: 20px; color: var(--gta-gold);">PLAYER STATS</div>
                <div style="display: flex; gap: 20px; align-items: center; justify-content: center; margin-bottom: 20px;">
                    <img src="https://placehold.co/150x200/000000/3fa535?text=CJ" id="char-img" style="height: 150px; border: 2px solid #fff;">
                    <div>
                        <button class="filter-btn" onclick="changeSkin('cj')">CJ</button>
                        <button class="filter-btn" onclick="changeSkin('sweet')">SWEET</button>
                        <button class="filter-btn" onclick="changeSkin('ryder')">RYDER</button>
                    </div>
                </div>
                <div class="stat-row" style="align-items:center;">
                    <span>RESPECT</span>
                    <div class="stat-bar-container"><div class="stat-bar-fill" style="width:100%"></div></div>
                </div>
                <div class="stat-row" style="align-items:center;">
                    <span>STAMINA</span>
                    <div class="stat-bar-container"><div class="stat-bar-fill" style="width:70%"></div></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation -->
    <div class="bottom-nav">
        <div class="nav-item active" id="nav-shop" onclick="sfx.select(); showSection('shop')">
            <div class="nav-icon"><svg viewBox="0 0 24 24" width="24" height="24"><path fill="currentColor" d="M20 6h-4V4c0-1.11-.89-2-2-2h-4c-1.11 0-2 .89-2 2v2H4c-1.11 0-2 .89-2 2v11c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zM10 4h4v2h-4V4zm10 13H4V8h16v9z"/></svg></div>
            <span>SHOP</span>
        </div>
        <div class="nav-item" id="nav-map" onclick="sfx.select(); showSection('map')">
            <div class="nav-icon"><svg viewBox="0 0 24 24" width="24" height="24"><path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg></div>
            <span>MAP</span>
        </div>
        <div class="nav-item" id="nav-stats" onclick="sfx.select(); showSection('stats')">
            <div class="nav-icon"><svg viewBox="0 0 24 24" width="24" height="24"><path fill="currentColor" d="M10 20h4V4h-4v16zm-6 0h4v-8H4v8zM16 9v11h4V9h-4z"/></svg></div>
            <span>STATS</span>
        </div>
        <div class="nav-item" id="nav-basket" onclick="sfx.select(); openBasket()">
            <div class="nav-icon"><svg viewBox="0 0 24 24" width="24" height="24"><path fill="currentColor" d="M19 6h-2c0-2.76-2.24-5-5-5S7 3.24 7 6H5c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm-7-3c1.66 0 3 1.34 3 3H9c0-1.66 1.34-3 3-3zm7 15H5V8h14v10z"/></svg></div>
            <span>CART <span id="basket-count" style="color:var(--gta-gold)">(0)</span></span>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        
        // Global Error Handler
        window.onerror = function(msg, url, line, col, error) {
            const grid = document.getElementById('product-grid');
            if(grid && grid.innerHTML.includes('LOADING')) {
                grid.innerHTML = '<div class="loading" style="color:red">CRITICAL ERROR<br><small>Line ' + line + ': ' + msg + '</small><br><button onclick="location.reload()" style="background:#333;color:#fff;border:1px solid #fff;padding:8px;cursor:pointer;">RELOAD APP</button></div>';
            }
            console.error('Global Error:', msg, line, error);
            return false;
        };
        
        function log(msg) { 
            // Disabled
        }

        // --- GLOBAL STATE (Moved to top to prevent TDZ errors) ---
        let allProducts = [];
        let currentStation = 0;
        const stations = [
            { name: "RADIO OFF", src: null },
            { name: "RADIO LOS SANTOS", src: "https://ais-sa2.cdnstream1.com/2442_128.mp3" },
            { name: "PLAYBACK FM", src: "https://stream.zeno.fm/f3wvbbqcd08uv" },
            { name: "K-DST", src: "https://ice6.somafm.com/secretagent-128-mp3" },
            { name: "BOUNCE FM", src: "https://stream-mixtape-geo.ntslive.co.uk/mixtape2" },
            { name: "SF-UR", src: "https://ice1.somafm.com/groovesalad-128-mp3" },
            { name: "K-JAH WEST", src: "https://stream.zeno.fm/0r0xa792kwzuv" },
            { name: "MASTER SOUNDS", src: "https://stream.zeno.fm/mn05058392zuv" }
        ];
        // Use persistent player
        let audioPlayer = document.getElementById('global-audio-player');
        let basket = [];
        let activePaymentId = null;
        let pollInterval = null;
        tg.expand();
        tg.MainButton.hide();
        
        // --- Sound FX System (Synthesized) ---
        const charSystem = {
            el: null,
            text: null,
            timer: null,
            
            init: function() {
                this.el = document.getElementById('char-layer');
                this.text = document.getElementById('char-text');
            },
            
            show: function(charName, message, duration=4000) {
                if(!this.el) this.init();
                
                let url = "https://upload.wikimedia.org/wikipedia/en/c/ce/Carl_Johnson_GTA_SA.png"; 
                if(charName === 'ryder') url = "https://upload.wikimedia.org/wikipedia/en/3/3f/Ryder_GTA_SA.png"; 
                if(charName === 'smoke') url = "https://upload.wikimedia.org/wikipedia/en/1/17/Big_Smoke_GTA_SA.png";
                
                this.el.style.backgroundImage = `url('${url}')`;
                this.text.innerText = message;
                
                this.el.classList.add('char-visible');
                
                if(this.timer) clearTimeout(this.timer);
                this.timer = setTimeout(() => {
                    this.el.classList.remove('char-visible');
                }, duration);
            }
        };

        const sfx = {
            ctx: null,
            // ... (keep sfx object)
            init: function() {
                if(!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)();
            },
            playTone: function(freq, type, duration, vol=0.1) {
                this.init();
                if(this.ctx.state === 'suspended') this.ctx.resume();
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                gain.gain.setValueAtTime(vol, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start();
                osc.stop(this.ctx.currentTime + duration);
            },
            tick: function() { this.playTone(800, 'triangle', 0.05, 0.05); }, 
            select: function() { this.playTone(300, 'square', 0.1, 0.1); }, 
            cash: function() { 
                this.playTone(1200, 'sine', 0.1, 0.1); 
                setTimeout(() => this.playTone(1600, 'sine', 0.2, 0.1), 100);
            },
            wasted: function() { this.playTone(50, 'sawtooth', 1.0, 0.3); },
            spray: function() { this.playTone(400, 'sawtooth', 0.2, 0.05); }
        };

        // --- Day/Night Cycle ---
        function checkDayNight() {
            const hour = new Date().getHours();
            const isNight = hour < 6 || hour > 20;
            if(isNight) {
                document.querySelector('.bg').style.backgroundImage = "linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.9)), url('https://upload.wikimedia.org/wikipedia/commons/thumb/5/5a/Los_Angeles_night_lights.jpg/1280px-Los_Angeles_night_lights.jpg')";
            }
        }

        // 3D Tilt Disabled (Mobile Optimization)
        // Graffiti Hunt Disabled (Optimization)

        // --- Cheat Codes ---
        let keyBuffer = "";
        document.addEventListener('keydown', (e) => {
            keyBuffer += e.key.toLowerCase();
            if(keyBuffer.length > 20) keyBuffer = keyBuffer.slice(-20);
            
            if(keyBuffer.endsWith("hesoyam")) {
                activateCheat();
            }
        });
        
        function activateCheat() {
            sfx.cash();
            document.getElementById('money').innerText = "$25000000";
            document.getElementById('money').style.color = "#fff";
            charSystem.show('cj', "HESOYAM ACTIVATED!", 2000);
            // Reset color
            setTimeout(() => document.getElementById('money').style.color = "var(--gta-green)", 1000);
        }

        // --- Wasted Logic ---
        function triggerWasted() {
            const el = document.getElementById('wasted-overlay');
            el.style.display = 'flex';
            sfx.wasted();
            // Slow motion effect via CSS?
            document.body.style.transition = "filter 2s";
            document.body.style.filter = "grayscale(1)";
        }
        
        function closeWasted() {
            document.getElementById('wasted-overlay').style.display = 'none';
            document.body.style.filter = "none";
        }

        // --- Graffiti Scavenger Hunt (Disabled for performance) ---
        
        // --- Init New Systems ---
        checkDayNight();
        
        // ... existing logic ...

        // --- Character System ---
        // charSystem moved to top

        // Init
        function hideLoader() {
            const pl = document.getElementById('pre-loader');
            if(pl && pl.style.display !== 'none') {
                pl.style.opacity = '0';
                setTimeout(() => pl.style.display = 'none', 500);
            }
        }

        window.onload = () => {
            hideLoader();
            loadProducts(); // CRITICAL: Load Data
            try { sfx.init(); } catch(e) {} 
        };
        
        // FORCE LOAD: Backup trigger if onload fails or is overwritten
        setTimeout(() => {
            const grid = document.getElementById('product-grid');
            if(grid && grid.innerHTML.includes('LOADING')) {
                loadProducts();
            }
        }, 2000); // Increased to 2s to ensure DOM is ready
        
        // NUCLEAR OPTION: Force load after 5s no matter what
        setTimeout(() => {
            const grid = document.getElementById('product-grid');
            if(grid && grid.innerHTML.includes('LOADING')) {
                grid.innerHTML = '<div class="loading" style="color:orange">TIMEOUT<br><button onclick="loadProducts()" style="background:#333;color:#fff;border:1px solid #fff;padding:8px;cursor:pointer;font-family:\'Pricedown\',serif;">FORCE LOAD</button></div>';
            }
        }, 5000);
        
        // Failsafe: Force hide loader after 3 seconds max
        setTimeout(hideLoader, 3000);

        // Global Asset Preload (Removed to fix RefError)
        
        function startApp() {
            log("startApp called");
            
            // Unlock Audio Context
            if(window.AudioContext || window.webkitAudioContext) {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                ctx.resume();
            }
            
            // 1. Init Global Player (Persistent & Visible to DOM)
            audioPlayer = document.getElementById('global-audio-player');
            if(audioPlayer) {
                const station = stations[1]; 
                audioPlayer.src = station.src;
                audioPlayer.volume = 0.01; // Silent but PLAYING (Non-zero to prevent pause)
                currentStation = 1;     // Sync state
                
                // FORCE PLAY IMMEDIATELY
                const radioPromise = audioPlayer.play();
                if(radioPromise !== undefined) {
                    radioPromise.then(() => console.log("Radio Playing Silently"))
                                .catch(e => console.error("Radio Start Fail", e));
                }
            }
            
            // Init Audio Locally
            const audioFx = new Audio('/webapp/ah_shit.mp3');
            audioFx.preload = 'auto';
            
            try {
                const btn = document.querySelector('.start-btn');
                if(btn) {
                    // Flash White
                    btn.style.color = "#fff";
                    btn.style.textShadow = "0 0 20px #fff";
                    btn.style.pointerEvents = "none"; 
                }

                // 1. Smoke ON
                const smoke = document.getElementById('smoke-overlay');
                if(smoke) {
                    smoke.style.display = 'block';
                    void smoke.offsetWidth;
                    smoke.classList.add('smoke-active');
                    log("Smoke active");
                } else {
                    log("Smoke NOT found");
                }

                // 2. Audio
                audioFx.volume = 1.0;
                const p = audioFx.play();
                if(p !== undefined) {
                    p.catch(e => log("Audio error: " + e));
                }
                log("Audio requested");

                // 3. Video Prep
                const vid = document.getElementById('intro-vid');
                if(vid) {
                    vid.muted = true;
                    vid.preload = "auto";
                    log("Video prepped");
                } else {
                    log("Video element NOT found!");
                }

                // 4. Transition
                log("Waiting for audio end...");
                audioFx.onended = performTransition;
                setTimeout(() => {
                    if(document.getElementById('welcome-screen')) performTransition();
                }, 2000);

            } catch (err) {
                log("Start Crash: " + err);
                skipIntro(true);
            }
        }

        function performTransition() {
            log("performTransition called");
            try {
                // Fade In Radio (It's already playing silenty!)
                if(audioPlayer) {
                    // Ensure it's actually playing (Resume if paused by browser)
                    if(audioPlayer.paused) {
                        audioPlayer.play().catch(e => console.error("Resume fail", e));
                    }

                    // Ensure volume fade starts from low
                    let vol = 0.01;
                    const fade = setInterval(() => {
                        vol += 0.05;
                        if(vol >= 0.5) {
                            vol = 0.5;
                            clearInterval(fade);
                        }
                        // Only touch volume
                        if(audioPlayer) audioPlayer.volume = vol;
                    }, 200);

                    const radioText = document.getElementById('radio-display');
                    if(radioText) {
                        radioText.innerText = stations[1].name;
                        radioText.style.color = "var(--gta-green)";
                    }
                } else {
                    // If for some reason it's missing, try to start it
                    toggleRadio(true);
                }
                log("Radio toggled");

                // 1. Switch Content (Behind the Smoke Curtain)
                const menu = document.getElementById('intro-screen');
                if(menu) menu.style.opacity = '0'; // Hide menu

                // DIRECT TO SHOP (No Emoji)
                showSection('shop');
                charSystem.show('cj', "WELCOME TO THE SHOP!");
                log("Switched to Shop");

                // 2. Trigger Wipe OUT (Reveal)
                const smoke = document.getElementById('smoke-overlay');
                if(smoke) {
                    // Switch animation classes
                    smoke.classList.remove('smoke-active');
                    void smoke.offsetWidth; // Force reflow
                    smoke.classList.add('smoke-dissipate');
                    
                    log("Smoke dissipate triggered");

                    // Cleanup after animation
                    setTimeout(() => {
                        smoke.style.display = 'none';
                        smoke.classList.remove('smoke-dissipate');
                        if(menu) menu.style.display = 'none';
                        
                        // Final Cleanup
                        skipIntro();
                    }, 1500); // Match CSS animation duration
                } else {
                    // Fallback
                    skipIntro();
                }

            } catch (e) {
                log("Transition Error: " + e);
                skipIntro(true);
            }
        }

        function forcePlayVideo() {
            const vid = document.getElementById('intro-vid');
            document.getElementById('play-overlay').style.display = 'none';
            document.getElementById('video-loading').style.display = 'block';
            
            vid.muted = false;
            vid.play().then(() => {
                document.getElementById('video-loading').style.display = 'none';
            }).catch(e => {
                vid.muted = true;
                vid.play();
            });
        }
        
        function skipIntro(immediate = false) {
            log(`skipIntro called (immediate=${immediate})`);
            document.body.classList.remove('video-mode');
            toggleRadio(true); 

            // Ensure Emoji is gone just in case
            const emoji = document.getElementById('emoji-intro');
            if(emoji) emoji.style.display = 'none';

            showSection('shop'); 
            charSystem.show('cj', "WELCOME TO THE SHOP!");
        }

        // Globals moved to top to avoid TDZ


        // --- Logic ---

        // Navigation Logic
        function showSection(id) {
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            
            const sec = document.getElementById(id);
            if(sec) sec.classList.add('active');
            
            const nav = document.getElementById('nav-'+id);
            if(nav) nav.classList.add('active');
            
            // Update Header Zone (Spray Paint)
            const sprayText = document.querySelector('.spray-text');
            
            if(sprayText) {
                let txt = "LOS LITHUANIA";
                if(id === 'shop') txt = "AMMU-NATION";
                if(id === 'map') txt = "LOS SANTOS";
                if(id === 'stats') txt = "RESPECT";
                
                sprayText.innerText = txt;
            }
        }

        async function loadProducts() {
            const grid = document.getElementById('product-grid');
            
            // CACHE STRATEGY: Instant Load
            const cached = localStorage.getItem('shop_cache');
            if(cached) {
                try {
                    const cData = JSON.parse(cached);
                    if(cData && cData.length > 0) {
                        allProducts = cData;
                        grid.innerHTML = ''; // Clear loading immediately
                        renderProducts(allProducts);
                        renderFilters(allProducts);
                    }
                } catch(e) { 
                    console.log("Cache error:", e);
                    localStorage.removeItem('shop_cache'); // Clear bad cache
                }
            }

            const loader = document.getElementById('stock-loader');
            if(loader && !cached) loader.innerHTML = "SYNCING...";
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 4000);
                
                const response = await fetch('/webapp/api/products', { signal: controller.signal });
                clearTimeout(timeoutId);
                
                const data = await response.json();
                
                if(data.success && data.products) {
                    localStorage.setItem('shop_cache', JSON.stringify(data.products));
                    
                    allProducts = data.products;
                    grid.innerHTML = ''; // Clear before render
                    renderProducts(allProducts);
                    renderFilters(allProducts);
                    updateStars(Math.floor(Math.random() * 6));
                    refreshDistrictColors(); // Update map district colors 
                } else {
                    if(!cached) grid.innerHTML = '<div class="loading" style="color:red">NO DATA</div>';
                }
            } catch (e) {
                console.error("Fetch error:", e);
                if(!cached) grid.innerHTML = '<div class="loading" style="color:red">OFFLINE<br><button onclick="loadProducts()" style="background:#333;color:#fff;border:1px solid #fff;padding:8px 16px;cursor:pointer;font-family:\'Pricedown\',serif;">RETRY</button></div>';
            }
        }

        function renderProducts(products) {
            console.log("Render Products v2.1 - Strict Cleaning");
            const grid = document.getElementById('product-grid');
            grid.innerHTML = '';
            
            if(!products || products.length === 0) {
                grid.innerHTML = '<div class="loading">NO PRODUCTS AVAILABLE</div>';
                return;
            }
            
            // Group products by Cleaned Name + Type + City + Size + Price
            const groups = {};
            products.forEach(p => {
                // CLEAN NAME: Remove any sequence of 6+ digits/underscores (IDs)
                // This handles cases where ID is stuck to the name in DB
                let cleanName = p.name.replace(/[\d_]{6,}.*/g, '').trim();
                
                // Also remove trailing numbers if they look like IDs
                cleanName = cleanName.replace(/\s\d+$/, '').trim();

                const key = `${cleanName.toLowerCase()}|${p.type}|${p.city}|${p.size}|${p.price}`;
                
                if(!groups[key]) {
                    groups[key] = { 
                        ...p, 
                        display_name: cleanName, // Store cleaned name for display
                        count: 0, 
                        ids: [] 
                    };
                }
                groups[key].count++;
                groups[key].ids.push(p.id);
            });
            
            const uniqueProducts = Object.values(groups);

            if(uniqueProducts.length === 0) {
                grid.innerHTML = '<div style="text-align:center; width:100%">NO ITEMS FOUND</div>';
                return;
            }
            
            uniqueProducts.forEach((p, index) => {
                const card = document.createElement('div');
                card.className = 'product-card';
                // Staggered Animation
                card.style.animationDelay = `${index * 0.05}s`;
                
                const countBadge = p.count > 1 ? `<div style="position:absolute; top:5px; right:5px; background:var(--gta-gold); color:#000; padding:2px 6px; font-size:12px; border-radius:4px; font-weight:bold;">x${p.count}</div>` : '';
                
                card.innerHTML = `
                    ${countBadge}
                    <div class="product-emoji">${getProductEmoji(p.type, p.display_name)}</div>
                    <div class="product-name">${p.display_name}</div>
                    <div class="product-details">${p.size} | ${p.city}${p.district ? ' | ' + p.district : ''}</div>
                    <div class="product-price">$${p.price.toFixed(2)}</div>
                    <div style="display:flex; gap:5px;">
                        <button class="btn-buy" style="font-size:14px; flex:1;" onmouseover="sfx.tick()" onclick="sfx.select(); addToBasket(${p.ids[0]}, '${p.display_name}', ${p.price})">ADD</button>
                        <button class="btn-buy" style="flex:2;" onmouseover="sfx.tick()" onclick="sfx.select(); buyNow(${p.ids[0]}, '${p.display_name}', ${p.price})">BUY</button>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        // Sound FX (Old removed, using sfx object now)

        // LSPD Search
        function filterSearch(query) {
            const term = query.toLowerCase();
            const filtered = allProducts.filter(p => 
                p.name.toLowerCase().includes(term) || 
                p.city.toLowerCase().includes(term)
            );
            renderProducts(filtered);
        }

        // Filters
        function renderFilters(products) {
            const cities = [...new Set(products.map(p => p.city))];
            const container = document.getElementById('city-filters');
            container.innerHTML = '<button class="filter-btn active" onclick="filterProducts(\'all\')">ALL ZONES</button>';
            cities.forEach(city => {
                const btn = document.createElement('button');
                btn.className = 'filter-btn';
                btn.innerText = city.toUpperCase();
                btn.onclick = () => filterProducts(city);
                container.appendChild(btn);
            });
        }

        function filterProducts(city, district = null) {
            // UI Update Logic
            const container = document.getElementById('city-filters');
            
            if (city === 'all') {
                renderFilters(allProducts);
                renderProducts(allProducts);
                const label = document.querySelector('.search-label');
                if(label) label.innerText = `LSPD DATABASE > SEARCH:`;
                return;
            }

            // Filter for the selected city first
            let cityProducts = allProducts.filter(p => p.city === city);
            
            // 1. Update Product Grid
            let displayProducts = cityProducts;
            if (district) {
                const dTerm = district.toLowerCase();
                displayProducts = cityProducts.filter(p => p.district && p.district.toLowerCase().includes(dTerm));
            }
            renderProducts(displayProducts);

            // 2. Update Filter Bar (Show Districts)
            // Get unique districts for this city from the PRODUCTS list
            const districts = [...new Set(cityProducts.map(p => p.district).filter(d => d))].sort();
            
            container.innerHTML = '';
            
            // Back Button
            const backBtn = document.createElement('button');
            backBtn.className = 'filter-btn back-btn';
            backBtn.innerText = 'ALL ZONES';
            backBtn.onclick = () => filterProducts('all');
            container.appendChild(backBtn);

            // City Button (Reset to City level)
            const cityBtn = document.createElement('button');
            cityBtn.className = 'filter-btn' + (district ? '' : ' active');
            cityBtn.innerText = city.toUpperCase(); 
            cityBtn.onclick = () => filterProducts(city);
            container.appendChild(cityBtn);

            // District Buttons
            districts.forEach(d => {
                const btn = document.createElement('button');
                btn.className = 'filter-btn' + (district && district.toLowerCase() === d.toLowerCase() ? ' active' : '');
                btn.innerText = d.toUpperCase();
                btn.onclick = () => filterProducts(city, d);
                container.appendChild(btn);
            });

            // Update Search Label
            const label = document.querySelector('.search-label');
            if(label) {
                if(district) {
                    label.innerHTML = `LSPD > ${city.toUpperCase()} > <span style="color:#fff">${district.toUpperCase()}</span>`;
                } else {
                    label.innerHTML = `LSPD > <span style="color:#fff">${city.toUpperCase()}</span>`;
                }
            }
        }

        // Stars
        function updateStars(count) {
            const stars = document.querySelectorAll('.star');
            stars.forEach((s, i) => {
                s.classList.remove('active', 'flashing');
                if (i < count) s.classList.add('active');
                if (count === 5) s.classList.add('flashing');
            });
        }

        // Radio - Native HTML5 Audio
        // Radio - Persistent Player Logic
        function toggleRadio(forceStart = false) {
            audioPlayer = document.getElementById('global-audio-player');
            if(!audioPlayer) return;

            if(!forceStart) {
                // Move to next station
                currentStation = (currentStation + 1) % stations.length;
            } else {
                // Reset to first station
                currentStation = 1;
            }

            const station = stations[currentStation];
            const radioText = document.getElementById('radio-display');
            
            // Update UI
            if(radioText) {
                radioText.innerText = station.name;
                radioText.style.color = "#fff"; 
                setTimeout(() => radioText.style.color = "var(--gta-green)", 300);
            }

            // Handle Logic
            if(station.src) {
                // Visual Feedback
                if(radioText) radioText.innerText = "TUNING...";
                
                // Player Logic
                audioPlayer.src = station.src;
                audioPlayer.volume = 0.5;
                
                const p = audioPlayer.play();
                if(p !== undefined) {
                    p.then(() => {
                         if(radioText) {
                             radioText.innerText = station.name;
                             radioText.style.color = "var(--gta-green)";
                         }
                    }).catch(e => {
                         console.error("Play Error", e);
                         if(radioText) {
                             radioText.innerText = "SIGNAL LOST";
                             radioText.style.color = "red";
                         }
                         // Auto-skip
                         setTimeout(() => toggleRadio(), 2000);
                    });
                }
            } else {
                // RADIO OFF
                audioPlayer.pause();
                audioPlayer.src = ""; // Detach stream
                if(radioText) radioText.innerText = "RADIO OFF";
            }
        }

        // District Data
        const districtData = {
            'Vilnius': [
                {name: 'Senamiestis', type: 'grove'}, 
                {name: 'Naujamiestis', type: 'grove'},
                {name: 'Zirmunai', type: 'ballas'},
                {name: 'Fabijoniskes', type: 'ballas'},
                {name: 'Pilaite', type: 'vagos'}
            ],
            'Kaunas': [
                {name: 'Centras', type: 'grove'},
                {name: 'Dainava', type: 'ballas'},
                {name: 'Silainiai', type: 'vagos'},
                {name: 'Aleksotas', type: 'vagos'}
            ],
            'Klaipeda': [
                {name: 'Senamiestis', type: 'vagos'},
                {name: 'Baltija', type: 'ballas'},
                {name: 'Pietinis', type: 'grove'}
            ],
            'Panevezys': [
                {name: 'Centras', type: 'grove'},
                {name: 'Pramone', type: 'ballas'},
                {name: 'Tulpes', type: 'vagos'}
            ]
        };

        // Map Zoom (Legacy support, redirects to menu)
        function zoomMap(cityName, topPerc, leftPerc) {
            openDistrictMenu(cityName);
        }

        function openDistrictMenu(city) {
            // Play Select Sound
            if(window.sfx) sfx.select();
            
            const menu = document.getElementById('district-menu');
            const header = document.getElementById('dm-header');
            const list = document.getElementById('dm-list');
            
            if(!menu || !header || !list) return;

            header.innerText = city.toUpperCase();
            list.innerHTML = '';
            
            // Add "ALL HOODS"
            const allBtn = document.createElement('div');
            allBtn.className = 'dm-item';
            allBtn.innerHTML = '<span>ALL HOODS</span><span></span>';
            allBtn.onclick = () => {
                if(window.sfx) sfx.select();
                filterProducts(city); 
                closeDistrictMenu();
                showSection('shop');
                if(window.charSystem) charSystem.show('cj', `WELCOME TO ${city.toUpperCase()}!`);
            };
            list.appendChild(allBtn);

            // Add Districts
            let districts = districtData[city] || [];
            if(districts.length === 0) {
                 districts = [{name: 'Downtown', type: 'grove'}, {name: 'Industrial', type: 'ballas'}];
            }

            districts.forEach(d => {
                const el = document.createElement('div');
                el.className = 'dm-item';
                el.innerHTML = `<span>${d.name}</span><span></span>`;
                el.onclick = () => {
                    if(window.sfx) sfx.select();
                    filterProducts(city); 
                    closeDistrictMenu();
                    showSection('shop');
                    if(window.charSystem) charSystem.show('cj', `${d.name} - GOOD CHOICE!`);
                };
                list.appendChild(el);
            });
            
            menu.classList.add('active');
        }

        function closeDistrictMenu() {
            const menu = document.getElementById('district-menu');
            if(menu) menu.classList.remove('active');
        }

        function resetMap() {
            closeDistrictMenu();
        }


        // --- Basket Logic ---
        let currentDiscount = null; 

        function addToBasket(id, name, price) {
            basket.push({id, name, price});
            updateBasketUI();
            currentDiscount = null; // Reset on change
            charSystem.show('cj', 'NICE CHOICE!');
            const nav = document.getElementById('nav-basket');
            nav.style.color = '#fff';
            setTimeout(() => nav.style.color = '', 200);
        }
        
        function updateBasketUI() {
            document.getElementById('basket-count').innerText = basket.length;
        }
        
        function openBasket() {
            const modal = document.getElementById('basket-modal');
            renderBasketContent();
            modal.style.display = 'flex';
            checkDiscounts(); // Check for auto-applied discounts
        }
        
        function renderBasketContent() {
            const list = document.getElementById('basket-items');
            const totalEl = document.getElementById('basket-total');
            const breakdownEl = document.getElementById('price-breakdown');
            const discountMsg = document.getElementById('discount-msg');
            
            list.innerHTML = '';
            let subtotal = 0;
            
            basket.forEach((item, index) => {
                subtotal += item.price;
                const row = document.createElement('div');
                row.style.cssText = "display:flex; justify-content:space-between; align-items:center; background:rgba(255,255,255,0.1); padding:10px; border:1px solid #555; margin-bottom:5px;";
                row.innerHTML = `
                    <div>${item.name}</div>
                    <div style="display:flex; gap:10px; align-items:center;">
                        <div style="color:var(--gta-green);">$${item.price.toFixed(2)}</div>
                        <button style="background:#900; border:none; color:#fff; cursor:pointer; padding:2px 5px;" onclick="removeFromBasket(${index})">X</button>
                    </div>
                `;
                list.appendChild(row);
            });
            
            // Breakdown
            if (currentDiscount) {
                let html = `<div style="display:flex; justify-content:space-between;"><span>SUBTOTAL:</span><span>$${subtotal.toFixed(2)}</span></div>`;
                
                if (currentDiscount.reseller_discount > 0) {
                    html += `<div style="display:flex; justify-content:space-between; color:#aaa;"><span>RESELLER DISC:</span><span>-$${currentDiscount.reseller_discount.toFixed(2)}</span></div>`;
                }
                
                if (currentDiscount.code_discount > 0) {
                    html += `<div style="display:flex; justify-content:space-between; color:var(--gta-gold);"><span>PROMO (${currentDiscount.code}):</span><span>-$${currentDiscount.code_discount.toFixed(2)}</span></div>`;
                }
                
                breakdownEl.innerHTML = html;
                totalEl.innerText = `$${currentDiscount.final_total.toFixed(2)}`;
                
                if(discountMsg) {
                    discountMsg.innerText = currentDiscount.message || "DISCOUNT APPLIED";
                    discountMsg.style.color = "var(--gta-green)";
                }
            } else {
                breakdownEl.innerHTML = ""; 
                totalEl.innerText = `$${subtotal.toFixed(2)}`;
                if(discountMsg) discountMsg.innerText = "";
            }
        }
        
        function closeBasket() {
            document.getElementById('basket-modal').style.display = 'none';
        }
        
        function removeFromBasket(index) {
            basket.splice(index, 1);
            currentDiscount = null;
            renderBasketContent();
            updateBasketUI();
        }
        
        function buyNow(id, name, price) {
            addToBasket(id, name, price);
            openBasket();
        }

        async function checkDiscounts(code = "") {
            const msg = document.getElementById('discount-msg');
            if(msg) {
                msg.innerText = code ? "VALIDATING..." : "CHECKING DISCOUNTS...";
                msg.style.color = "#aaa";
            }
            
            try {
                const user = tg.initDataUnsafe?.user;
                const userId = user ? user.id : 0;
                
                const response = await fetch('/webapp/api/validate_discount', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        code: code,
                        user_id: userId,
                        items: basket
                    })
                });
                
                const data = await response.json();
                
                if(data.success) {
                    currentDiscount = {
                        code: data.code_valid ? code : null,
                        reseller_discount: data.reseller_discount,
                        code_discount: data.code_valid ? data.code_discount : 0,
                        final_total: data.final_total,
                        message: data.message
                    };
                    
                    if (msg) {
                        if (data.code_valid) {
                            msg.innerText = data.message;
                            msg.style.color = "var(--gta-green)";
                        } else if (code) {
                            msg.innerText = data.message || "INVALID CODE";
                            msg.style.color = "#f00";
                        } else if (data.reseller_discount > 0) {
                            msg.innerText = "RESELLER DISCOUNT ACTIVE";
                            msg.style.color = "var(--gta-gold)";
                        } else {
                            msg.innerText = "";
                        }
                    }
                    renderBasketContent();
                }
            } catch(e) {
                console.error(e);
                if(msg && code) {
                    msg.innerText = "ERROR CHECKING CODE";
                    msg.style.color = "#f00";
                }
            }
        }

        function applyDiscount() {
             const input = document.getElementById('discount-input');
             checkDiscounts(input.value.trim());
        }

        // --- Checkout & Payment ---
        // payment globals moved to top

        function copyText(elementId) {
            const el = document.getElementById(elementId);
            const text = el.innerText.replace(' SOL', '');
            navigator.clipboard.writeText(text).then(() => {
                const original = el.style.color;
                el.style.color = '#fff';
                setTimeout(() => el.style.color = original, 200);
                tg.showAlert("COPIED TO CLIPBOARD");
            });
        }

        async function initCheckout() {
            if(basket.length === 0) return;
            
            // Find the checkout button (last button in basket modal)
            const btn = document.querySelector('#basket-modal .btn-buy:last-of-type');
            const originalText = btn ? btn.innerText : "CHECKOUT";
            if(btn) {
                btn.innerText = "CONNECTING...";
                btn.disabled = true;
            }
            
            try {
                const user = tg.initDataUnsafe?.user;
                const userId = user ? user.id : 0; 
                
                const payload = {
                    user_id: userId,
                    items: basket,
                    discount_code: currentDiscount ? currentDiscount.code : null
                };

                const response = await fetch('/webapp/api/create_invoice', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                
                const data = await response.json();
                
                if(data.success) {
                    document.getElementById('basket-modal').style.display = 'none';
                    const invModal = document.getElementById('invoice-modal');
                    
                    document.getElementById('invoice-amount').innerText = `${data.pay_amount} SOL`;
                    document.getElementById('invoice-address').innerText = data.pay_address;
                    
                    // Generate QR
                    const qrContainer = document.getElementById('qrcode');
                    qrContainer.innerHTML = "";
                    new QRCode(qrContainer, {
                        text: data.pay_address,
                        width: 150,
                        height: 150,
                        colorDark : "#000000",
                        colorLight : "#ffffff",
                        correctLevel : QRCode.CorrectLevel.L
                    });
                    
                    invModal.style.display = 'flex';
                    activePaymentId = data.payment_id;
                    
                    // Start Polling
                    if(pollInterval) clearInterval(pollInterval);
                    pollInterval = setInterval(() => pollPayment(data.payment_id), 3000);
                } else {
                    tg.showAlert("Error: " + (data.error || "Unknown"));
                }
            } catch(e) {
                tg.showAlert("Network Error: " + e.message);
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }
        
        async function pollPayment(paymentId) {
            try {
                const response = await fetch(`/webapp/api/check_payment/${paymentId}`);
                const data = await response.json();
                
                if(data.status === 'paid') {
                    clearInterval(pollInterval);
                    onPaymentSuccess();
                } else if (data.status === 'expired' || data.status === 'refunded') {
                    clearInterval(pollInterval);
                    closeInvoice();
                    triggerWasted(); // WASTED!
                }
            } catch(e) {
                console.log("Poll error", e);
            }
        }
        
        function closeInvoice() {
            document.getElementById('invoice-modal').style.display = 'none';
            if(pollInterval) clearInterval(pollInterval);
        }
        
        function onPaymentSuccess() {
            closeInvoice();
            basket = []; // Clear basket
            updateBasketUI();
            sfx.cash(); // Cash Sound!
            charSystem.show('smoke', 'RESPECT +');
            
            // Play Mission Passed Logic
            const overlay = document.getElementById('mp-overlay');
            overlay.style.display = 'flex';
            // Force reflow
            void overlay.offsetWidth;
            overlay.classList.add('mp-active');
            
            // Show Review after 4 seconds
            setTimeout(() => {
                document.getElementById('review-modal').style.display = 'flex';
            }, 4000);
        }

        // --- Review Logic ---
        let currentRating = 5;
        function setReview(n) {
            currentRating = n;
            const stars = document.querySelectorAll('#review-stars span');
            stars.forEach((s, i) => {
                s.style.color = i < n ? '#fff' : '#333';
                s.style.textShadow = i < n ? '0 0 5px #fff' : 'none';
            });
        }
        // Init stars
        setReview(5); 
        
        function submitReview() {
            const text = document.getElementById('review-text').value;
            tg.sendData(`REVIEW:${currentRating}:${text}`);
        }
        
        function closeApp() {
            tg.close();
        }

        // Skins
        function changeSkin(skin) {
            const img = document.getElementById('char-img');
            if(skin === 'cj') img.src = "https://static.wikia.nocookie.net/gtawiki/images/c/ce/Carl_Johnson.png";
            if(skin === 'ryder') img.src = "https://static.wikia.nocookie.net/gtawiki/images/6/67/Ryder-GTASA.png";
            if(skin === 'sweet') img.src = "https://static.wikia.nocookie.net/gtawiki/images/1/1b/Sweet-GTASA.png";
        }

        // Navigation
        function showSection(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(`nav-${id}`).classList.add('active');
        }
        
        function getProductEmoji(type, name = '') {
            // Check Name First (Specifics)
            const n = name.toLowerCase();
            if(n.includes('lemon') || n.includes('haze') || n.includes('skunk') || n.includes('weed')) return '';
            if(n.includes('kush') || n.includes('og') || n.includes('wido')) return '';
            if(n.includes('xan') || n.includes('tab') || n.includes('pill')) return '';
            if(n.includes('snow') || n.includes('pure') || n.includes('coke')) return '';
            if(n.includes('speed') || n.includes('amp')) return '';
            if(n.includes('lsd') || n.includes('acid')) return '';
            if(n.includes('shroom')) return '';
            if(n.includes('alus') || n.includes('beer')) return '';
            if(n.includes('deg') || n.includes('vodka')) return '';
            if(n.includes('pienas')) return '';
            if(n.includes('kava')) return '';
            
            // Fallback to Type
            if(!type) return '';
            const t = type.toLowerCase();
            if(t.includes('weed') || t.includes('cannabis')) return '';
            if(t.includes('pill') || t.includes('xtc')) return '';
            if(t.includes('powder') || t.includes('coke')) return '';
            return '';
        }

        // Init - Removed immediate call, using window.onload instead

        // --- 3D GLOBE LOGIC ---
        let globeRotation = { x: -10, y: 20 };
        let isDragging = false;
        let lastTouch = { x: 0, y: 0 };

        function initGlobe() {
            const globe = document.getElementById('globe');
            if(!globe) return;

            // Touch Events
            globe.addEventListener('touchstart', (e) => {
                isDragging = true;
                const touch = e.touches[0];
                lastTouch = { x: touch.clientX, y: touch.clientY };
            });
            
            globe.addEventListener('touchmove', (e) => {
                if (!isDragging) return;
                e.preventDefault();
                const touch = e.touches[0];
                const deltaX = touch.clientX - lastTouch.x;
                const deltaY = touch.clientY - lastTouch.y;
                
                globeRotation.y += deltaX * 0.5;
                globeRotation.x -= deltaY * 0.5;
                updateGlobeRotation();
                lastTouch = { x: touch.clientX, y: touch.clientY };
            });
            
            globe.addEventListener('touchend', () => isDragging = false);

            // Mouse Events
            globe.addEventListener('mousedown', (e) => {
                isDragging = true;
                lastTouch = { x: e.clientX, y: e.clientY };
            });

            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                const deltaX = e.clientX - lastTouch.x;
                const deltaY = e.clientY - lastTouch.y;
                globeRotation.y += deltaX * 0.5;
                globeRotation.x -= deltaY * 0.5;
                updateGlobeRotation();
                lastTouch = { x: e.clientX, y: e.clientY };
            });

            document.addEventListener('mouseup', () => isDragging = false);

            // Pins
            document.querySelectorAll('.city-pin').forEach(pin => {
                pin.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const city = pin.getAttribute('data-city');
                    selectCity(city);
                });
            });
            
            // Auto-spin
            setInterval(() => {
                if(!isDragging) {
                    globeRotation.y += 0.1;
                    updateGlobeRotation();
                }
            }, 50);
        }

        function updateGlobeRotation() {
            const globe = document.getElementById('globe');
            if(globe) globe.style.transform = `rotateX(${globeRotation.x}deg) rotateY(${globeRotation.y}deg)`;
        }

        function selectCity(city) {
            if(window.sfx) sfx.select();
            
            // Rotate to city
            const rots = {
                'Vilnius': { x: -10, y: 20 },
                'Kaunas': { x: -5, y: 0 },
                'Klaipeda': { x: -15, y: -30 }
            };
            if(rots[city]) globeRotation = rots[city];
            updateGlobeRotation();
            
            openDistrictPanel(city);
        }

        function openDistrictPanel(city) {
            const panel = document.getElementById('district-panel');
            const header = document.getElementById('panel-header');
            const list = document.getElementById('panel-list');
            if(!panel) return;

            header.innerText = city.toUpperCase();
            list.innerHTML = '';

            // Mock Districts
            const districts = {
                'Vilnius': ['Senamiestis', 'Naujamiestis', 'Antakalnis', 'nipiks'],
                'Kaunas': ['Centras', 'aliakalnis', 'ilainiai', 'Dainava'],
                'Klaipeda': ['Senamiestis', 'Baltija', 'Dan', 'Pempininkai']
            };
            
            (districts[city] || ['Downtown']).forEach(d => {
                const item = document.createElement('div');
                item.className = 'dm-item'; 
                item.innerText = d;
                item.style.padding = '15px';
                item.style.borderBottom = '1px solid #333';
                item.style.cursor = 'pointer';
                item.onmouseover = () => item.style.background = '#f0c330';
                item.onmouseout = () => item.style.background = 'transparent';
                
                item.onclick = () => {
                    closePanel();
                    showSection('shop');
                    filterProducts(city);
                    if(window.charSystem) charSystem.show('cj', `${d.toUpperCase()} SELECTED!`);
                };
                list.appendChild(item);
            });
            
            panel.classList.add('active');
        }

        function closePanel() {
            const panel = document.getElementById('district-panel');
            if(panel) panel.classList.remove('active');
        }

        // Initialize after DOM
        // setTimeout(initGlobe, 1000); // Disabled for Metro Map

        // --- SATELLITE VIEW LOGIC (BURNER PHONE MODE) ---
        
        let isZoomed = false;
        let currentZoomedCity = null;

        // --- ASSETS (Embedded) ---
const CHAR_ASSETS = {
    'cj': 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAQACAYAAACXqOHAAAARD0lEQVR4nO3dsW0TYQCGYRtdH6wwAUpDzQqRmMANDRUTuE2RgjYTUNHQeAIkVqCmiZgAdGQCs4Gb4PzOvc/Tuvl8p7Ne/cV5tQIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD4P9ajB8BIm83mMHoD52ueZ7+RLNaL0QMAgKcnAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAETaMHwEg315ejJ3DGdvt59AQ4GScAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAEeQ8AnNCn738W/Z6DpX8/WDInAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABE2jB8CS3VxfrpZs6d8PlswJAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQdPoAVD29dfF6Aln7f3rh9ETYLGcAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAEDSNHgBl/u8eGMUJAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQevRA6Dsbnt1GL3hnO32936j4EScAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAEDSNHlB3t706jN5wzj58/rFasi8f346ecNZ+/31Y9PPh/h+329+vR29YMicAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAEeQ8ADLT09xwA58sJAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQdPoAXDMq5cX62Ofv7n9dni6Nc/Pz9t3R6/fY7n+j7v+d9sr149hnAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABA0jR5Qt9vfr0dvAMbw/DOSEwAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAILWowfQttlsDqM3LNk8zyd9xt2/533/aHMCAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAADAqucf6+9Cfvrm81YAAAAASUVORK5CYII=',
    'ryder': 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAQACAYAAACXqOHAAAARZ0lEQVR4nO3dMYoTYQCG4Y2kl8EbSMDGI4iVBxAhhVZWXiCtV9gLWFlpERDPIB7BRgheYfAE8QQbhWX9Z+d9nna3+JhhhpcfklxdAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAwN9t/uF/YLWmaTqP3sByzfPsHclqPRg9AAD4/wQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCC/dc29Nk3TefQGuMk8z96xLJYTAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAgjajB8BI1/vdefQGlutwPHlHslpOAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACPIZV9KmafI9ANxonmfvSFbLCQAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEHb0QNgpPcvHo2ewIIdjvPoCXBnnAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABC0HT0Ayj79ejh6wqK9efx79ARYLScAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAEbUcPgDK/dw+M4gQAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAICgzegBUHa9351Hb1iyw/HkHQV3xAkAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABB29ED6q73u/PoDUv24fWzq1X7/H30gkV78uXtqp+Pd+7/RYfjaTN6w5o5AQCAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIMj3AMBAq/+eA2CxnAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABC0HT0ALvn56uPm0t+fPn95/n9r7p8f375evH635frf8vrvd64fwzgBAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgaDt6QN3heNqM3gCM4flnJCcAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAEbUYPoG2apvPoDWs2z/OdPuPu3/2+f7Q5AQCAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAA4KrnD2LgRh7+dJDiAAAAAElFTkSuQmCC',
    'smoke': 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAQACAYAAACXqOHAAAARZ0lEQVR4nO3dMYoTYQCG4UTSy+ANJGDjEcTKA4iQQisrL5DWK+wFrKy0CIhnEI9gIwSvMHiCeIJdRYn/JO/z1IF8ZDbDyw87Wa0AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADg99Z/8Bq4WtM0nUZvYLnmeXaP5GrdGz0AAPj/BAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIL91zUWbpuk0egPcZp5n91gWywkAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABB69EDYKSb3fY0egPLtT8c3SO5Wk4AACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAI8j+upE3T5DkA3GqeZ/dIrpYTAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAgjajB8BIb589GD2BBdsf5tET4GycAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAELQZPQDKPvy4P3rCor16+HP0BLhaTgAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAjajB4AZX7vHhjFCQAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEHr0QOg7Ga3PY3esGT7w9E9Cs7ECQAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEGb0QOW7ma3PY3esGTvXj4ZPeGyffw6esGiPfr02vfvH7zx93Wn/eG4XoU5AQCAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIMhzAGAgz1EARnECAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABA0Gb0AC7b9xfv1yPf//HT56eR77903758Puv18fmP/fx/a7d1fbiVEwAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAII2owcs3f5wXI/eAPA33L+4ixMAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACC1qMH0DZN02n0hms2z/NZv+Ou32VfP9qcAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAsOr5BUlgRh7fUH6lAAAAAElFTkSuQmCC',
    'sweet': 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAQACAYAAACXqOHAAAAREklEQVR4nO3dIY4TYQCG4ZaMJ83egKzBoDjCJihkDYYzkArMihUYxIYzYDCVKBKOgMJgNtyATDhBuUHN0v278z6Prfk6k2ne/GK6WgEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD8H+vRA2CkzWZzGL2B8zXPs99IFuvJ6AEAwMMTAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCptEDYKTrq4vREzhju/08egKcjBMAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCvAcATujD9z+Lfs/B0r8fLJkTAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAgqbRA2DJrq8uVku29O8HS+YEAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAoGn0ACj78vvp6Aln7c2zv6MnwGI5AQCAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIGgaPQDK/N89MIoTAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAgtajB0DZ7fbyMHrDOdvt7/xGwYk4AQCAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIGgaPaDudnt5GL3hnH1+/3q1aB+/jl5w1l78eLfo5+Ot+3/Ubn+3Hr1hyZwAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQ5D0AMNDi33MAnC0nAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABE2jB8AxP19+Wh/7/PnNt8PDrXl8ft28Onr97sv1v+f13166fgzjBAAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgKBp9IC63f5uPXoDMIbnn5GcAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAELQePYC2zWZzGL1hyeZ5Pukz7v497vtHmxMAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAABWPf8AeUdBkjPqhgAAAAAASUVORK5CYII=',
    'tenpenny': 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAQACAYAAACXqOHAAAAREElEQVR4nO3dIXJTYRiG0YbJBrIBVoBkJg5NHTIKNKBxkXHoggZViSsa1xkkK2ADWULYQU1pv/Q+59jMNG9u5t555hfpxQUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADA/7GaHgCTNpvNaXoD5+t4PHpGsljPpgcAAI9PAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIWk0PgEm31/vT9AbO13Z38IxksZwAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQtJ4eAEv2+v3V6Pv//PrxQf/+0j8fLJkTAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAglbTA2DS7fX+NL2B87XdHTwjWSwnAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABK2nB0DZh8830xPO2pdPl9MTYLGcAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAELSeHgBl/t89MMUJAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQavpAVB2e70/TW84Z9vdwTMKHogTAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAgtbTA+pur/en6Q3n7OO3v9MTGPTy8u2i74+rd8+nJ5y17e6wmt6wZE4AACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAI8jsAMMjvHABTnAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABC0nh4Ad/l983111+svXr05Pd6ap+fPrx93Xr/7cv3vef3f7V0/xjgBAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgSAAAQJAAAIAgAQAAQQIAAIIEAAAECQAACBIAABAkAAAgaD09oG67O6ymNwAz3P9McgIAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAECQAACAIAEAAEECAACCBAAABAkAAAgSAAAQJAAAIEgAAEDQanoAbZvN5jS9YcmOx+OD3uO+v6f9/dHmBAAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgCABAABBAgAAggQAAAQJAAAIEgAAECQAACBIAABAkAAAgIuef0t/Qs67Yg4AAAAAAElFTkSuQmCC',
};


        // --- THE CREW DATA ---
        const gtaCharacters = [
            {
                id: 'cj',
                name: 'CARL JOHNSON',
                img: CHAR_ASSETS.cj,
                lines: [
                    "Yo! You lookin' for product here? Hold up.",
                    "Grove Street 4 Life! I got the hookup.",
                    "Ah sh*t, here we go again... Check the burner."
                ]
            },
            {
                id: 'ryder',
                name: 'RYDER',
                img: CHAR_ASSETS.ryder,
                lines: [
                    "You drive like a genius, fool! Check the phone!",
                    "Don't expect me to kiss your ass. Just buy it!",
                    "I'm a motherf***in' genius! Look at this stock!"
                ]
            },
            {
                id: 'smoke',
                name: 'BIG SMOKE',
                img: CHAR_ASSETS.smoke,
                lines: [
                    "All we had to do, was follow the damn signal, CJ!",
                    "I'll have two number 9s... and your order ready.",
                    "Remember the name! Big Smoke! Now pick a district."
                ]
            },
            {
                id: 'sweet',
                name: 'SWEET',
                img: CHAR_ASSETS.sweet,
                lines: [
                    "For the hood! We takin' over this city.",
                    "Stay true to the families. Check the supply.",
                    "Don't be a busta! Make the deal."
                ]
            },
            {
                id: 'tenpenny',
                name: 'OFFICER TENPENNY',
                img: CHAR_ASSETS.tenpenny,
                lines: [
                    "I'm watching you... make the deal and get out.",
                    "We can all get along... just pay the price.",
                    "Don't make me come down there!"
                ]
            }
        ];

        function zoomToCity(city, topP, leftP) {
            console.log("Zooming to:", city);
            if(isZoomed) return;
            isZoomed = true;
            currentZoomedCity = city;
            
            // Haptics (Apple Feel)
            if(navigator.vibrate) navigator.vibrate(15);
            if(window.sfx) sfx.select();
            
            const layer = document.getElementById('map-zoom-layer');
            const container = document.querySelector('.satellite-view');
            
            // Screen Flash (Transition Mask)
            const flash = document.createElement('div');
            flash.style.position = 'fixed';
            flash.style.top = '0'; flash.style.left = '0';
            flash.style.width = '100vw'; flash.style.height = '100vh';
            flash.style.background = '#fff';
            flash.style.opacity = '0.3';
            flash.style.pointerEvents = 'none';
            flash.style.zIndex = '9999';
            flash.style.transition = 'opacity 0.4s';
            document.body.appendChild(flash);
            
            requestAnimationFrame(() => { flash.style.opacity = '0'; });
            setTimeout(() => flash.remove(), 400);

            container.classList.add('zoomed');
            
            layer.style.transformOrigin = `${leftP}% ${topP}%`;
            layer.style.transform = 'scale(3.5)';
            
            // Fast Phone Open
            setTimeout(() => {
                openBurnerPhone(city);
            }, 800);
        }

        function resetSatelliteView() {
            if(!isZoomed) return;
            isZoomed = false;
            currentZoomedCity = null;
            
            const layer = document.getElementById('map-zoom-layer');
            const container = document.querySelector('.satellite-view');
            const scanner = document.querySelector('.scanner-text');
            
            container.classList.remove('zoomed');
            layer.style.transform = 'scale(1)';
            
            // Reset Scanner Text
            if(scanner) scanner.innerText = "SCANNING NETWORK...";
            
            // Hide CJ if active
            const cj = document.getElementById('cj-overlay');
            if(cj) cj.classList.remove('active');
            
            closeBurnerPhone();
        }

        function updateWantedLevel() {
             const stars = Math.floor(Math.random() * 5) + 1;
             const el = document.getElementById('wanted-stars');
             if(el) {
                 let str = "";
                 for(let i=0; i<5; i++) {
                     str += i < stars ? "" : "";
                 }
                 el.innerText = str;
                 el.style.color = stars >= 3 ? "#b71c1c" : "#111"; 
                 el.style.textShadow = stars >= 4 ? "0 0 5px #d32f2f" : "none";
             }
        }

        function openBurnerPhone(city) {
            const phone = document.getElementById('burner-phone');
            const list = document.getElementById('phone-contacts');
            const header = document.getElementById('phone-header');
            const dialScreen = document.getElementById('dialing-screen');
            
            if(!phone || !list) return;
            
            // Reset UI state
            if(dialScreen) dialScreen.classList.remove('active');
            if(list) list.style.display = 'flex';
            if(header) header.style.display = 'block';
            
            if(header) header.innerText = city.toUpperCase();
            list.innerHTML = '';
            
            // 1. Add "ALL ZONES" contact
            addPhoneContact(city, "ALL ZONES", 5, 0); 
            
            // 2. Add Districts
            const dList = districtData[city] || [];
            
            dList.forEach((d, i) => {
                // Stock Check
                const count = allProducts.filter(p => 
                    p.city && p.city.toLowerCase() === city.toLowerCase() &&
                    p.district && p.district.toLowerCase().includes(d.name.toLowerCase())
                ).length;
                
                // Signal bars (0-5)
                const bars = count > 5 ? 5 : (count > 0 ? 3 : 0);
                addPhoneContact(city, d.name, bars, i + 1);
            });
            
            // Reset classes to force restart animation
            phone.classList.remove('active', 'handoff');
            void phone.offsetWidth; // Trigger reflow
            
            phone.classList.add('active');
            
            if(window.sfx) sfx.tick();
            updatePhoneTime();
            updateWantedLevel();
        }
        
        function updatePhoneTime() {
             const t = new Date();
             const str = t.getHours().toString().padStart(2, '0') + ":" + t.getMinutes().toString().padStart(2, '0');
             const span = document.getElementById('phone-time');
             if(span) span.innerText = str;
             
             // Header Clock
             const headerClock = document.getElementById('phone-clock-header');
             if(headerClock) headerClock.innerText = str;
        }
        
        function addPhoneContact(city, name, bars, index = 0) {
            const list = document.getElementById('phone-contacts');
            const item = document.createElement('div');
            item.className = 'contact-item';
            item.style.animationDelay = `${index * 0.06}s`;
            
            let signalStr = "";
            for(let i=0; i<5; i++) {
                signalStr += i < bars ? "|" : ".";
            }
            // Darker text for better visibility on green screen
            const color = bars > 0 ? '#111' : '#555'; 
            
            item.innerHTML = `
                <span>${name.toUpperCase()}</span>
                <span class="signal" style="color:${color}; font-weight:bold;">[${signalStr}]</span>
            `;
            
            item.onclick = () => {
                if(window.sfx) sfx.select();
                simulateCall(city, name);
            };
            
            list.appendChild(item);
        }

        function simulateCall(city, districtName) {
            const contacts = document.getElementById('phone-contacts');
            const header = document.getElementById('phone-header');
            const dialScreen = document.getElementById('dialing-screen');
            const dialStatus = document.getElementById('dial-status');
            const dialNum = document.getElementById('dial-number');
            
            // 1. Hide Contacts
            if(contacts) contacts.style.display = 'none';
            if(header) header.style.display = 'none';
            
            // 2. Show Dialing
            if(dialScreen) dialScreen.classList.add('active');
            if(dialStatus) {
                dialStatus.innerText = "DIALING...";
                dialStatus.style.color = "#111";
                dialStatus.style.animation = "blink 1s infinite";
            }
            
            // Generate fake number
            const prefix = "555";
            const suffix = Math.floor(1000 + Math.random() * 9000);
            if(dialNum) dialNum.innerText = `${prefix}-${suffix}`;
            
            // Play ringing sound loop
            let rings = 0;
            const ringInterval = setInterval(() => {
                if(window.sfx) sfx.tick();
                rings++;
                if(rings >= 4) clearInterval(ringInterval);
            }, 800);
            
            // 3. Connect
            setTimeout(() => {
                clearInterval(ringInterval);
                if(dialStatus) {
                    dialStatus.innerText = "CONNECTED";
                    dialStatus.style.animation = 'none';
                }
                if(window.sfx) sfx.select();
                
                // 4. Transition to Shop
                setTimeout(() => {
                    closeBurnerPhone();
                    resetSatelliteView();
                    showSection('shop');
                    filterProducts(city, districtName === "ALL ZONES" ? null : districtName);
                    
                    if(window.charSystem) charSystem.show('cj', `CONNECTED TO ${districtName.toUpperCase()}.`);
                    
                }, 1000);
                
            }, 2500); 
        }

        function handleKey(key) {
            if(window.sfx) sfx.tick();
            // Future: Cheat Code Implementation
            console.log("Key pressed:", key);
        }
        
        function endCall() {
             closeBurnerPhone();
             resetSatelliteView();
        }

        function closeBurnerPhone() {
            const phone = document.getElementById('burner-phone');
            if(phone) phone.classList.remove('active');
            // Only trigger reset if we are still zoomed
            if(isZoomed) resetSatelliteView();
        }
        
        // Remove Metro Init
        function goToStation(){}; // Stub

        // Apple Polish: Dynamic Parallax
        const mapContainer = document.getElementById('map-container');
        const satelliteView = document.querySelector('.satellite-view');
        
        if(mapContainer && satelliteView) {
            // Ripple on Click
            mapContainer.addEventListener('click', (e) => {
                if(typeof isZoomed !== 'undefined' && isZoomed) return;
                const ripple = document.createElement('div');
                ripple.className = 'touch-ripple';
                const rect = mapContainer.getBoundingClientRect();
                ripple.style.left = `${e.clientX - rect.left}px`;
                ripple.style.top = `${e.clientY - rect.top}px`;
                satelliteView.appendChild(ripple);
                setTimeout(() => ripple.remove(), 600);
            });

            mapContainer.addEventListener('mousemove', (e) => {
                if(typeof isZoomed !== 'undefined' && isZoomed) return;
                const rect = mapContainer.getBoundingClientRect();
                const x = (e.clientX - rect.left) / rect.width - 0.5;
                const y = (e.clientY - rect.top) / rect.height - 0.5;
                
                // Subtle shift (20px max)
                satelliteView.style.transform = `translate(${x * -20}px, ${y * -20}px)`;
                satelliteView.style.backgroundPosition = `${50 + x * 5}% ${50 + y * 5}%`;
            });
            
            mapContainer.addEventListener('mouseleave', () => {
                if(typeof isZoomed !== 'undefined' && isZoomed) return;
                satelliteView.style.transform = 'none';
                satelliteView.style.backgroundPosition = 'center center';
            });
        }

        // --- Header Clock Logic ---
        function updateHeaderClock() {
            const now = new Date();
            const h = String(now.getHours()).padStart(2, '0');
            const m = String(now.getMinutes()).padStart(2, '0');
            const clock = document.getElementById('header-clock');
            if(clock) clock.innerText = `${h}:${m}`;
            
            // Also update Phone Time if visible
            const phoneTime = document.getElementById('phone-time');
            if(phoneTime) phoneTime.innerText = `${h}:${m}`;
        }
        setInterval(updateHeaderClock, 1000);
        // Initial Call
        updateHeaderClock();
    </script>
    <!-- BURNER PHONE UI -->
    <div id="burner-phone" class="phone-container">
        <div class="phone-speaker"></div>
        <div class="phone-body">
            <div class="phone-screen">
                <div class="status-bar">
                    <span> LTE</span>
                    <span class="wanted-stars" id="wanted-stars" style="font-size:14px; letter-spacing:1px;"></span>
                    <span id="phone-time">12:00</span>
                </div>
                
                <!-- View: Contacts -->
                <div class="screen-header" id="phone-header">CONTACTS</div>
                <div class="contact-list" id="phone-contacts">
                    <!-- Contacts go here -->
                </div>
                
                <!-- View: Dialing -->
                <div id="dialing-screen" class="dialing-screen">
                    <div class="dial-text" id="dial-status">DIALING...</div>
                    <div class="dial-number" id="dial-number">555-0192</div>
                </div>
            </div>
            <div class="phone-keypad">
                <div class="key-row">
                    <div class="key-btn call" onclick="if(window.sfx) sfx.select()">CALL</div>
                    <div class="key-btn end" onclick="endCall()">END</div>
                </div>
                <div class="key-grid">
                    <div class="num-key" onclick="handleKey('1')">1</div><div class="num-key" onclick="handleKey('2')">2</div><div class="num-key" onclick="handleKey('3')">3</div>
                    <div class="num-key" onclick="handleKey('4')">4</div><div class="num-key" onclick="handleKey('5')">5</div><div class="num-key" onclick="handleKey('6')">6</div>
                    <div class="num-key" onclick="handleKey('7')">7</div><div class="num-key" onclick="handleKey('8')">8</div><div class="num-key" onclick="handleKey('9')">9</div>
                    <div class="num-key" onclick="handleKey('*')">*</div><div class="num-key" onclick="handleKey('0')">0</div><div class="num-key" onclick="handleKey('#')">#</div>
                </div>
            </div>
        </div>
    </div>
    <!-- Global Audio Player (Persistent) -->
    <audio id="global-audio-player" crossorigin="anonymous" playsinline preload="auto" style="display:none;"></audio>
</body>