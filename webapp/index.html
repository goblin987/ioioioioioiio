<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Los Santos Shop v2.1</title>
    <link rel="preload" href="/webapp/intro.mp4" as="video" type="video/mp4">
    <link rel="preload" href="/webapp/ah_shit.mp3" as="audio">
    <link rel="preload" href="https://raw.githubusercontent.com/marcoguglie/css-smoke-effect/master/smoke.png" as="image">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=UnifrakturMaguntia&display=swap" rel="stylesheet">
    <style>
        @font-face {
            font-family: 'Pricedown';
            src: url('/webapp/pricedown.woff') format('woff');
        }
        
        :root {
            --gta-green: #3fa535;
            --gta-gold: #cfa936;
            --gta-black: #000000;
            --gta-grey: #a0a0a0;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--gta-black);
            color: #fff;
            font-family: 'Pricedown', sans-serif;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
            user-select: none;
        }

        /* Background */
        .bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.8)), url('https://upload.wikimedia.org/wikipedia/commons/thumb/3/3e/Los_Angeles_from_Griffith_Observatory.jpg/1280px-Los_Angeles_from_Griffith_Observatory.jpg');
            background-size: cover;
            background-position: center;
            z-index: -2;
        }

        /* Scanline Effect */
        .scanlines {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.2) 50%, rgba(0,0,0,0.2));
            background-size: 100% 4px;
            z-index: 100;
            pointer-events: none;
            opacity: 0.3;
        }

        /* Header */
        .header {
            padding: 0 15px;
            background: rgba(0, 0, 0, 0.9);
            border-bottom: 2px solid var(--gta-gold);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
            height: 70px;
            box-sizing: border-box;
        }

        .logo {
            font-size: 32px;
            color: var(--gta-gold);
            text-shadow: 2px 2px 0 #000;
        }

        .money {
            color: var(--gta-green);
            font-size: 28px;
            text-shadow: 1px 1px 0 #000;
        }

        /* Wanted Level */
        .wanted-stars {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }
        
        .star {
            font-size: 20px;
            color: #333; /* Inactive */
        }
        
        .star.active {
            color: #fff;
            text-shadow: 0 0 5px #fff;
        }
        
        .star.flashing {
            animation: starFlash 0.5s infinite alternate;
        }
        
        @keyframes starFlash {
            from { color: #fff; opacity: 1; }
            to { color: #cfa936; opacity: 0.8; }
        }

        /* Navigation */
        .nav {
            display: flex;
            justify-content: space-around;
            background: rgba(0, 0, 0, 0.9);
            padding: 10px 0;
            border-top: 2px solid var(--gta-grey);
            z-index: 10;
        }

        .nav-item {
            font-size: 24px;
            color: var(--gta-grey);
            cursor: pointer;
            transition: 0.2s;
        }

        .nav-item.active {
            color: var(--gta-gold);
            transform: scale(1.1);
            text-shadow: 0 0 5px var(--gta-gold);
        }

        /* Content Area */
        .content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        /* Sections */
        .section {
            display: none;
            animation: fadeIn 0.3s ease-in;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Product Grid */
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
        }

        .product-card {
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid var(--gta-grey);
            border-radius: 0;
            padding: 10px;
            text-align: center;
            transition: transform 0.2s;
            position: relative;
            overflow: hidden;
            /* Removed expensive shadow on idle state */
        }

        .product-card:hover {
            border-color: var(--gta-green);
            transform: scale(1.02);
            box-shadow: 0 0 15px rgba(63, 165, 53, 0.3);
        }

        .product-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: var(--gta-gold);
        }

        .product-emoji {
            font-size: 40px;
            margin: 10px 0;
            cursor: pointer;
        }

        .product-name {
            font-family: 'Impact', sans-serif;
            font-size: 18px;
            margin: 5px 0;
            color: #fff;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .product-details {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #ccc;
            margin-bottom: 10px;
        }

        .product-price {
            font-size: 24px;
            color: var(--gta-green);
            margin: 10px 0;
            text-shadow: 1px 1px 0 #000;
        }

        .btn-buy {
            background: var(--gta-green);
            color: #000;
            border: none;
            padding: 5px 15px;
            font-family: 'Pricedown', sans-serif;
            font-size: 20px;
            cursor: pointer;
            width: 100%;
            transition: 0.2s;
        }

        .btn-buy:active {
            transform: scale(0.95);
            background: #fff;
        }

        /* Radio */
        .radio-widget {
            position: fixed;
            top: 80px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            border: 2px solid var(--gta-grey);
            padding: 5px 10px;
            z-index: 99;
            text-align: right;
            transition: 0.3s;
            transform: translateX(90%); /* Hidden by default */
            cursor: pointer;
        }
        
        .radio-widget:hover, .radio-widget.active {
            transform: translateX(0);
        }
        
        .radio-text {
            font-size: 14px;
            color: var(--gta-gold);
            white-space: nowrap;
        }

        /* Search Bar (LSPD) */
        .search-container {
            margin-bottom: 15px;
            border: 2px solid #fff;
            background: #000;
            padding: 5px;
            display: flex;
            align-items: center;
        }
        
        .search-input {
            background: transparent;
            border: none;
            color: var(--gta-green);
            font-family: 'Courier New', monospace;
            font-size: 16px;
            width: 100%;
            outline: none;
            text-transform: uppercase;
        }
        
        .search-label {
            color: #fff;
            font-family: 'Courier New', monospace;
            margin-right: 10px;
            font-weight: bold;
        }

        /* Map Zoom */
        /* --- GTA SA MAP THEME --- */
        .map-container {
            overflow: hidden;
            position: relative;
            height: 400px;
            /* Deep Ocean Blue Background */
            background-color: #0e131a; 
            /* Water Texture Effect */
            background-image: radial-gradient(#151b24 2px, transparent 2px);
            background-size: 30px 30px;
            border: 4px solid #000;
            /* Removed heavy vignette box-shadow for performance */
            border: 4px solid #000;
        }

        /* The Land Mass (Lithuania) */
        .map-img-interactive g {
            /* Reduced drop shadow blur for performance */
            filter: drop-shadow(0 5px 2px rgba(0,0,0,0.8));
        }

        /* City Markers -> "Blips" */
        .district-marker {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: transparent;
            border: none;
            color: #e0e0e0;
            font-family: Arial, Helvetica, sans-serif; /* GTA Menu Font */
            font-weight: 900;
            text-shadow: 2px 2px 0 #000, -1px -1px 0 #000;
            font-size: 14px;
            letter-spacing: 1px;
            text-transform: uppercase;
            pointer-events: none; /* Let clicks pass to the blip */
            transform: translate(-50%, -50%);
            position: absolute;
            transition: 0.2s;
        }

        /* The Yellow Square Blip (Shop/Objective) */
        .blip-icon {
            width: 16px;
            height: 16px;
            background-color: #f0c330; /* GTA Gold */
            border: 2px solid #000;
            margin-bottom: 5px;
            box-shadow: 0 0 4px rgba(240, 195, 48, 0.6); /* Reduced spread */
            transition: transform 0.2s;
            cursor: pointer;
            pointer-events: auto;
        }

        .blip-icon:hover {
            transform: scale(1.5) rotate(90deg);
            background-color: #fff;
        }

        /* Fake "Crosshair" Cursor in center */
        .map-cursor {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 40px;
            height: 40px;
            border: 2px solid rgba(255,255,255,0.5);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 20;
        }
        .map-cursor::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 4px;
            height: 4px;
            background: #fff;
            transform: translate(-50%, -50%);
        }

        .map-img-interactive {
            width: 100%;
            height: 100%;
            object-fit: contain;
            transition: transform 1s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        .zone-poly {
            position: absolute;
            border: 2px solid var(--gta-green);
            background: rgba(63, 165, 53, 0.2);
            display: none;
            pointer-events: none;
        }

        
        /* Mission Passed Overlay */
        .mission-passed-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            z-index: 300;
            pointer-events: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        
        .mp-text {
            font-size: 64px;
            color: var(--gta-gold);
            text-shadow: 3px 3px 0 #000;
            transform: scale(0);
            transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .mp-sub {
            font-size: 32px;
            color: #fff;
            margin-top: 10px;
            opacity: 0;
            transition: opacity 0.5s delay 0.5s;
        }
        
        .mp-active .mp-text { transform: scale(1); }
        .mp-active .mp-sub { opacity: 1; }
        
        /* Map & Stats */
        .placeholder-box {
            background: rgba(0,0,0,0.6);
            padding: 20px;
            border: 2px solid var(--gta-gold);
            text-align: center;
            margin-top: 20px;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            margin: 10px 0;
            border-bottom: 1px solid #333;
            padding-bottom: 5px;
        }
        
        /* Filters */
        .filters {
            display: flex;
            overflow-x: auto;
            gap: 10px;
            padding-bottom: 10px;
            margin-bottom: 15px;
            scrollbar-width: none;
        }
        
        .filter-btn {
            background: rgba(0,0,0,0.8);
            border: 1px solid var(--gta-grey);
            color: #fff;
            padding: 5px 15px;
            font-family: 'Impact', sans-serif;
            font-size: 14px;
            white-space: nowrap;
            cursor: pointer;
        }
        
        .filter-btn.active {
            background: var(--gta-gold);
            color: #000;
            border-color: var(--gta-gold);
        }
        
        .loading {
            text-align: center;
            font-size: 36px;
            color: var(--gta-gold);
            margin-top: 50px;
            animation: blink 1s infinite;
        }
        
        @keyframes blink { 50% { opacity: 0.5; } }

        /* Intro Screen */
        /* Preloader */
        #pre-loader {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #000;
            z-index: 200000;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Impact', sans-serif;
            font-size: 24px;
            color: #444;
            transition: opacity 0.5s;
        }

        /* Main Menu (High Fidelity GTA SA PC) */
        #intro-screen {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: #000;
            z-index: 100000;
            display: block; /* Changed from flex to allow absolute pos */
            transition: opacity 1s ease-out;
        }
        
        .vinewood-bg {
            display: block;
            position: absolute;
            top: 0; right: 0;
            width: 60%; height: 50%;
            background-image: url('https://upload.wikimedia.org/wikipedia/commons/thumb/a/a8/Vinewood_Sign_GTAV.png/640px-Vinewood_Sign_GTAV.png');
            background-size: contain;
            background-position: top right;
            background-repeat: no-repeat;
            -webkit-mask-image: linear-gradient(225deg, rgba(0,0,0,1) 40%, rgba(0,0,0,0) 80%);
            mask-image: linear-gradient(225deg, rgba(0,0,0,1) 40%, rgba(0,0,0,0) 80%);
            opacity: 0.7;
            pointer-events: none;
        }

        .menu-header {
            font-family: 'Diploma', 'Old English Text MT', 'UnifrakturMaguntia', cursive;
            font-size: 70px;
            color: #fff;
            text-shadow: 3px 3px 0 #000;
            position: absolute;
            top: 50px; left: 50px;
            margin: 0;
            line-height: 1;
            text-align: left;
        }

        .menu-options {
            position: absolute;
            bottom: 15%; left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            width: 100%;
        }

        .start-btn {
            font-family: 'Impact', 'Arial Black', sans-serif;
            font-size: 36px;
            color: #a0a0a0; /* Silver */
            background: none;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            display: block;
            font-weight: normal;
            text-transform: uppercase;
            letter-spacing: 2px;
            transform: scaleX(1.1);
        }
        
        .start-btn:hover {
            color: #fff;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
            transform: scaleX(1.1) scale(1.1);
        }
        
        .menu-item-dummy {
            font-family: 'Impact', 'Arial Black', sans-serif;
            font-size: 36px;
            color: #444; /* Dark Grey */
            text-transform: uppercase;
            letter-spacing: 2px;
            transform: scaleX(1.1);
            pointer-events: none;
        }

        /* Realistic Smoke Container */
        .smoke-container {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 100005;
            pointer-events: none;
            display: none;
            background: transparent;
        }

        .smoke-puff {
            position: absolute;
            top: 50%; left: 50%;
            width: 400px; height: 400px; /* Reduced for stability */
            background: url('https://raw.githubusercontent.com/marcoguglie/css-smoke-effect/master/smoke.png') no-repeat center center;
            background-size: contain;
            opacity: 0;
            transform: translate(-50%, -50%) scale(0.5);
        }

        /* Keyframes for dense smoke fill */
        @keyframes smokeFill {
            0% { transform: translate(-50%, -50%) scale(0.5) rotate(0deg); opacity: 0; }
            20% { opacity: 0.8; }
            50% { transform: translate(-50%, -50%) scale(2) rotate(45deg); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(4) rotate(90deg); opacity: 0; } /* Fade out at end */
        }

        .smoke-active .smoke-puff {
            animation: smokeFill 4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        /* Video Bars */
        .cinematic-bar {
            position: fixed;
            left: 0;
            width: 100%;
            height: 12vh; /* 12% height */
            background: #000;
            z-index: 100002; /* Above video */
            transition: transform 0.5s ease-out;
            pointer-events: none;
        }
        .bar-top { top: 0; transform: translateY(-100%); }
        .bar-bottom { bottom: 0; transform: translateY(100%); }
        
        .video-mode .bar-top { transform: translateY(0); }
        .video-mode .bar-bottom { transform: translateY(0); }
        
        #video-intro {
            background: #000; /* Ensure black background behind video */
        }

        /* Full Screen Modals */
        .modal-3d {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 99999;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        /* Terminal Style */
        .terminal-box {
            border: 2px solid var(--gta-green);
            padding: 20px;
            background: rgba(0, 20, 0, 0.95);
            width: 90%;
            max-width: 400px;
            font-family: 'Courier New', monospace;
            box-shadow: 0 0 20px rgba(63, 165, 53, 0.2);
            text-align: center;
        }
        
        .stat-bar-container {
            background: #333;
            height: 15px;
            width: 150px;
            border: 2px solid #000;
            margin-left: auto;
        }
        .stat-bar-fill {
            height: 100%;
            background: var(--gta-green);
        }

        /* Character Overlay - OPTIMIZED */
        .char-overlay {
            position: fixed;
            bottom: 0; 
            right: 0; 
            width: 350px;
            height: 500px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: bottom right;
            z-index: 9000;
            transform: translateX(100%); 
            transition: transform 0.6s cubic-bezier(0.22, 1, 0.36, 1);
            pointer-events: none;
            /* Removed expensive filter: drop-shadow */
        }
        
        .char-visible {
            transform: translateX(0); 
        }
        
        .char-bubble {
            position: absolute;
            bottom: 300px; 
            right: 50px; 
            width: auto;
            background: transparent;
            border: none;
            color: var(--gta-gold);
            padding: 0;
            font-family: 'Pricedown', sans-serif;
            font-size: 48px;
            line-height: 0.9;
            text-shadow: 3px 3px 0 #000; /* Keep hard shadow, cheap */
            -webkit-text-stroke: 1px #000;
            opacity: 0;
            transform: scale(0.5) rotate(-5deg);
            transition: opacity 0.4s, transform 0.4s; /* Removed complex bezier for performance */
            pointer-events: auto;
            text-align: right;
        }
        
        .char-visible .char-bubble {
            opacity: 1;
            transform: scale(1) rotate(0deg);
            transition-delay: 0.3s;
        }

        /* Cinematic Video Frame - OPTIMIZED */
        .video-frame-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 3;
            pointer-events: none;
            /* Replaced box-shadow with cheaper gradient */
            background: radial-gradient(circle, transparent 50%, rgba(0,0,0,0.9) 100%);
        }

        /* Animations */
        @keyframes popIn {
            0% { opacity: 0; transform: scale(0.8) translateY(20px); }
            100% { opacity: 1; transform: scale(1) translateY(0); }
        }

        .product-card {
            /* ... existing styles ... */
            animation: popIn 0.6s cubic-bezier(0.22, 1, 0.36, 1) backwards;
        }

        /* Wasted Overlay */
        .wasted-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 100001; /* Above everything */
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: grayscale(100%) contrast(1.2) blur(2px);
            animation: wastedFade 2s ease-out;
        }
        @keyframes wastedFade { from { opacity: 0; } to { opacity: 1; } }
        
        .wasted-text {
            font-family: 'Pricedown', sans-serif;
            font-size: 80px;
            color: #fff; /* GTA Wasted is usually white/grey with black outline, rarely red in older ones */
            text-shadow: 4px 4px 0 #000;
            background: rgba(0,0,0,0.7);
            padding: 10px 40px;
            border-radius: 10px;
            transform: scale(0);
            animation: wastedPop 0.5s 0.5s forwards cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes wastedPop { to { transform: scale(1); } }

        /* Graffiti Tags */
        .graffiti {
            position: absolute;
            width: 60px;
            height: 40px;
            opacity: 0.4;
            cursor: pointer;
            transition: 0.3s;
            z-index: 5;
            filter: brightness(0.5) sepia(1);
        }
        .graffiti:hover { transform: scale(1.1); opacity: 0.8; }
        .graffiti.found {
            opacity: 1;
            filter: brightness(1) sepia(0) hue-rotate(90deg); /* Greenish */
            pointer-events: none;
        }

        /* 3D Tilt Context */
        .product-grid {
            perspective: 1000px;
        }
        .product-card {
            transform-style: preserve-3d;
            /* existing styles... */
        }

    </style>
</head>
<body>
    <!-- Wasted Overlay -->
    <div id="wasted-overlay" class="wasted-overlay" onclick="closeWasted()">
        <div class="wasted-text">WASTED</div>
    </div>

    <div id="pre-loader">LOADING...</div>

    <!-- Cinematic Bars -->
    <div class="cinematic-bar bar-top"></div>
    <div class="cinematic-bar bar-bottom"></div>

    <!-- Smoke Transition Overlay -->
    <div id="smoke-overlay" class="smoke-container">
        <div class="smoke-puff"></div>
        <div class="smoke-puff" style="animation-delay: -1s; left: 30%;"></div>
        <div class="smoke-puff" style="animation-delay: -2s; left: 70%;"></div>
    </div>

    <!-- Intro Screen (Main Menu) -->
    <div id="intro-screen">
        <div class="vinewood-bg"></div>
        <div class="menu-header">Main<br>Menu</div>
        
        <div class="menu-options">
            <button class="start-btn" onclick="startApp()">START GAME</button>
            <div class="menu-item-dummy">OPTIONS</div>
            <div class="menu-item-dummy">QUIT GAME</div>
        </div>
    </div>

    <!-- Character Layer -->
    <div id="char-layer" class="char-overlay">
        <div id="char-text" class="char-bubble">WELCOME!</div>
    </div>

    <!-- Audio Elements -->
    <div class="radio-widget" onclick="toggleRadio()">
        <div class="radio-text">ðŸ“» RADIO OFF</div>
    </div>

    <div class="bg"></div>
    <div class="scanlines"></div>

    <!-- Header with Stars -->
    <div class="header">
        <div style="display: flex; flex-direction: column; justify-content: center;">
            <div class="logo" style="font-size: 28px; line-height: 1; margin-bottom: 2px;">LOS SANTOS</div>
            <div class="wanted-stars" id="stars" style="margin-top: 0;">
                <span class="star">â˜…</span><span class="star">â˜…</span><span class="star">â˜…</span><span class="star">â˜…</span><span class="star">â˜…</span>
            </div>
        </div>
        <div class="money" id="money">$00000000</div>
    </div>

    <!-- Mission Passed Overlay -->
    <div class="mission-passed-overlay" id="mp-overlay" style="display:none;">
        <div class="mp-text">MISSION PASSED!</div>
        <div class="mp-sub">RESPECT +</div>
    </div>


    <!-- Basket Modal -->
    <div id="basket-modal" class="modal-3d" style="display:none;">
        <div class="terminal-box" style="height: 80vh; display:flex; flex-direction:column; text-align:left;">
            <div style="border-bottom: 2px solid var(--gta-green); padding-bottom:10px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
                <span style="font-size:24px; color:var(--gta-gold);">AMMUNATION CART</span>
                <button style="background:#900; color:#fff; border:1px solid #fff; font-family:'Courier New'; cursor:pointer;" onclick="closeBasket()">[X]</button>
            </div>
            <div id="basket-items" style="flex:1; overflow-y:auto; border:1px solid #333; padding:10px; margin-bottom:10px;">
                <!-- Items go here -->
            </div>
            <div style="border-top: 2px solid var(--gta-green); padding-top:10px;">
                <div style="display:flex; justify-content:space-between; font-size:20px; margin-bottom:15px;">
                    <span>TOTAL:</span>
                    <span id="basket-total" style="color:var(--gta-green);">$0.00</span>
                </div>
                <button class="btn-buy" onclick="initCheckout()" style="width:100%;">INITIATE TRANSFER (SOL)</button>
            </div>
        </div>
    </div>

    <!-- Invoice Modal -->
    <div id="invoice-modal" class="modal-3d" style="display:none;">
        <div class="terminal-box">
            <div style="color:var(--gta-gold); font-size:20px; border-bottom:1px dashed var(--gta-green); padding-bottom:10px; margin-bottom:20px;">
                SECURE TRANSACTION TERMINAL
            </div>
            
            <div style="margin-bottom:20px;">
                <div style="font-size:12px; color:#aaa;">AMOUNT DUE:</div>
                <div id="invoice-amount" style="font-size:32px; color:var(--gta-green); margin:5px 0; cursor:pointer;" onclick="copyText('invoice-amount')">0.00 SOL</div>
                <div style="font-size:10px; color:#555;">(CLICK TO COPY)</div>
            </div>
            
            <div id="qrcode" style="background:#fff; padding:10px; display:inline-block; margin-bottom:20px; border:2px solid var(--gta-green);"></div>
            
            <div style="margin-bottom:20px; text-align:left;">
                <div style="font-size:12px; color:#aaa;">DESTINATION ADDRESS:</div>
                <div id="invoice-address" style="font-size:12px; word-break:break-all; background:#111; padding:10px; border:1px solid #333; color:#fff; margin-top:5px; cursor:pointer;" onclick="copyText('invoice-address')">...</div>
                <div style="font-size:10px; color:#555; text-align:center;">(CLICK TO COPY)</div>
            </div>
            
            <div class="loading" style="font-size:14px;">AWAITING CONFIRMATION<span class="blink">...</span></div>
            
            <button class="btn-buy" style="margin-top:20px; background:#300; border-color:#900;" onclick="closeInvoice()">CANCEL OPERATION</button>
        </div>
    </div>

    <!-- Review Modal -->
    <div id="review-modal" class="modal-3d" style="display:none;">
        <div class="terminal-box" style="max-width:350px;">
            <div style="font-size:24px; color:var(--gta-gold); margin-bottom:20px;">TRANSACTION COMPLETE</div>
            <div style="margin-bottom:20px;">RATE SERVICE:</div>
            <div style="margin-bottom:20px; font-size:32px; cursor:pointer;" id="review-stars">
                <span onclick="setReview(1)">â˜…</span>
                <span onclick="setReview(2)">â˜…</span>
                <span onclick="setReview(3)">â˜…</span>
                <span onclick="setReview(4)">â˜…</span>
                <span onclick="setReview(5)">â˜…</span>
            </div>
            <textarea id="review-text" placeholder="FEEDBACK (OPTIONAL)..." style="width:100%; height:80px; background:#111; color:var(--gta-green); border:1px solid var(--gta-green); font-family:'Courier New'; padding:10px; margin-bottom:20px; box-sizing:border-box; outline:none;"></textarea>
            <button class="btn-buy" onclick="submitReview()">SUBMIT & CLOSE</button>
        </div>
    </div>

    <div class="content">
        <!-- Video Intro -->
        <div id="video-intro" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:#000; z-index:99990; align-items:center; justify-content:center;">
            <div class="video-frame-overlay"></div> <!-- CINEMATIC OVERLAY -->
            <div id="video-loading" style="position:absolute; color:#555; font-family:'Courier New'; z-index:1;">BUFFERING...</div>
            <video id="intro-vid" style="width:100%; height:100%; object-fit:contain; position:relative; z-index:2; transform: translateZ(0); will-change: transform;" playsinline webkit-playsinline preload="auto" muted>
                <source src="/webapp/intro.mp4" type="video/mp4">
            </video>
            <div id="play-overlay" style="display:none; position:absolute; z-index:4; color:#fff; border:2px solid #fff; padding:10px 20px; cursor:pointer; background:rgba(0,0,0,0.7);" onclick="forcePlayVideo()">[ RETRY PLAY ]</div>
            <div style="position:absolute; bottom:20px; right:20px; color:rgba(255,255,255,0.5); font-family:'Courier New'; font-size:12px; cursor:pointer; z-index:4; border:1px solid #555; padding:5px; background:rgba(0,0,0,0.5);" onclick="skipIntro()">[ SKIP INTRO ]</div>
        </div>

        <!-- SHOP SECTION -->
        <div id="shop" class="section active">
            <!-- LSPD Search -->
            <div class="search-container">
                <span class="search-label">LSPD DATABASE > SEARCH:</span>
                <input type="text" class="search-input" placeholder="ENTER ITEM NAME..." oninput="filterSearch(this.value)">
            </div>

            <div class="filters" id="city-filters">
                <button class="filter-btn active" onclick="filterProducts('all')">ALL ZONES</button>
            </div>
            <div class="product-grid" id="product-grid">
                <div class="loading">LOADING STOCK...</div>
            </div>
        </div>

        <!-- MAP SECTION -->
        <div id="map" class="section">
            <div class="placeholder-box" style="padding: 0; border: none;">
                <div class="map-container" id="map-container">
                    <!-- Crosshair UI -->
                    <div class="map-cursor"></div>

                    <!-- Map SVG -->
                    <svg id="map-img" class="map-img-interactive" viewBox="0 0 1024 1024" preserveAspectRatio="xMidYMid meet">
                        <defs>
                            <!-- PAPER MAP TEXTURE -->
                            <pattern id="city-texture" width="60" height="60" patternUnits="userSpaceOnUse">
                                <!-- Land Base -->
                                <rect width="60" height="60" fill="#3e4348"/> <!-- GTA Dark Grey Land -->
                                
                                <!-- Roads (Light Grey Lines) -->
                                <path d="M 30 0 L 30 60 M 0 30 L 60 30" stroke="#52575d" stroke-width="3" fill="none"/>
                                <path d="M 0 0 L 60 60" stroke="#52575d" stroke-width="1" fill="none" opacity="0.5"/>
                                
                                <!-- City Blocks (Lighter Grey Areas) -->
                                <rect x="5" y="5" width="20" height="20" fill="#2d3236"/>
                                <rect x="35" y="35" width="20" height="20" fill="#2d3236"/>
                                
                                <!-- Parks (Green Patches) -->
                                <rect x="35" y="5" width="15" height="15" fill="#5a6e5a" opacity="0.8"/>
                            </pattern>
                        </defs>
                        <g transform="translate(0,1024) scale(0.1,-0.1)">
                            <!-- Fill with Grid, Stroke with Neon Green -->
                            <path d="M6713 9109 c-27 -17 -33 -27 -33 -57 0 -33 -1 -34 -14 -17 -13 19
-16 18 -66 -13 -28 -18 -63 -32 -78 -32 -50 0 -67 -11 -96 -60 -17 -28 -39
-51 -52 -54 -46 -12 -105 -75 -143 -151 l-36 -76 -102 -35 -102 -35 -81 41
c-44 22 -100 43 -124 46 -39 6 -50 2 -122 -43 -43 -27 -105 -59 -137 -72 l-57
-23 -83 26 c-61 19 -105 43 -172 91 -49 36 -106 76 -125 90 -33 23 -48 25
-183 31 l-147 7 0 27 0 28 -65 -6 c-50 -3 -75 -1 -104 13 l-38 17 -64 -47
c-45 -33 -69 -45 -83 -40 -12 3 -59 12 -106 20 -47 7 -141 33 -210 58 -121 42
-127 43 -180 32 -30 -6 -79 -20 -108 -30 -47 -17 -52 -22 -52 -49 0 -27 -9
-37 -72 -78 -84 -54 -88 -54 -148 26 -32 43 -40 61 -40 96 0 38 -5 48 -49 89
-85 80 -104 92 -140 81 -33 -9 -98 -56 -143 -102 -17 -18 -36 -28 -55 -28 -17
0 -56 -9 -89 -20 -73 -26 -104 -20 -152 30 -25 25 -63 48 -120 70 l-82 32 -98
-12 c-57 -7 -158 -11 -247 -8 -135 4 -160 8 -246 36 -121 40 -245 45 -294 11
-62 -42 -207 -110 -258 -120 -38 -8 -63 -21 -92 -49 -22 -21 -53 -42 -70 -46
-16 -4 -55 -19 -85 -34 -50 -24 -62 -26 -132 -21 -82 6 -140 -1 -146 -18 -11
-32 -51 -76 -77 -84 -16 -5 -65 -36 -108 -69 l-79 -60 -76 11 c-85 13 -87 12
-96 -54 -6 -38 -13 -45 -85 -94 l-79 -53 -12 -77 c-25 -171 -33 -194 -65 -203
-17 -4 -66 -3 -113 4 -73 11 -86 10 -110 -4 -24 -15 -28 -25 -33 -85 -4 -37
-7 -113 -8 -168 -1 -73 -8 -125 -27 -195 -24 -88 -25 -104 -18 -215 4 -66 6
-179 5 -250 -3 -119 -1 -135 22 -185 13 -30 34 -64 46 -74 35 -32 71 -125 96
-251 13 -67 38 -151 55 -188 21 -48 38 -112 55 -210 30 -183 26 -268 -17 -346
-28 -51 -61 -141 -52 -141 2 0 23 12 46 26 40 25 42 26 55 8 7 -10 13 -32 13
-49 0 -18 9 -58 20 -90 26 -74 26 -101 0 -108 -16 -4 -20 -14 -20 -47 0 -38 2
-41 23 -34 12 4 38 17 57 30 47 33 118 33 146 2 41 -47 73 -106 79 -149 7 -44
7 -45 68 -67 34 -12 81 -22 104 -22 24 0 64 -8 91 -18 66 -25 197 -116 218
-151 19 -31 91 -71 130 -71 16 0 35 -11 52 -32 15 -17 58 -46 100 -65 61 -28
85 -33 146 -33 42 0 79 -5 89 -13 10 -7 21 -35 26 -66 10 -60 33 -85 89 -96
39 -7 63 9 82 56 7 16 22 32 35 35 21 5 244 0 502 -12 128 -5 132 -5 170 19
61 40 97 43 142 14 l38 -26 5 -88 c3 -48 11 -112 18 -141 10 -46 16 -55 52
-73 32 -16 50 -19 89 -14 47 7 48 6 55 -21 4 -16 17 -36 28 -45 17 -14 18 -19
7 -33 -19 -23 -6 -34 98 -85 l90 -44 3 -86 c2 -47 0 -121 -6 -165 l-9 -78 -41
-18 c-26 -11 -53 -34 -74 -64 -18 -25 -39 -46 -47 -46 -8 0 -26 -4 -40 -10
-26 -10 -26 -10 -9 -39 17 -29 17 -30 -14 -56 -30 -25 -32 -32 -32 -88 0 -34
-5 -100 -11 -147 -6 -47 -12 -121 -14 -165 -1 -44 -10 -109 -19 -145 -25 -104
-21 -160 17 -238 19 -37 50 -110 70 -162 51 -130 50 -130 81 -101 13 13 30 35
36 51 9 21 20 29 48 34 63 10 101 7 140 -13 20 -10 63 -26 94 -35 49 -14 57
-20 63 -46 8 -36 24 -46 88 -55 53 -8 56 -14 26 -41 -45 -41 -43 -50 20 -88
40 -25 71 -36 97 -36 22 0 48 -7 58 -15 11 -8 28 -15 37 -15 11 0 29 -20 46
-52 24 -44 34 -53 73 -64 25 -8 70 -14 101 -14 65 0 74 -6 125 -85 21 -33 65
-87 97 -120 l58 -60 52 -207 c48 -194 50 -208 35 -225 -10 -10 -26 -47 -37
-81 l-19 -63 24 -16 c18 -12 24 -24 24 -53 l0 -37 74 -21 c56 -17 88 -33 127
-67 48 -41 57 -44 88 -39 20 4 58 18 84 31 41 20 53 22 85 13 54 -15 59 -13
71 20 12 35 16 36 59 10 37 -23 66 -19 167 20 49 19 52 19 110 2 46 -13 80
-16 146 -12 85 5 86 5 139 53 36 32 58 46 69 41 9 -3 43 -16 76 -27 75 -26 82
-31 91 -70 7 -31 51 -107 63 -107 3 0 23 5 43 10 31 9 42 8 63 -6 14 -9 43
-20 65 -24 39 -7 39 -7 157 104 65 62 136 123 158 135 22 13 52 37 66 54 25
29 30 30 90 28 41 -1 74 4 91 13 26 14 29 13 43 -7 8 -12 15 -34 15 -49 0 -33
5 -34 65 -8 26 11 66 20 90 20 41 0 44 2 59 40 10 26 16 70 16 122 0 76 -3 88
-40 159 l-40 77 28 10 c18 6 34 23 46 51 18 38 22 41 58 41 22 0 73 14 113 31
l74 31 57 -46 c62 -51 59 -50 118 -35 36 9 56 26 135 115 94 106 119 152 136
252 6 37 10 42 34 42 15 0 50 -7 77 -15 44 -13 58 -13 132 2 70 13 86 20 100
42 43 68 85 111 109 111 26 0 71 -44 145 -142 l36 -49 -39 -36 -40 -36 22 -23
22 -23 -26 -10 c-31 -12 -44 -50 -27 -82 7 -12 17 -42 24 -66 6 -25 14 -44 19
-44 4 1 60 1 126 1 116 0 119 0 156 30 21 16 47 30 58 30 11 0 39 11 63 25 48
28 48 31 60 198 l6 99 -37 54 c-21 30 -50 63 -65 74 -18 13 -31 35 -39 65
l-11 45 -79 -41 c-83 -44 -130 -51 -183 -30 -27 10 -28 14 -28 76 0 62 4 74
71 203 57 112 70 143 66 172 -5 40 16 173 33 210 7 15 31 34 60 46 66 30 120
108 120 175 0 61 -23 123 -60 165 -42 48 -42 109 1 187 l31 57 -21 62 c-34
100 -23 178 23 178 7 0 26 10 41 22 25 20 27 25 21 72 -3 28 -9 78 -11 111
l-6 60 60 45 c48 36 63 54 76 93 25 73 66 90 220 91 l120 1 95 49 c52 27 97
53 99 59 2 6 27 45 56 87 34 50 54 91 59 120 4 25 11 68 16 95 5 28 9 73 9
101 1 47 5 55 36 83 39 34 81 40 145 21 19 -6 64 -14 99 -19 63 -8 63 -8 73
20 14 42 39 44 115 8 74 -34 137 -50 168 -43 11 3 31 21 44 41 20 32 23 45 19
103 -4 55 -1 74 16 107 30 58 92 123 129 135 41 14 100 57 128 92 l22 28 -20
26 c-30 40 -60 52 -136 52 -54 0 -75 4 -94 20 -33 26 -88 26 -148 0 l-47 -20
-90 25 c-80 22 -117 43 -118 68 0 4 20 44 44 90 24 45 50 107 56 137 16 69 44
131 68 154 19 16 19 18 -4 74 -38 92 -30 137 31 194 46 42 54 79 55 245 l0
131 -27 6 c-16 3 -57 11 -93 17 -36 7 -85 23 -109 37 -34 20 -61 27 -113 29
-66 2 -70 4 -136 57 -98 78 -222 254 -222 317 0 8 -18 39 -39 68 -29 39 -61
65 -123 100 -66 38 -93 60 -131 111 -30 40 -65 74 -95 90 -106 60 -290 195
-345 256 -33 35 -95 92 -139 126 -82 63 -118 116 -118 172 0 34 -40 48 -115
40 -61 -6 -64 -6 -111 30 l-48 37 -30 -29 -31 -29 -155 9 c-121 6 -166 13
-205 29 -33 14 -86 25 -155 30 -58 5 -116 11 -130 15 -47 13 -89 52 -101 97
-21 78 -70 172 -113 217 -39 41 -45 55 -70 158 -29 116 -114 343 -131 349 -6
1 -25 -7 -42 -18z" fill="url(#city-texture)" stroke="#1f2429" stroke-width="30"/>
                        </g>
                    </svg>
                    
                    <!-- Styled Blips -->
                    <div class="district-marker" style="top: 75%; left: 70%;">
                        <div class="blip-icon" onclick="zoomMap('Vilnius', 75, 70)"></div>
                        VILNIUS
                    </div>
                    
                    <div class="district-marker" style="top: 65%; left: 50%;">
                        <div class="blip-icon" onclick="zoomMap('Kaunas', 65, 50)"></div>
                        KAUNAS
                    </div>
                    
                    <div class="district-marker" style="top: 35%; left: 15%;">
                        <div class="blip-icon" onclick="zoomMap('Klaipeda', 35, 15)"></div>
                        KLAIPEDA
                    </div>
                    
                    <!-- Mock District Zones (Visible on Zoom) -->
                    <div id="zone-vilnius" class="zone-poly" style="top: 70%; left: 65%; width: 10%; height: 10%; border-radius: 50%;"></div>
                    <div id="zone-kaunas" class="zone-poly" style="top: 60%; left: 45%; width: 10%; height: 10%; border-radius: 50%;"></div>
                    <div id="zone-klaipeda" class="zone-poly" style="top: 30%; left: 10%; width: 10%; height: 10%; border-radius: 50%;"></div>
                </div>
                <button class="btn-buy" onclick="resetMap()" style="margin-top: 10px;">RESET VIEW</button>
            </div>
        </div>

        <!-- STATS SECTION with Character Selection -->
        <div id="stats" class="section">
            <div class="placeholder-box">
                <div style="font-size: 32px; margin-bottom: 20px; color: var(--gta-gold);">PLAYER STATS</div>
                <div style="display: flex; gap: 20px; align-items: center; justify-content: center; margin-bottom: 20px;">
                    <img src="https://placehold.co/150x200/000000/3fa535?text=CJ" id="char-img" style="height: 150px; border: 2px solid #fff;">
                    <div>
                        <button class="filter-btn" onclick="changeSkin('cj')">CJ</button>
                        <button class="filter-btn" onclick="changeSkin('sweet')">SWEET</button>
                        <button class="filter-btn" onclick="changeSkin('ryder')">RYDER</button>
                    </div>
                </div>
                <div class="stat-row" style="align-items:center;">
                    <span>RESPECT</span>
                    <div class="stat-bar-container"><div class="stat-bar-fill" style="width:100%"></div></div>
                </div>
                <div class="stat-row" style="align-items:center;">
                    <span>STAMINA</span>
                    <div class="stat-bar-container"><div class="stat-bar-fill" style="width:70%"></div></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation -->
    <div class="nav">
        <div class="nav-item active" id="nav-shop" onclick="sfx.select(); showSection('shop')">SHOP</div>
        <div class="nav-item" id="nav-map" onclick="sfx.select(); showSection('map')">MAP</div>
        <div class="nav-item" id="nav-stats" onclick="sfx.select(); showSection('stats')">STATS</div>
        <div class="nav-item" id="nav-basket" onclick="sfx.select(); openBasket()">CART (<span id="basket-count">0</span>)</div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.MainButton.hide();
        
        // Init Scavenger
        setTimeout(initGraffiti, 2000);

        // --- Sound FX System (Synthesized) ---
        const sfx = {
            ctx: null,
            // ... (keep sfx object)
            init: function() {
                if(!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)();
            },
            playTone: function(freq, type, duration, vol=0.1) {
                this.init();
                if(this.ctx.state === 'suspended') this.ctx.resume();
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                gain.gain.setValueAtTime(vol, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start();
                osc.stop(this.ctx.currentTime + duration);
            },
            tick: function() { this.playTone(800, 'triangle', 0.05, 0.05); }, 
            select: function() { this.playTone(300, 'square', 0.1, 0.1); }, 
            cash: function() { 
                this.playTone(1200, 'sine', 0.1, 0.1); 
                setTimeout(() => this.playTone(1600, 'sine', 0.2, 0.1), 100);
            },
            wasted: function() { this.playTone(50, 'sawtooth', 1.0, 0.3); },
            spray: function() { this.playTone(400, 'sawtooth', 0.2, 0.05); }
        };

        // --- Day/Night Cycle ---
        function checkDayNight() {
            const hour = new Date().getHours();
            const isNight = hour < 6 || hour > 20;
            if(isNight) {
                document.querySelector('.bg').style.backgroundImage = "linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.9)), url('https://upload.wikimedia.org/wikipedia/commons/thumb/5/5a/Los_Angeles_night_lights.jpg/1280px-Los_Angeles_night_lights.jpg')";
            }
        }

        // 3D Tilt Disabled (Mobile Optimization)
        // Graffiti Hunt Disabled (Optimization)

        // --- Cheat Codes ---
        let keyBuffer = "";
        document.addEventListener('keydown', (e) => {
            keyBuffer += e.key.toLowerCase();
            if(keyBuffer.length > 20) keyBuffer = keyBuffer.slice(-20);
            
            if(keyBuffer.endsWith("hesoyam")) {
                activateCheat();
            }
        });
        
        function activateCheat() {
            sfx.cash();
            document.getElementById('money').innerText = "$25000000";
            document.getElementById('money').style.color = "#fff";
            charSystem.show('cj', "HESOYAM ACTIVATED!", 2000);
            // Reset color
            setTimeout(() => document.getElementById('money').style.color = "var(--gta-green)", 1000);
        }

        // --- Wasted Logic ---
        function triggerWasted() {
            const el = document.getElementById('wasted-overlay');
            el.style.display = 'flex';
            sfx.wasted();
            // Slow motion effect via CSS?
            document.body.style.transition = "filter 2s";
            document.body.style.filter = "grayscale(1)";
        }
        
        function closeWasted() {
            document.getElementById('wasted-overlay').style.display = 'none';
            document.body.style.filter = "none";
        }

        // --- Graffiti Scavenger Hunt (Disabled for performance) ---
        
        // --- Init New Systems ---
        checkDayNight();
        
        // ... existing logic ...

        // --- Character System ---
        const charSystem = {
            el: null,
            text: null,
            timer: null,
            
            init: function() {
                this.el = document.getElementById('char-layer');
                this.text = document.getElementById('char-text');
            },
            
            show: function(charName, message, duration=4000) {
                if(!this.el) this.init();
                
                let url = "https://upload.wikimedia.org/wikipedia/en/c/ce/Carl_Johnson_GTA_SA.png"; 
                if(charName === 'ryder') url = "https://upload.wikimedia.org/wikipedia/en/3/3f/Ryder_GTA_SA.png"; 
                if(charName === 'smoke') url = "https://upload.wikimedia.org/wikipedia/en/1/17/Big_Smoke_GTA_SA.png";
                
                this.el.style.backgroundImage = `url('${url}')`;
                this.text.innerText = message;
                
                this.el.classList.add('char-visible');
                
                if(this.timer) clearTimeout(this.timer);
                this.timer = setTimeout(() => {
                    this.el.classList.remove('char-visible');
                }, duration);
            }
        };

        // Init
        function hideLoader() {
            const pl = document.getElementById('pre-loader');
            if(pl && pl.style.display !== 'none') {
                pl.style.opacity = '0';
                setTimeout(() => pl.style.display = 'none', 500);
            }
        }

        window.onload = () => {
            hideLoader();
        };
        
        // Failsafe: Force hide loader after 3 seconds max
        setTimeout(hideLoader, 3000);

        // Global Asset Preload
        const audioFx = new Audio('/webapp/ah_shit.mp3');
        audioFx.preload = 'auto';

        function startApp() {
            try {
                const btn = document.querySelector('.start-btn');
                if(btn) {
                    // Flash White (Authentic)
                    btn.style.color = "#fff";
                    btn.style.textShadow = "0 0 20px #fff";
                    btn.style.pointerEvents = "none"; 
                }

                // 1. Smoke ON (Instant)
                const smoke = document.getElementById('smoke-overlay');
                if(smoke) {
                    smoke.style.display = 'block';
                    void smoke.offsetWidth; // Force Reflow
                    smoke.classList.add('smoke-active');
                }

                // 2. Audio
                audioFx.volume = 1.0;
                const p = audioFx.play();
                if(p !== undefined) {
                    p.catch(e => console.log("Audio block:", e));
                }

                // 3. Video Prep
                const vid = document.getElementById('intro-vid');
                if(vid) {
                    vid.muted = true;
                    vid.preload = "auto";
                }

                // 4. Transition
                setTimeout(performTransition, 2500);

            } catch (err) {
                console.error("Start Crash:", err);
                skipIntro(true);
            }
        }

        function performTransition() {
            try {
                // Start Radio
                toggleRadio(true);

                // Hide Menu
                const menu = document.getElementById('intro-screen');
                if(menu) menu.style.opacity = '0';

                // Show Video
                const vidContainer = document.getElementById('video-intro');
                const vid = document.getElementById('intro-vid');
                
                if (!vid || vid.error) {
                    skipIntro(true);
                    return;
                }

                vidContainer.style.display = 'flex';
                document.body.classList.add('video-mode');

                const playPromise = vid.play();
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        document.getElementById('video-loading').style.display = 'none';
                        
                        // Fade Out Smoke
                        const smoke = document.getElementById('smoke-overlay');
                        if(smoke) {
                            smoke.style.transition = "opacity 1.5s ease-out";
                            smoke.style.opacity = '0';
                            setTimeout(() => {
                                smoke.style.display = 'none';
                                smoke.classList.remove('smoke-active');
                                if(menu) menu.style.display = 'none';
                            }, 1500);
                        }
                    }).catch(error => {
                        console.log("Video Play Failed:", error);
                        // Hide smoke on error
                        const smoke = document.getElementById('smoke-overlay');
                        if(smoke) smoke.style.display = 'none';
                        document.getElementById('play-overlay').style.display = 'block';
                    });
                }
                
                vid.onended = () => skipIntro();

            } catch (e) {
                console.error("Transition Error:", e);
                skipIntro(true);
            }
        }

        function forcePlayVideo() {
            const vid = document.getElementById('intro-vid');
            document.getElementById('play-overlay').style.display = 'none';
            document.getElementById('video-loading').style.display = 'block';
            
            vid.muted = false;
            vid.play().then(() => {
                document.getElementById('video-loading').style.display = 'none';
            }).catch(e => {
                vid.muted = true;
                vid.play();
            });
        }
        
        function skipIntro(immediate = false) {
            const vidContainer = document.getElementById('video-intro');
            const vid = document.getElementById('intro-vid');
            if(vid && !vid.paused) vid.pause();
            
            // Remove Cinematic Bars
            document.body.classList.remove('video-mode');
            const lb = document.getElementById('loading-bar-container');
            if(lb) lb.style.display = 'none';
            
            // Start Radio when intro ends
            toggleRadio(true); // Force start radio

            if(immediate) {
                 vidContainer.style.display = 'none';
                 showSection('shop');
                 charSystem.show('cj', "WELCOME TO THE SHOP!");
                 return;
            }

            // Fade out video
            vidContainer.style.transition = "opacity 1s";
            vidContainer.style.opacity = "0";
            
            setTimeout(() => {
                vidContainer.style.display = 'none';
                showSection('shop'); 
                charSystem.show('cj', "WELCOME TO THE SHOP!");
            }, 1000);
        }

        let allProducts = [];
        let currentStation = 0;
        // SomaFM Streams (Reliable HTTPS)
        const stations = [
            { name: "RADIO OFF", src: null },
            { name: "RADIO LOS SANTOS", src: "https://ice2.somafm.com/groovesalad-128-mp3" }, // Rebranded Groove Salad
            { name: "K-JAH WEST", src: "https://ice2.somafm.com/secretagent-128-mp3" }, // Rebranded Secret Agent
            { name: "SF-UR", src: "https://ice2.somafm.com/defcon-128-mp3" } // Electronic
        ];
        let audioPlayer = null;

        // --- Logic ---

        async function loadProducts() {
            try {
                const response = await fetch('/webapp/api/products');
                const data = await response.json();
                if(data.success) {
                    allProducts = data.products;
                    renderProducts(allProducts);
                    renderFilters(allProducts);
                    updateStars(Math.floor(Math.random() * 6)); // Mock stars for now
                } else {
                    document.getElementById('product-grid').innerHTML = '<div class="loading" style="color:red">ERROR</div>';
                }
            } catch (e) {
                document.getElementById('product-grid').innerHTML = '<div class="loading" style="color:red">OFFLINE</div>';
            }
        }

        function renderProducts(products) {
            console.log("Render Products v2.1 - Strict Cleaning");
            const grid = document.getElementById('product-grid');
            grid.innerHTML = '';
            
            // Group products by Cleaned Name + Type + City + Size + Price
            const groups = {};
            products.forEach(p => {
                // CLEAN NAME: Remove any sequence of 6+ digits/underscores (IDs)
                // This handles cases where ID is stuck to the name in DB
                let cleanName = p.name.replace(/[\d_]{6,}.*/g, '').trim();
                
                // Also remove trailing numbers if they look like IDs
                cleanName = cleanName.replace(/\s\d+$/, '').trim();

                const key = `${cleanName.toLowerCase()}|${p.type}|${p.city}|${p.size}|${p.price}`;
                
                if(!groups[key]) {
                    groups[key] = { 
                        ...p, 
                        display_name: cleanName, // Store cleaned name for display
                        count: 0, 
                        ids: [] 
                    };
                }
                groups[key].count++;
                groups[key].ids.push(p.id);
            });
            
            const uniqueProducts = Object.values(groups);

            if(uniqueProducts.length === 0) {
                grid.innerHTML = '<div style="text-align:center; width:100%">NO ITEMS FOUND</div>';
                return;
            }
            
            uniqueProducts.forEach((p, index) => {
                const card = document.createElement('div');
                card.className = 'product-card';
                // Staggered Animation
                card.style.animationDelay = `${index * 0.05}s`;
                
                const countBadge = p.count > 1 ? `<div style="position:absolute; top:5px; right:5px; background:var(--gta-gold); color:#000; padding:2px 6px; font-size:12px; border-radius:4px; font-weight:bold;">x${p.count}</div>` : '';
                
                card.innerHTML = `
                    ${countBadge}
                    <div class="product-emoji">${getProductEmoji(p.type)}</div>
                    <div class="product-name">${p.display_name}</div>
                    <div class="product-details">${p.size} | ${p.city}</div>
                    <div class="product-price">$${p.price.toFixed(2)}</div>
                    <div style="display:flex; gap:5px;">
                        <button class="btn-buy" style="font-size:14px; flex:1;" onmouseover="sfx.tick()" onclick="sfx.select(); addToBasket(${p.ids[0]}, '${p.display_name}', ${p.price})">ADD</button>
                        <button class="btn-buy" style="flex:2;" onmouseover="sfx.tick()" onclick="sfx.select(); buyNow(${p.ids[0]}, '${p.display_name}', ${p.price})">BUY</button>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        // Sound FX (Old removed, using sfx object now)

        // LSPD Search
        function filterSearch(query) {
            const term = query.toLowerCase();
            const filtered = allProducts.filter(p => 
                p.name.toLowerCase().includes(term) || 
                p.city.toLowerCase().includes(term)
            );
            renderProducts(filtered);
        }

        // Filters
        function renderFilters(products) {
            const cities = [...new Set(products.map(p => p.city))];
            const container = document.getElementById('city-filters');
            container.innerHTML = '<button class="filter-btn active" onclick="filterProducts(\'all\')">ALL ZONES</button>';
            cities.forEach(city => {
                const btn = document.createElement('button');
                btn.className = 'filter-btn';
                btn.innerText = city.toUpperCase();
                btn.onclick = () => filterProducts(city);
                container.appendChild(btn);
            });
        }

        function filterProducts(city) {
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            if(city === 'all') renderProducts(allProducts);
            else renderProducts(allProducts.filter(p => p.city === city));
        }

        // Stars
        function updateStars(count) {
            const stars = document.querySelectorAll('.star');
            stars.forEach((s, i) => {
                s.classList.remove('active', 'flashing');
                if (i < count) s.classList.add('active');
                if (count === 5) s.classList.add('flashing');
            });
        }

        // Radio - Native HTML5 Audio
        function toggleRadio(forceStart = false) {
            if(!forceStart) {
                // Stop previous
                if(audioPlayer) {
                    audioPlayer.pause();
                    audioPlayer.src = "";
                    audioPlayer = null;
                }
                currentStation = (currentStation + 1) % stations.length;
            } else {
                // Start at station 1 (Los Santos)
                currentStation = 1;
            }

            const station = stations[currentStation];
            const widget = document.querySelector('.radio-widget');
            
            document.querySelector('.radio-text').innerText = "ðŸ“» " + station.name;
            widget.classList.add('active');
            setTimeout(() => widget.classList.remove('active'), 3000);

            if(station.src) {
                try {
                    if(audioPlayer) { audioPlayer.pause(); } // Safety check
                    audioPlayer = new Audio(station.src);
                    audioPlayer.crossOrigin = "anonymous";
                    audioPlayer.volume = 0.5;
                    
                    const playPromise = audioPlayer.play();
                    if (playPromise !== undefined) {
                        playPromise.catch(error => {
                            console.log("Radio Play Blocked: " + error);
                        });
                    }
                } catch(e) {
                    console.log("Audio Error: " + e);
                }
            }
        }

        // Map Zoom
        function zoomMap(cityName, topPerc, leftPerc) {
            const map = document.getElementById('map-img');
            
            // Hide all markers
            document.querySelectorAll('.district-marker').forEach(el => el.style.opacity = '0');
            
            // Show specific zone overlay
            document.querySelectorAll('.zone-poly').forEach(el => el.style.display = 'none');
            const zone = document.getElementById(`zone-${cityName.toLowerCase()}`);
            if(zone) zone.style.display = 'block';

            // Zoom
            map.style.transformOrigin = `${leftPerc}% ${topPerc}%`;
            map.style.transform = "scale(5)"; // High zoom
            
            // Auto filter shop
            setTimeout(() => {
                showSection('shop');
                // Filter products
                filterProducts(cityName);
                // Update filter UI
                const btns = document.querySelectorAll('.filter-btn');
                for(let btn of btns) {
                    if(btn.innerText === cityName.toUpperCase()) {
                        btn.click();
                        break;
                    }
                }
            }, 1500);
        }

        function resetMap() {
            document.getElementById('map-img').style.transform = "scale(1)";
            document.querySelectorAll('.district-marker').forEach(el => el.style.opacity = '1');
            document.querySelectorAll('.zone-poly').forEach(el => el.style.display = 'none');
        }


        // --- Basket Logic ---
        let basket = [];
        
        function addToBasket(id, name, price) {
            basket.push({id, name, price});
            updateBasketUI();
            charSystem.show('cj', 'NICE CHOICE!');
            // Flash nav item
            const nav = document.getElementById('nav-basket');
            nav.style.color = '#fff';
            setTimeout(() => nav.style.color = '', 200);
        }
        
        function updateBasketUI() {
            document.getElementById('basket-count').innerText = basket.length;
        }
        
        function openBasket() {
            const modal = document.getElementById('basket-modal');
            const list = document.getElementById('basket-items');
            const totalEl = document.getElementById('basket-total');
            
            list.innerHTML = '';
            let total = 0;
            
            basket.forEach((item, index) => {
                total += item.price;
                const row = document.createElement('div');
                row.style.cssText = "display:flex; justify-content:space-between; align-items:center; background:rgba(255,255,255,0.1); padding:10px; border:1px solid #555;";
                row.innerHTML = `
                    <div>${item.name}</div>
                    <div style="display:flex; gap:10px; align-items:center;">
                        <div style="color:var(--gta-green);">$${item.price.toFixed(2)}</div>
                        <button style="background:#900; border:none; color:#fff; cursor:pointer; padding:2px 5px;" onclick="removeFromBasket(${index})">X</button>
                    </div>
                `;
                list.appendChild(row);
            });
            
            totalEl.innerText = `$${total.toFixed(2)}`;
            modal.style.display = 'flex';
        }
        
        function closeBasket() {
            document.getElementById('basket-modal').style.display = 'none';
        }
        
        function removeFromBasket(index) {
            basket.splice(index, 1);
            openBasket(); // Re-render
            updateBasketUI();
        }
        
        function buyNow(id, name, price) {
            addToBasket(id, name, price);
            openBasket();
        }

        // --- Checkout & Payment ---
        let activePaymentId = null;
        let pollInterval = null;

        function copyText(elementId) {
            const el = document.getElementById(elementId);
            const text = el.innerText.replace(' SOL', '');
            navigator.clipboard.writeText(text).then(() => {
                const original = el.style.color;
                el.style.color = '#fff';
                setTimeout(() => el.style.color = original, 200);
                tg.showAlert("COPIED TO CLIPBOARD");
            });
        }

        async function initCheckout() {
            if(basket.length === 0) return;
            
            // Find the checkout button (last button in basket modal)
            const btn = document.querySelector('#basket-modal .btn-buy:last-of-type');
            const originalText = btn ? btn.innerText : "CHECKOUT";
            if(btn) {
                btn.innerText = "CONNECTING...";
                btn.disabled = true;
            }
            
            try {
                const user = tg.initDataUnsafe?.user;
                const userId = user ? user.id : 0; 
                
                const response = await fetch('/webapp/api/create_invoice', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ user_id: userId, items: basket })
                });
                
                const data = await response.json();
                
                if(data.success) {
                    document.getElementById('basket-modal').style.display = 'none';
                    const invModal = document.getElementById('invoice-modal');
                    
                    document.getElementById('invoice-amount').innerText = `${data.pay_amount} SOL`;
                    document.getElementById('invoice-address').innerText = data.pay_address;
                    
                    // Generate QR
                    const qrContainer = document.getElementById('qrcode');
                    qrContainer.innerHTML = "";
                    new QRCode(qrContainer, {
                        text: data.pay_address,
                        width: 150,
                        height: 150,
                        colorDark : "#000000",
                        colorLight : "#ffffff",
                        correctLevel : QRCode.CorrectLevel.L
                    });
                    
                    invModal.style.display = 'flex';
                    activePaymentId = data.payment_id;
                    
                    // Start Polling
                    if(pollInterval) clearInterval(pollInterval);
                    pollInterval = setInterval(() => pollPayment(data.payment_id), 3000);
                } else {
                    tg.showAlert("Error: " + (data.error || "Unknown"));
                }
            } catch(e) {
                tg.showAlert("Network Error: " + e.message);
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }
        
        async function pollPayment(paymentId) {
            try {
                const response = await fetch(`/webapp/api/check_payment/${paymentId}`);
                const data = await response.json();
                
                if(data.status === 'paid') {
                    clearInterval(pollInterval);
                    onPaymentSuccess();
                } else if (data.status === 'expired' || data.status === 'refunded') {
                    clearInterval(pollInterval);
                    closeInvoice();
                    triggerWasted(); // WASTED!
                }
            } catch(e) {
                console.log("Poll error", e);
            }
        }
        
        function closeInvoice() {
            document.getElementById('invoice-modal').style.display = 'none';
            if(pollInterval) clearInterval(pollInterval);
        }
        
        function onPaymentSuccess() {
            closeInvoice();
            basket = []; // Clear basket
            updateBasketUI();
            sfx.cash(); // Cash Sound!
            charSystem.show('smoke', 'RESPECT +');
            
            // Play Mission Passed Logic
            const overlay = document.getElementById('mp-overlay');
            overlay.style.display = 'flex';
            // Force reflow
            void overlay.offsetWidth;
            overlay.classList.add('mp-active');
            
            // Show Review after 4 seconds
            setTimeout(() => {
                document.getElementById('review-modal').style.display = 'flex';
            }, 4000);
        }

        // --- Review Logic ---
        let currentRating = 5;
        function setReview(n) {
            currentRating = n;
            const stars = document.querySelectorAll('#review-stars span');
            stars.forEach((s, i) => {
                s.style.color = i < n ? '#fff' : '#333';
                s.style.textShadow = i < n ? '0 0 5px #fff' : 'none';
            });
        }
        // Init stars
        setReview(5); 
        
        function submitReview() {
            const text = document.getElementById('review-text').value;
            tg.sendData(`REVIEW:${currentRating}:${text}`);
        }
        
        function closeApp() {
            tg.close();
        }

        // Skins
        function changeSkin(skin) {
            const img = document.getElementById('char-img');
            if(skin === 'cj') img.src = "https://static.wikia.nocookie.net/gtawiki/images/c/ce/Carl_Johnson.png";
            if(skin === 'ryder') img.src = "https://static.wikia.nocookie.net/gtawiki/images/6/67/Ryder-GTASA.png";
            if(skin === 'sweet') img.src = "https://static.wikia.nocookie.net/gtawiki/images/1/1b/Sweet-GTASA.png";
        }

        // Navigation
        function showSection(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(`nav-${id}`).classList.add('active');
        }
        
        function getProductEmoji(type) {
            if(!type) return 'ðŸ“¦';
            const t = type.toLowerCase();
            if(t.includes('weed') || t.includes('cannabis')) return 'ðŸŒ¿';
            if(t.includes('pill') || t.includes('xtc')) return 'ðŸ’Š';
            if(t.includes('powder') || t.includes('coke')) return 'ðŸš';
            return 'ðŸ“¦';
        }

        // Init
        loadProducts();
    </script>
</body>
</html>